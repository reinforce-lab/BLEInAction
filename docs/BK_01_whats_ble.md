
Bluetooth Low Energy のネットワーク・トポロジーには、セントラルとペリフェラルという2つの役割があります。前節で例に上げたテレビのリモコンの場合は、テレビがセントラル、リモコンがペリフェラルです。iOS6では、iOSアプリケーションはセントラルにも、ペリフェラルにもなれます。つまり、iOSアプリケーション自体が、テレビのリモコンとして振る舞うことができます。





### アクセサリとiOSアプリケーションの連携

アクセサリとiOSアプリケーションの連携には、その間をつなぐオペレティング・システムが、連携に必要な機能を提供していなければなりません。クラシックBluetoothと異なり、Bluetooth LEを使うiOSアプリケーションは、MFiプログラムがなくても一般開発者プログラムだけで、開発とAppStoreの承認がでるようになりました。それだけではなく、Apple社は、連携に不可欠の機能を提供しています:

* デバイスの発見と接続
* アプリケーションがドライバ相当の機能をもつ
* セントラルとペリフェラルの両方になれる
* ユーザ通知機能
* バックグラウンド動作

#### デバイスの発見と接続

Bluetooth LEデバイスの発見と接続は、iOSアプリケーションの役割です。iOSは、接続などに、何も関与しません。クラシックBluetoothは、ペアリングおよびデバイスへの接続は、設定アプリでユーザが操作しなければなりませんでした。どのようなBluetooth LEデバイスがあるか、どのデバイスに接続するか、また切断した時の再接続処理などは、iOSアプリケーションの役割です。例えば、Bluetooth LEは、接続が切れたならば、切れたままにする通信規格です。もしも再接続が必要になる都度、ユーザに接続操作を要求していたら、ユーザはいらいらするでしょう。

#### アプリケーションがドライバ相当の機能をもつ

Bluetooth LEデバイスとの接続はiOSアプリケーションに任されているため、パソコンのデバイス・ドライバに相当するソフトウェア、接続したデバイスの動作を制御する機能も、iOSアプリケーションに実装することになります。パソコンのように、iOSにドライバ・ソフトウェアをインストールすることは、不可能です。もしもそんなことを許せば、セキュリティや安定動作などの、iOSが提供する価値が損なわれるでしょう。

たいていの場合、iOSアプリケーション開発者がドライバ相当の機能を実装することはありません。市販されているBluetooth LEデバイスは、たいてい製造開発会社からiOSアプリケーション開発者に、そのデバイスを使うためのソフトウェア開発キットが提供されています。そのデバイスに対応するiOSアプリケーションの数が、売上につながるからです。

また独自仕様のBluetooth LEデバイスを開発する場合は、iOSアプリケーション開発者ではなく、デバイス開発者がドライバ部分を担当します。これは、デバイスの正常動作を確認するために、ドライバ部分も含めて作ることが、必要だからです。

#### セントラルとペリフェラルの両方になれる

Bluetooth LEのネットワークは、1つのセントラルに複数のペリフェラルが接続する、1対N接続のスター型です。1つのiPhoneに複数の周辺機器が接続するため、iPhoneをセントラル、周辺機器をペリフェラルにします。

iOS5は、セントラルの機能を提供しています。iOS6は、セントラルに加えてペリフェラルの機能も提供されます。iPhoneがペリフェラルになると、例えばBluetooth LEのワイヤレス・マウスとして振る舞うようiOSアプリケーションが作れますから、iOSアプリからパソコン操作もできるでしょう。

iPhoneがペリフェラルになると、Bluetooth LEデバイスのプロトタイピングが容易になります。iOS5の時代は、ペリフェラルになる組み込み機器向けのBluetooth LEデバイスの開発セットを使うほかありませんでした。このために、組み込み機器の開発手順の学習が必要でした。さらに、たいていのプロトタイピングは加速度センサを必要としますが、その回路も作らねばなりませんでした。iOS6では、これがiOSアプリケーション開発のスキルで、iPhoneの豊富なセンサがそのまま利用できるようになりました。

#### ユーザ通知機能

iOSはBluetooth LEの通信には関与しません。しかし、iOSアプリケーションがアクセサリに接続したままで終了すると、そのアクセサリとiPhoneとの接続は維持されます。このときに、アクセサリがiOSアプリケーションに通知を送信すると、それを受信すべきiOSアプリケーションが停止しているので、その通知があったことが通知センターに表示されます。<TBD 確認。ほんとうか？>

アプセサリは、アプリケーションと強く結びつきます。しかし、iOSアプリケーションは、メモリ不足により強制終了されるなど、常に実行されているとは保証ができません。このユーザ通知表示は、iOSアプリケーションが実行されていないときでも、最低限の機能の提供に使えます。

例えば、置き忘れ防止のキーホルダーに使えます。キーホルダーは、通信の電波強度が弱くなればiPhoneとの距離があいたとして、置き忘れの警告をiPhoneに送信します。対応するiOSアプリケーションが起動していれば、適切な音や表示が出せますが、iOSアプリケーションが動いていなくても、最低限の通知はできます。

この通知は補助的なもので、必ず動作するものではありません。もしも、アクセサリとiPhoneの接続が切断すれば、iOSは再接続をしませんから、切断したままになります。そして、アクセサリとの接続が切断しても、ユーザには何も通知されませんから、ユーザが切断に気づくことはありません。もしも、ユーザが必ず通知が来るものだと思っていると、この振る舞いはユーザには見えませんから、期待と異なる商品と受け取られます。

#### バックグラウンド動作

iOS4から、音楽再生やVoIPなど分野を限定して、アプリケーションのバックグラウンド・モードが導入されました。iOS5では、Bluetooth LEのセントラルとしてのバックグラウンド・モードが、iOS6では、それに加えてペリフェラルでのバックグラウンド・モードが、追加されました。

iOSアプリケーションのバックグラウンド動作は、アプリケーションが自分で好きなだけ処理をおこなうものでは、ありません。Bluetooth LEのバックグラウンド動作では、Bluetooth LEの発見や通知などのイベントが発生するたびに、iOSアプリケーションに10秒間の処理時間が与えられます。<TBD ペリフェラルでのBG動作＞

このバックグラウンド・モードを使い、例えばBluetooth LEデバイスとの通信が切断したときに、前節の通知と異なり、iOSアプリケーションから再接続処理を行うことも、またユーザに切断を通知することもできます。

### iPhoneはハブ・デバイス

アクセサリは、安価で小さいことが求められます。コストと大きさは、電池容量や液晶などの表示器を、小さいものに制約します。アプセサリはiPhoneの機能:

* iOSアプリケーションの表示やユーザ・インタフェース
* 計算処理能力や記憶媒体、データの統合
* 3Gを含めたネットワーク接続

を、アクセサリの機能として利用します。

iPhoneの液晶とユーザインタフェースが利用できると、アクセサリの表現力がぐっと広がります。アクセサリは、たいてい本体が小さいので、液晶表示器自体の大きさも小さくなります。操作手段も、本体が小さいと、小さな押ボタンを2~3個搭載するのが、精一杯です。本体の製造価格を抑えると、まず液晶が決まった数字やキャラクタを表示する簡素なものになります。ドット表示で任意の文字と図形とを表示するには、高精度のドットマトリクス方式の表示器が必要です。このように、アクセサリは本体の大きさと製造費用の2点でユーザ・インタフェースが制約されます。

例えば、ありきたりの万歩計がiPhoneのユーザ・インタフェースを使えるようになったとします。アクセサリ単体ではその日の歩数の表示だけです。最近のマイクロコントローラの処理能力であれば、万歩計が1時間あたりの歩数を記録することは容易に実現できます。ですが、万歩計自体の小さな液晶では、それを魅力的に表示できません。iPhoneの液晶表示であれば、iOSアプリケーションの実装次第で、例えば、その日の1時間あたりの歩数を、運動の強度にあわせたカラーバーでグラフ表示など、アクセサリ単体ではできない表示が、追加コストをかけずに容易に得られます。

iPhoneの記憶媒体は大容量で、端末にデータを貯めていけます。先ほどの万歩計を例に取れば、iPhoneはギガバイト単位の記憶容量があります。ですから、何百年分でも、過去の履歴データを保存できます。そして、アクセサリが壊れたり失われたりすると、そこに記録されたデータも失います。アクセサリは消耗品ですから、長期間の過去データを置いてもデータを失うようでは、意味がありません。

iPhoneは、すべてのアクセサリのデータが集積する、ハブとして機能します。また、その強力な計算処理能力で、集積したデータを統合して解析もできます。例えば、体重管理が目的のとき、万歩計以外にも心拍センサや体重計など複数のBluetooth LEデバイスで、計測をしていたとします。歩数データに心拍データを加えることで、消費カロリーをより高精度に計算できるでしょう。また体重計のデータを統合することで、運動の成果と食事内容の提案を、iPhoneから出せるようになります。

iPhoneは、集積したデータをネットワークに同期させるハブとして機能します。例えば、あるiPhoneが読みだした万歩計のデータは、Apple社のiCloudなどを使えば、iPadなどの他の自分の端末とネットワーク同期します。また、ネットワークを通じてサーバにデータを保存できます。

また、iOSアプリケーションがソーシャル・ネットワーク・サービスと連携すれば、例えば万歩計ならば毎日の運動量を仲間と共有したり競争ができます。このソーシャル・ネットワークは、サービスの魅力であり、かつ、買い替え時に他社への乗り換えの抑止にもなります。Bluetooth LEアクセサリ単体のハードウェアは単純で、設計製造を請け負う企業と通じて、参入が容易です。ですから類似製品がいろいろ出てきます。ですが、アプリケーションを通して、ソーシャル・ネットワークのつながりが形成されていれば、仲間が一斉に他社製品に乗り換えでもしない限り、次も同じ会社の製品を購入するでしょう。

### iPhoneを拡張するアプセサリ

iPhoneは加速度をはじめとする多くのセンサを内蔵していて、万能です。しかしiPhone自体の大きさや頻繁に充電が必要なことがそぐわない用途も、あります。iPhoneから見てアプセサリは:

* 機能の一部切り出しや小型化
* iPhoneにない機能を拡張

します。

アクセサリは何かの検出をするものがほとんどです。たとえiPhoneが持っているセンサであっても、アクセサリとしてそれを切り話すことで、小型化や電池交換頻度の低減、また破損するかもしれない場面でも安心して使えるようになります。

例えば、万歩計ではどうしょううか。iPhone自体にも加速度センサがあります。ですから、iOSアプリケーションで万歩計は作れます。しかしそれでは、ユーザは計測のためにiPhoneを絶えず持ち歩いていなければなりません。また、カバンに入れられたりして、歩数の計測データが取れない状態になるかもしれません。

万歩計単体をアクセサリにすれば、安価で親指の先程度の小型なものになります。たいてい1台だけを持っているiPhoneの場合と違い、いくつも購入しておいて、それぞれのズボンのポケットに入れておく使い方ができます。万歩計単体ならば、コイン型電池で半年程度動作しますから、入れたままにしておけますし、電池残量が少なくなっても、Bluetooth LEで通信をしてiPhoneからユーザに交換をうながすこともできます。iPhoneの機能の一部を、アクセサリとして切り離すことで、アクセサリの存在を忘れてしまえる使い方ができるようになります。

また自転車などのフィットネス分野では、iPhoneを自転車に固定して利用する場合、衝撃による破損や直射日光による温度上昇で動作が停止するかもしれません。このような過酷な状況では、利用場面に合わせて設計したアクセサリを利用することで、破損でiPhone自体を壊す恐れがなくなり、またアクセサリならば破損しても買い換えも容易です。

またiPhoneに搭載されていないセンサや通信機能を、アクセサリで拡張できます。例えば、糖尿病などで日常的に血糖値を測定しなければならない方のために、血糖値測定器があります。血糖値センサをBluetooth LEでiOSアプリケーションとつなぐことで、iPhoneを血糖値測定装置に拡張できます。






