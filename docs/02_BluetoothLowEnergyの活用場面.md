# Bluetooth Low Energy の活用場面
## iOSデバイスとアプセサリ

Bluetooth無線技術は、キーボードやマウスあるいはヘッドセットなど、それまで有線接続だった周辺機器を無線接続にする技術として広く普及しています。Bluetooth low energyは、それらの従来の周辺機器にも使われていますが、これまでになかったユニークで多種多様な周辺機器を生み出してきています。

この新しい体験は、Bluetooth Smart機器と、スマートフォンのアプリケーション、そしてネットワーク・サービスの3つの連携から生み出されます。これまでの周辺機器にはなかった、この新しい概念は、アプリケーション(Application)とアクセサリ(Accessory)を組み合わせたアプセサリ(Appcessory = App + cessory) という造語で表現されます。

このアプセサリの市場は、2011年からiOSとiOSデバイスがBluetooth low energyを一般アプリケーション開発者に開発環境を解放したことで生み出されています。iOS7およびiOS8でのBluetooth low energyの活用をふりかえることで、アプセサリとは何かを見ていきます。

### クラシックBluetoothでのiOSの周辺機器開発

iOSではクラシックBluetoothでの周辺機器は、キーボードやヘッドセットなどの一般的な周辺機器か、特定のiOSアプリケーションとだけ通信できる専用周辺機器かの、いずれかのみが開発できます。

Bluetooth無線技術は、無線通信と機器の振る舞いとを組にして、無線通信とデータ表現などを組み合わせた、利用場面に最適化した技術を提供しています。

例えば、ヘッドフォンの機能は、iOSデバイスと接続して音を再生することです。ですが、説明書を見ると、電話などの通話や高音質の音楽再生など、いくつものプロファイルに対応していることがわかります。音を再生するといっても、会話に使われる通話には音質はほどほどでよいが低遅延であることが、音楽再生は遅延時間はほどほどでもよいが高音質であることなど、要求が異なります。

Bluetooth無線技術は、通信と振る舞いとを組み合わせて、プロファイルという機器ごとに適した技術仕様にまとめることで、利用場面の要求に応えられる技術となりました。またBluetooth SIGがプロファイルの認証制度を提供することで、周辺機器は周辺機器として製造販売に専念でき、またスマートフォンやパソコンなどは、個別の機器との相性問題を心配する必要がなくなります。

iOSでは、パソコンでいうデバイス・ドライバに相当する部分をiOSが提供することで、プロファイルに対応しています。iOSは入力装置という抽象化された形でアプリケーションに機能を提供します。したがってアプリケーションは、ヘッドセットが有線接続か無線接続かを気にする必要はありません。またキーボードがタッチ画面であっても無線接続であっても、日本語入力変換などの快適なキー入力体験が得られます。

このプロファイルは、広く使われる一般的な周辺機器にはとても有効な仕組みです。ですが、例えばある会社がBluetooth無線技術を使い自社からユニークな自社製品を開発製造しようとすると、この仕組みは使えません。プロファイルの定義とBluetooth無線規格への盛り込みは大変な手間と費用がかかります。また、プロファイルを作ると、どの会社からも同じ振る舞いをする製品を開発販売できるのですから、自社の製品という強みが失われます。

かつてUSBが登場する以前は、パソコンの周辺機器による拡張には、シリアル・ポートというシリアル通信端子が使われていました。Bluetooth無線技術には、そのシリアル・ポートに相当する任意のバイナリ通信を提供する シリアル・ポート・プロファイル ( Serial Port Profile, SPP ) があります。カスタム製品は、このシリアル・ポート・プロファイル を使って開発されます。

ですが、iOSはシリアル・ポート・プロファイルをサポートしません。クラシックBluetoothを使うiOS周辺機器開発は、Apple社と Made for iPhone(MFi)プログラム と呼ばれる秘密保持契約を締結して初めて提供される開発キットを使って開発します。どのような通信をおこなっているのかなど技術詳細は、秘密保持契約のもとにあるので、一般にはその詳細を知ることはできません。

MFiプログラムをうけて開発製造したカスタム機器は、その機器と対応するiOSアプリケーションと接続できます。他の任意のアプリケーションからは、その周辺機器を使うことはできません。

### Bluetooth low energyとiOSと連携するアクセサリ

Bluetooth low energyは、キーボードのような従来からある周辺機器およびカスタム機器が開発できます。また、iOSはビーコンやHomeKitあるいはハンドオフなどの独自サービスの基盤技術として活用しています。

Bluetooth low energyのプロファイルは、GATTベースのアーキテクチャ(GATT-based architecture)と呼ばれ、ジェネリック・アトリビュート・プロファイル(GATT)を使って作られます。GATTベースプロファイルには、Bluetooth SIGによる採択済みプロファイルと、開発製造者が任意に定義するカスタム・プロファイルがあります。

採択済みプロファイルとカスタム・プロファイル、いずれもGATTベースのプロファイルであることに違いはなく、その違いはプロファイルがBluetooth SIGにより採択されているか、されていないかです。Bluetooth Smart機器Bluetooth SIGの認証をうけてはじめて製品登録ができます。採択済みプロファイルを採用している製品は、採択プロファイルまでが、カスタム・プロファイルの製品ではジェネリック・アトリビュート・プロファイルまでが認証の対象になります。

MFiプログラムを締結していない一般開発者に開放されたCoreBluetoothフレームワークは、ジェネリック・アトリビュート・プロファイルへのアクセスを提供します。ですから採択済みプロファイルでもカスタム・プロファイルであっても、どちらもアプリケーションから直接利用できます。またOS X Lion (10.7)からCoreBluetoothフレームワークがサポートされています。したがって、iOS向けに開発したBluetooth Smart機器のライブラリはそのまま OS Xで利用できます。

パソコンでは、アプリケーションはデバイス・ドライバを通じて周辺機器を使います。デバイス・ドライバは特定の周辺機器の機能と、オペレティング・システムが定義する一般化された周辺機器の仕様との橋渡しをします。これは、プリンタのような一般的な周辺機器を、どのアプリケーションからも抽象化された周辺機器が利用できる優れた方法です。

Bluetooth Smart機器でも、キーボードのような一般的な周辺機器は、iOSが対応します。またiOSが対応しているプロファイルには、一般アプリケーションからアクセスできません。例えば、キーボードは、iOSの日本語変換などの入力機能があって初めて使える周辺機器です。もしもジェネリック・アトリビュート・プロファイルを通じて一般アプリケーションがキー情報を直接取得できても、あまり使い道はありません。このような一般的な周辺機器は、クラシックBluetoothでそうであったのと同じように、OSがサポートすべき機器です。

Bluetooth low energyは、特に早くからフィットネス分野の心拍計や体重計に使われています。iOS標準アプリの1つ HealthKit は、健康に関するいくつものプロファイルに対応しています。HealthKitが取得蓄積したデータは、iOSアプリケーションからHealthKitフレームワークを通じて取得できます。HealthKitそれ自体はアプリケーションですが、ちょうどパソコンでいうデバイス・ドライバとデータ蓄積の機能を、他のアプリケーションに提供しているといえます。

アプセサリと呼ばれるカスタム・プロファイルのBluetooth Smart機器は、独自プロファイルで、自社のアプリケーションとの連携で初めて価値が出るように作られます。ですから、アプセサリでは、パソコンのように周辺機器を一般化したり抽象化する必要がありません。また、iOSではユーザがインストールできるものはアプリケーションだけです。ですから、アプリケーションがデバイス・ドライバに相当する部分までを含みます。

クラシックBluetoothの周辺機器は、有線接続で機器のケーブルを接続していたのと同じように、ユーザが設定画面から機器に接続して利用します。しかしアプセサリでは、ユーザが機器にいちいち接続するのでは不便になります。iOSは、アプリケーションが直接Bluetooth Smart機器に接続できます。

iOSアプリケーションには、画面に表示されてユーザが操作しているフォアグラウンド状態と、画面に表示されていないバックグラウンド状態があります。もしも
iOSアプリケーションがフォアグラウンド状態でしかBluetooth Smart機器と通信ができないようだと、ユーザは常にiOSアプリケーションを起動してBluetooth Smart機器を操作する、リモコン・アプリケーションしか作れません。

iOSには、アプリケーションが画面に表示されていない状態でも、Bluetooth Smarto機器に反応できる強力な仕組みがあります。Bluetooth Smart機器との通信が断絶したり、接続できる範囲にはいったり、また接続している機器からデータが送られてきたときに、もしもiOSアプリケーションが終了していれば、iOSがアプリケーションを起動して、Bluetooth Smart機器とのやりとりの処理を継続させます。

この強力なバックグラウンドでの機能が、アプセサリと呼ばれる利用場面を実現可能にしています。ユーザは意識していなくても、Bluetooth Smart機器とアプリケーションがいつのまにか同期している自然な体験が作られます。

### Apple社独自の周辺機器仕様

iOSはBluetooth low energyを一般開発者に開放しただけではなく、iOSの様々な機能の技術基盤としても活用しています。さらに、Apple社は、独自の周辺機器仕様を公開して、Apple IDおよびiCloudと連携する機器開発の機会を提供しています。

iOS独自の周辺機器の仕様には、Apple Notification Center Service (ANCS) と Apple Bluetooth Low Energy MIDI の2つが一般に公開されています [^1410]。この2つの仕様はMFiプログラムの対象ではありません。またApple社独自のゲーム専用コントローラの仕様があります。これはMFiプログラムの対象です。このコントローラは、ゲーム開発の機能を提供するGameKitフレームワークを通じて利用できます。

メールやソーシャルメディアの通知を知らせるBluetooth Smart機器は、スマートフォン連携での定番といっていい機器です。ANCSは、iOSの通知画面に表示される情報をBluetooth low energyを通じて周辺機器に伝える仕様です。

様々なアプリケーションからユーザに通知される通知画面の情報は、おそらくユーザのプライバシーの保護のために、iOSアプリケーションからは読み取れません。ですから、もしもiOSアプリケーションで通知機能を実現しようとすると、アプリケーション自体に様々なメールやソーシャルメディアの通知取得機能を実装しなくてはなりません。ANCSを通じて、Bluetooth Smart機器は通知情報をiOSから直接取得できます。

Apple Bluetooth Low Energy MIDI は、電子楽器の演奏データを機器間でデジタル転送するための規格 MIDI（Musical Instrument Digital Interface、ミディ）をBluetooth low energyでやりとりするApple社の独自仕様です。楽器の音がずれてはならないので、この仕様はデータ形式だけではなく、低レイテンシにするための通信パラメータまでを規定しています。

この仕様に準じるBluetooth Smart機器は、CoreBluetoothフレームワークではなく、音を扱うためのCoreAudioKitフレームワークを通じて、アプリケーションから楽器として利用ができます[^1410]。

Technical QA1831 Adding Bluetooth LE MIDI Support
[^1410]:[](https://developer.apple.com/library/ios/qa/qa1831/_index.html)

### Bluetooth low energyとビーコン

iBeacon [^1410] は、iOS7で導入された新しい位置と近接の検出技術です。Bluetooth low energyのアドバタイジング・パケットをブロードキャストするビーコンと、iOSの常時ビーコン検出の機能を組み合わせて使います。屋内の経路案内や博物館の展示案内あるいは紛失物の探索などに利用できます。

[^1410]:[https://developer.apple.com/ibeacon/](https://developer.apple.com/ibeacon/)

ビーコン検出機能は、位置情報を提供する CoreLocationフレームワークを通じて一般開発者に提供されています。開発者は Bluetooth low energy を意識することなくiBeaconを利用できます。

iOSは強力なビーコン検出を提供します。iOSデバイスが再起動してもビーコン監視は継続します。さらに、ビーコンを検出した時にアプリケーションが終了状態であれば、iOSがアプリケーションを起動して検出イベントをアプリケーションに通知します。

ビーコンは、CoreLocationフレームワークとCoreBluetoothフレームワークを使いiOSアプリケーションを使ってiOSデバイスをビーコンにするか、またはiBeaconのハードウェア仕様にしたがって製造したビーコンを利用します。このiBeaconのビーコン技術仕様はMFiプログラムの対象です。

Bluetooth low energyのアドバタイジング・パケットは、どの程度の周期で送出されるかが事前にわからないので、通常は、アドバタイジング・パケットを検出する間は、2.4GHzの高周波受信回路を動かし続けます。ですから、単純にアドバタイジング・パケットを利用するビーコンを24時間監視すると、消費電力が無視できない大きさになります。

iBeaconは、ビーコンのアドバタイジング・インターバルを規定します。そしてiOSは、その技術仕様を前提にして、iOSデバイスのハードウェアとソフトウェアとを最適化して、消費電力を小さくしています。このビーコンとiOSとの統合された最適化ではじめて、ビーコンの常時検出が実現されています。

ビーコンは、任意に設定できる128ビットの識別子(UUID)と2つの16ビット値を送出できます。iOSアプリケーションは、検出対象のビーコンのUUIDを必ず指定しなければならないので、周囲にある任意のビーコンを検出することはできません。ですから、誰かが設置したビーコンの識別情報を盗みだすスニッフィングなどの悪用はできないようになっています。

iBeaconは、iOS標準アプリのPassbook [^1420] が利用しています。ビーコンがあるとロック画面にパスが表示されます。

[^1420]:[Passbook for Developers, https://developer.apple.com/passbook/](https://developer.apple.com/passbook/)

### HomeKitとBluetooth low energy

HomeKit [^1430] は、照明機器や電子錠などの身の回りにある機器とiOSデバイスとを、 Bluetooth low energy または Wi-Fi で連携させる技術です。HomeKitは、Siriを通じて自然な音声コマンドで機器が操作できるという、映画では見慣れた誰もが理解しているアプリケーションを提供しています。

[^1430]:[https://developer.apple.com/homekit/](https://developer.apple.com/homekit/)

機器が連携さえしていれば、サービス提供者やアプリケーション開発者が工夫して、多種多様なアプリケーションが新たな便利さや利用シーンを作り出されていきます。しかし、アプリケーションが登場するには、機器が連携してからしばらく時間がかかります。音声コマンドによる操作は、今はまだないサード・パーティのアプリケーションがなくとも、HomeKitを特徴づけるアプリケーションとなっています。

HomeKit は、機器開発のためのHomeKit対応機器の通信仕様と、iOSアプリケーション開発のための機器の登録や操作を提供する HomeKitフレームワークの2つで構成されます。HomeKit対応機器の開発は、MFiプログラムの対象です。HomeKitフレームワークは、一般開発者に開放されています。

電化製品を遠隔操作する技術は、古くから使われてきた技術です。例えば、1975年に開発された屋内電力配線で制御信号を送る技術X10は、電灯の遠隔操作パネルなどに欧米で広く使われています。X10のように専用制御装置を使うならば、すべての機器が屋内電力配線につながりますが、HomeKitではユーザはiOSデバイスを通じて機器とつながります。そのため、HomeKitは無線通信を使います。

電波は四方八方に広がるものなので、電化製品の無線化ではセキュリティの確保とプライバシーの保護が重要な課題になります。Bluetooth low energy にも、もちろんそれらの技術が盛り込まれていまが、HomeKitはそれらの技術は使っていません。HomeKitは、Bluetooth low energyを単にデータをやりとりするだけの無線通信として利用しています。セキュリティやプライバシーは、Apple社独自仕様で守られます。

### iOSと Bluetooth low energy の今後

iOSの Bluetooth low energy との関わりとその活用を見てきました。多種多様なものを無線接続にできる Bluetooth low energy は、モバイル機器を中心にした情報とものとの関わりを作る重要な技術となってきています。

現在のアプセサリは、ちょうどAppStoreが登場してアプリケーションの販売とアプリケーション内課金という収益が得られる場が生まれたことで、短期間に数多くのiOSアプリケーションが登場した様子に似ています。

アプセサリでは、フィットネスや健康維持の分野で急成長する会社が登場しています。iOSアプリケーションを通じて提供されるサービスを生み出し初期の競争を生き残った企業が、今の成熟したモバイル市場で大きな売上を生み出しているように、アプセサリも規模の拡大と成熟を迎えていくでしょう。

これまでのアプセサリは、iOSデバイスと周辺機器が、電波が届く範囲で1対1に接続するものです。ですがiBeaconやHomeKitなどはそうではありません。

iBeaconは、新しい近接と位置の検出技術ですが、それだけではなくブロードキャストによる接続しない場面に広く応用できます。例えば、コーヒーサーバーの備品補給が必要なときに、ビーコンでそれを知らせる利用方法があります。フィットネス機器と違い、コーヒーサーバーのように、iOSデバイスと常に無線接続させたいわけではない機器でも、ブロードキャストを利用すれば、まれに機器から通知したい情報をユーザに届けることができます。

HomeKitは、電化製品を無線接続する技術ですが、iPhoneやiPadなど数多くのiOSデバイスをシームレスに利用している現在のユーザからみれば、それらのデバイスと同じように、電化製品をiCloudに取り込むブランドと言えます。例え Bluetooth low energy を使っていても、周囲にあるiOSデバイスが、その機器とiCloudとを連携させることで、ユーザはどこにいるかに関係なくiCloudを通じて機器を利用できるでしょう。

iOSとBluetooth low energyが、今後どのような発展を遂げるのかは、予測はできません。

Bluetooth low energyは、ハードウェアの機能と、ユーザから見た利用場面つまりプロファイルを分離するものと言えます。また、iOSのヘルスアプリのように機器からユーザ・データを分離できるものとも言えます。そして、Bluetooth low energyがある領域は常に、何かしらのハードウェアと、スマートフォン、そしてネットワーク・サービスの3つの要素があります。これらの分離と3つの要素の組み合わせとが、今までにない価値をユーザに届けることでしょう。
