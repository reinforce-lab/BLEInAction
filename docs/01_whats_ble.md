
# Bluetooth Low Energyのある世界

Bluetooth Low Energy は、コンビニエンス・ストアで売られているコイン型リチウム電池1つで、1年程度の無線通信をし続けられるほどの、超低消費電力無線通信技術です。

Bluetooth Low Energy はBluetooth3までの近接無線通信技術がカバーしきれない領域のために開発された超低消費電力無線通信技術です。例えば、心拍センサーのような1秒に数回、数バイトのデータを送信しつづける用途に適しています。Bluetooth3までの技術とBluetooth Low Energyは、異なる技術です。

本書では、Bluetooth3までの技術(Bluetooth 1.0から3.0までの技術)と Bluetooth Low Energy を区別するために、前者を クラシックBluetooth と書きます。

Bluetooth Low Energy が注目されるのは、iOS5を搭載したiPhone4sから全てのiOSデバイスが標準でサポートしているからです。世界に広く普及したiOSデバイスという接続先があるので、巨大な周辺機器市場が突然登場したのです。

新しい技術は常に万能ではありません。新しい技術は、これまにできなかったことを可能としますが、また適さない使い方もあります。企画会議やチーム・メンバー全員でのブレイン・ストーミングでは、適切なアイディアを出し議論をするために、たとえ担当分野が技術ではなくてもBluetooth Low Energy の全体像や基礎知識が不可欠です。

この章は、Bluetooth Low Energy という技術でなにができるのかの全体像と基礎知識、そして、アプリケーション開発やハードウェア開発の概要を述べます。

## Bluetooth Low Energyで何ができるか

Bluetooth Low Energy のデバイスは、iOSデバイスと組み合わせてはじめて、いろいろなことができます ( [#fig-ios-and-ble-intro] )。

![ #fig-ios-and-ble-intro iOSデバイスと周辺デバイスとの通信](fig/ch01-ios-and-ble-intro.png)

### ブロードキャストと通信

Bluetooth Low Energy の無線通信は、周囲にある不特定多数のiOSデバイスにデータを送信するブロードキャストと、特定のiOSデバイスと無線接続をしてデータの読み書きを行う通信の2つができます。

ブロードキャストは、もともと Bluetooth Low Energy デバイスが自分をiOSデバイスに発見してもらうための仕組みです。Bluetooth Low Energy デバイスは、自分の機種名や機能などの情報を周囲に送信します。近くにいるiOSデバイスは、たまたまそれを受信してデバイスが発見されます。

このブロードキャストは、デバイスの発見以外に、周囲にある不特定多数のiOSデバイスへの一方的な情報送信にも利用されます。

例えば、iOS7から搭載された iBeacon は、このブロードキャストを利用しています。iBeacon は、識別子を送信し続けるビーコンとそれを検出するiOSデバイスを組み合わせた、新しい位置と近接検出技術です。とくに、オフラインとオンラインとを滑らかにつなげた購買体験を生み出すための技術手段として、注目されています。

例えば、建物のあちこちにビーコンを設置しておけば、GPSが届かない屋内でもビーコンの電波強度から屋内位置を推定できます。屋内位置推定や、その推定情報を使った屋内地図表示また目的地へのナビゲーションに使えます。この技術を使えうと、食品スーパーの販売促進では、売り場を訪れたタイミングでユーザが嬉しいと思うクーポンを配布するなどの、アプリケーションからユーザに、その場所にあった働きかけができます。

ブロードキャストは、Bluetooth Low Energy デバイスの情報を周囲に送信するのにも使えます。例えば、気温計のデバイスであれば、センサで検出した気温をそれが周囲にブロードキャストしていれば、その電波を受信したiOSデバイスは、その場所での気温を知ることができます。

Bluetooth Low Energy のブロードキャストは、データの種類を表すヘッダとデータの配列データを送信できます。その配列の大きさは最大31バイトで、決して大きくはありませんが、先ほどのiBeaconやセンサのように広い利用場面があります。

ブロードキャストでは送りきれないバイト数や複雑なデータをやりとりするには、ブロードキャストで発見したデバイスとiOSデバイスが接続処理をしてからデータをやりとり、通信します。

例えば、心拍計測デバイスにも、計測場所が胸や手首だったり、心拍データも1分間あたりの値が取れるだけのシンプルなものから心拍間の時間まで取れるものもあります。このような多種多様なデバイスからデータを取得するのは、ブロードキャストの最大31バイトでは取得しきれません。だから、接続してデータをやりとりする通信が使われます。

まとめると:

- Bluetooth Low Energy には、ブロードキャストと接続して通信をする、2つの方式がある
- ブロードキャストは、デバイスの発見や、位置と近接検出技術や、簡単なデータ送信にも使われる
- 接続して通信することで、複雑な構造をもつデータをデバイス間でやりとりすることができる

となります。

### クラシックBluetoothでのiOS周辺デバイス

Bluetooth Low Energy はクラシックBluetoothとは異なり、規格の範疇で機器メーカ独自のプロファイル (カスタム・プロファイル) を実装することができます。だから、Bluetooth Low Energy では多種多様なデバイスを展開できます。

プロファイルとは、デバイスの振る舞いの仕様のことで、通信でやりとりするデータのフォーマットや意味、そしてデバイスがどのタイミングでどのような動作をするのかなどを含みます。

クラシックBluetooth では、周辺デバイスとそれが接続するデバイスの両方の振る舞いが、キーボードやヘッドセットのような用途ごとにプロファイルとして定義されています。

例えば、キーボードやマウスなどの入力デバイスにはヒューマン・インターフェイス・デバイス・プロファイル (HID)が、ヘッドセットなど音楽を聞くデバイスには高度オーディオ配信プロファイル(A2DP)のように、用途それぞれにプロファイルが定義されています。

クラシックBluetoothは、接続先であるiOSの振る舞いもプロファイルに含まれます。ですから、[iOS：iOS デバイス対応の Bluetooth プロファイル](http://support.apple.com/kb/HT3647?viewlocale=ja_JP) [^2010] の一覧表のように、1つ1つのプロファイルごとに規格に従っているかがチェックされています。iOSデバイスから使える周辺デバイスは、ここにあるプロファイルのものだけになります。

[^2010]: [iOS：iOS デバイス対応の Bluetooth プロファイル http://support.apple.com/kb/HT3647?viewlocale=ja_JP](http://support.apple.com/kb/HT3647?viewlocale=ja_JP)

iOSに実装されたプロファイルは、パソコンでいうデバイス・ドライバの働きをします。ですから、iOSアプリケーションは、Bluetoothか有線かの接続形式を気にせず、キーボードやヘッドセットといった単なる周辺デバイスとして扱えます。

このように、iOS自体にプロファイルが実装されているので、クラシックBluetoothでiOSアプリケーションが周辺デバイスと直接通信することはありませんし、通信できません。

もしもiOSアプリケーションからクラシックBluetoothの周辺デバイスへの直接通信を許すと、クラシックBluetoothのプロファイルの規格認証時に、そのiOSアプリケーションも含めてプロファイルに対応していることを証明しなければなりません。任意のiOSアプリケーションがインストールされるので、それは不可能です。

クラシックBluetoothで、規格にプロファイルが定義されていないオリジナルの機能を実現するために、シリアル・ポート・プロファイル(Serial Port Profile, SPP)という双方向の単なるデータ・ストリームを提供するプロファイルがあります。SPPには、データのフォーマットや意味の定義がない単なる通信で、それをどう使うかは自由です。

ですが、[iOS：iOS デバイス対応の Bluetooth プロファイル](http://support.apple.com/kb/HT3647?viewlocale=ja_JP) の一覧表にSPPはありません。

iOSアプリケーションと独自のクラシックBluetooth周辺デバイスとの通信は、[#fig-ios-and-ble-details] (a) のように実現されます。

クラシックBluetoothでiOSの周辺デバイスを開発するには、Apple社とMade for iPhone(MFi)プログラムという秘密保持契約を締結してはじめて、秘密のハードウェア開発情報の開示と開発機材の提供をうけられます。iOSは、周辺デバイスに実装したMFiプログラムで提供される認証用ハードウェアを確認して、そのデバイスが対応するiOSアプリケーションに通信をつなぎます。iOSアプリケーションは、外部機器との通信を提供するExternal Accessoryフレームワークを使って、この周辺デバイスと通信ができます。

![ #fig-ios-and-ble-details アプリケーションと周辺デバイスとの通信](fig/ch01-ios-and-ble-detail.png)

まとめると:

- クラシックBluetooth のiOS周辺デバイスの開発にはMFiが必須
- External Accessoryフレームワークを使い、周辺デバイスと1対1で対応するiOSアプリケーションを開発する

となります。

### クラシックBluetoothと Bluetooth Low Energy の違い

クラシックBluetooth と Bluetooth Low Energy とでは、技術も異なりますし、使われ方も異なります。ですが、昔から Bluetooth を知っていると、 その知識が勘違いをもたらしたり、混同してしまうことがあります。

クラシックBluetooth と Bluetooth Low Energy の違いと、Bluetooth Low Energyの特徴は:

- Bluetooth3.0までの端末は、 Bluetooth Low Energy のみに対応した周辺機器と接続できない
- リチウムコイン型電池1つで1〜2年間の無線通信ができるほど超低消費電力
- 低頻度、少量データの通信に向く
- デバイスの設計で、ペアリングがなくてもいい
- 任意の機能を任意に実装できる
- 近接検出、ブロードキャストができる

です。

<!-- 音声通信とかの向き不向きてきなところ -->

Bluetooth4.0に統合された Bluetooth Low Energy は、コンビニエンスストアでも売られているほど一般的な直径2cm程度のリチウムコイン型電池1つで、1年間程度の無線通信ができるほどの、超低消費電力無線通信技術です。

Bluetooth4.0は、Bluetooth3.0に Bluetooth Low Energy を統合したものです。Blueooth LEは、Bluetooth3.0までの技術とは異なる技術です。そのため、 Bluetooth Low Energy だけに対応した周辺機器(シングルモードと呼びます)は、Bluetooth3.0までの対応機器とは接続できません。

超低消費電力の無線通信技術には、Bluetooth Low Energy 以外にも [ZigBee](http://www.zbsigj.org) [^2110] や [ANT+](http://www.thisisant.com) [^2120] など、いくつもの超低消費電力無線通信技術がありますが、Bluetoothというブランドに統合されたこと、そしてiOS5から標準でサポートされたことで、一気に世界中に普及しました。

[^2110]: [ZigBee http://www.zbsigj.org](http://www.zbsigj.org)
[^2120]: [ANT+ http://www.thisisant.com](http://www.thisisant.com)

Bluetooth Low Energy の使い道は、たまにしか通信をしないが(低頻度)、必要があればすぐ通信ができる(通信の遅れ時間、レイテンシが小さい)、分野です。 応用分野は、例えば、テレビのリモコンのようなデバイスです。リモコンは、普段は使われることがなく、たまにボタンが押されます。ですが、ボタンが押されたら直ちにテレビが反応しなければなりません。

クラシックBluetoothでリモコンを作ると、通信の接続を保持するために、リモコンを使っていない間も電池を消費します。そのため充電し続ける必要があります。もしも電池節約のために、ボタンが押されたら通信接続する設計にすると、通信接続に数秒は時間がかかりますから、反応が悪くて使えません。

Bluetooth Low Energy デバイスには、ペアリングはありません。クラシックBluetoothデバイスは、初めてiPhoneと接続するときに、ペアリングという接続認証が必要でした。 Bluetooth Low Energy デバイスでは、接続処理にiOSが一切関与しないため、ペアリングはありません。

Bluetooth Low Energy は、任意のオリジナルの機能を実装できる規格です。クラシックBluetooth規格は、ヘッドセットなど応用ごとに振る舞いを定義していました。そのため、規格の認証に、機器の振る舞いまでが含まれました。 Bluetooth Low Energy は、Generic Attribute Profile(ジェネリック アトリビュート プロファイル、GATT)までを規格として、このうえに実装されるデバイスの機能は規格に含みません。通信と機器の振る舞いを分離することで、ユーザは任意の機能の実装ができます。

<!-- 近接検出、ブロードキャスト -->
Bluetooth Low Energy デバイスは、近接検出や少量データのブロードキャストができます。 Bluetooth Low Energy は、そのデバイスをiPhoneに発見してもらうために、アドバタイズメント・パケットを送信します。このアドバタイズメント・パケットは、周囲の端末が受信できる、ブロードキャストです。このパケットの受信信号強度から、デバイスとの距離がおおまかに算出できます。また、このパケットには、20バイト程度の<!--TBD-->任意のバイト・データを入れられます。これを屋内測位や位置ビーコンに応用できます。

### カスタム・プロファイルがもたらす柔軟さと多様性

[#fig-ios-and-ble-details] (b) が、iOSアプリケーションと Bluetooth Low Energy の周辺デバイスとの通信です。

クラシックBluetoothは、周辺デバイスの機能とその振る舞いをセットにして、プロファイルという1つの概念にしていました。Bluetooth Low Energy は、機器の振る舞いの定義をプロファイル、周辺デバイスの機能の定義をサービスと、振る舞いと機能を2つの概念に分離しています。

例えば、鍵の置き忘れを防止するためのキーホルダーには [Find Me プロファイル](https://developer.bluetooth.org/TechnologyOverview/Pages/FMP.aspx) [^2020] が使われます。これは、キーホルダーを見つけたいときに、iOSデバイスから信号を送ると、キーホルダーからピーという音や振動が出るプロファイルです。

Find Me プロファイルは[Immediate Alert サービス](https://developer.bluetooth.org/gatt/services/Pages/ServiceViewer.aspx?u=org.bluetooth.service.immediate_alert.xml) [^2030]を使います。このサービスはピーという音や振動を出すサービス、つまり周辺デバイスの機能を表します。

[^2020]: [Find Me Profile https://developer.bluetooth.org/TechnologyOverview/Pages/FMP.aspx](https://developer.bluetooth.org/TechnologyOverview/Pages/FMP.aspx)

[^2030]: [Immediate Alert Service https://developer.bluetooth.org/gatt/services/Pages/ServiceViewer.aspx?u=org.bluetooth.service.immediate_alert.xml](https://developer.bluetooth.org/gatt/services/Pages/ServiceViewer.aspx?u=org.bluetooth.service.immediate_alert.xml)

この例をみると、キーホルダーを探すときに音や振動を出すFind Me プロファイルの振る舞い部分は、iOSアプリケーションに実装されます。その振る舞いに必要な振動や音の出力機能は、Immediate Alert サービスとして周辺デバイスに実装されます。

振る舞いはiOSアプリケーションに、周辺デバイスの機能はサービスに分離されたことで、それぞれの可能性をかけあわせることで、多様性が生まれます。

このImmediate Alert サービスを別の目的に使ってもかまいません。例えば、気温や湿度が高い時に熱中症の危険性をユーザに知らせるiOSアプリケーションを開発したとします。そのiOSアプリケーションがユーザにより直接働きかけるために、Immediate Alert サービスを使うこともできるのです。

Bluetooth Low Energy は、データ・ストリームを提供する技術ではありません。周辺デバイスの機能をサービスという単位でオブジェクト指向で表現するデータ構造があり、全てのデータのやり取りはそのデータ構造を通して行います。そしてそのデータ構造をどう使うかというアプリケーション層を担うプロファイルとサービスは、規格が用途ごとにしばったりせず、カスタムのプロファイルとサービスの実装が許されています。

ですから、Bluetooth Low Energyの規格認証のもとで、カスタムなプロファイルとサービスを一般販売できます。これは、SPPしかなかったクラシックBluetoothとは大きな違いです。

一方で、例えばキーボードなどの一般的な周辺デバイスは、規格として標準のサービスとプロファイルが定義されなければ周辺デバイス市場が立ち上がりません。クラシックBluetooth のプロファイルは、Bluetoohの規格開発を監督する [Bluetooth SIG](https://www.bluetooth.org) [^2040] が定義していましたが、Bluetooth Low Energyは、業界団体の企業が Bluetooth SIG に参加して、その業界でのプロファイルを取りまとめて標準化していくボトムアップ型をとっています。

 ^[2040]: [Bluetooth SIG https://www.bluetooth.org](https://www.bluetooth.org)

ですから、Bluetooth Low Energyは、カスタムなプロファイルとサービスを使い、自社のサービスでのみ使えるカスタムな周辺デバイスを販売することも、またプロファイルを標準化して、キーボードや血圧計のような一般的な周辺デバイス市場を業界として立ち上げていくことも、できるのです。

まとめると、Bluetooth Low Energyでは:

- 周辺デバイスの振る舞いはプロファイルに、機能はサービスに分離されている
- プロファイルは複数のサービスを組み合わせて実現され、プロファイルはiOSアプリケーションとして実装される
- 規格がカスタムなプロファイルとサービスの実装を許している
- Bluetooth SIGに参加してプロファイルとサービスの標準化を提案できる

となります。

### プロファイルと一般的なアクセサリ

プロトタイピングに、市販されているアクセサリを流用できると便利です。

無線で接続した装置の振る舞いを、Bluetooth LEはプロファイルと呼びます。Bluetooth LEの規格は、独自の実装を許すように作られています。自社の装置と、その装置とのみ接続するアプリケーションを開発するならば、独自に仕様を決めて実装すればよいのです。

しかし、一般的に、業界には、装置の製造会社、アプリケーション開発会社など、複数の会社があります。このような会社をまたぐ場合にアプセサリを作っていくには、どこかの会社の独自プロファイルではなく、一般化した振る舞いの定義が必要です。

Bluetooth SIGは、ある業界に関わる会社群が一般化したプロファイルを提出すれば、それをプロファイルとして承認します。この仕組みにより、特定の企業に依存しない一般化されたプロファイルのもとで、装置やアプリケーションの開発ができます。また、新たな装置のプロファイルが、今後も追加されていくでしょう。

2013年7月の時点で、Bluetooth SIGが承認しているプロファイルは、つぎの14つです。

[Profiles | Bluetooth Development Portal](http://developer.bluetooth.org/gatt/profiles/Pages/ProfilesHome.aspx)

- アラート通知 (Alert Notification)。
- 血圧計 (Blood Pressure)。
- 自転車のパワーメータ (Cycling Power)。
- 自転車の速度とペダル回転数 (Cycling Speed and Cadence)。
- デバイスの発見 (Find Me)
- 血糖値 (Glucose)
- 体温計 (Health Thermometer)
- 心拍 (Heart Rate)
- 入力装置 (HID OVER GATT)
- 位置と経路誘導 (Location and Navigation)
- 電話の警告(Phone Alert Status)
- 近接 (Proximity)
- ランナーの速度とペース (Running Speed and Cadence)
- 時刻 (Time)

これらのプロファイルの分野は、大きくフィットネスとヘルスケアそしてモバイル機器の3つに分けられます。Bluetooth LEの規格制定時から、応用を考えられていた分野で、プロファイルも、いち早く成立しています。機能は、センサと通知に分類できます。スマートフォンから腕時計などに、メールや電話着信を通知するアラート通知は、クラシックBluetoothから提供されてきた機能です。

### アプリケーション+アクセサリ=Appcessoryの登場

iOSは、Bluetooth Low Energy の多様性の鍵です。

iOSアプリケーションは、CoreBluetoothフレームワークを通じて、周辺デバイスと直接通信できます ([#fig-ios-and-ble-details] (b))。また周辺デバイスの検索、発見したデバイスへの接続そして切断もできます。iOSアプリケーションが周辺デバイスを掌握できるうえ、周辺デバイスの設計次第でペアリングも不要にできるので、ユーザに設定の手間をかけさせない体験も作れます。

なによりも CoreBluetoothフレームワーク は一般開発者に開放されました。これで、iOSアプリケーションで多種多様なプロファイルが実現できるようになり、そしてMFiプログラムを締結しなくてもiOS周辺デバイスを発売できるようになりました。

Bluetooth Low Energy のカスタム・プロファイルとサービスの柔軟さと、このiOSの方針が、多種多様のユニークな周辺デバイスとiOSアプリケーションが続々と登場するプラットフォームとなったのです。

iOSアプリケーションとBluetooth Low Energy の周辺デバイスは、とても強く結びつきます。iOSアプリケーションは、表示機能の乏しい周辺デバイスの代替表示のようなおまけではありませんし、また周辺デバイスはiOSアプリケーションのセンサなどの単なる機能拡張ではありません。

例えば、[Fitbit](http://www.fitbit.com/jp) [^2050] というサービスは、毎日の歩行数や階段の昇り降りを記録し続ける Bluetooth Low Energy の活動量計を販売しています。この活動量計は単体でも十分に魅力ある活動量計です。それがiOSアプリケーションと結びつくと、アプリケーションを通じてウェブ・ネットワークとも連携します。そして、Facebookなどのソーシャル・ネットワークで歩いた歩数を共有するなど、これまでになかったユーザ体験が提供されています。

[^2050]: [Fitbit http://www.fitbit.com/jp](http://www.fitbit.com/jp)

<!-- ここ編集すること -->
iOSアプリケーションには、 Bluetooth Low Energy 専用のバックグラウンド・モードが用意されています。バックグラウンドで、 Bluetooth Low Energy デバイスと接続して通信しつづける、あるいはデバイスを発見して接続をすることができます。

このように、Bluetooth Low Energyは、周辺デバイス(アクセサリ)とアプリケーションの2つが融合して魅力が生まれます。これ表すのが、周辺デバイスを意味するアクセサリ(accessory)と、iOSアプリケーション(application)の2つの単語を組み合わせた *Appcessory (アプセサリ)* という造語です。

まとめると、iOSとBluetooth Low Energy デバイスは:

- Bluetooth Low Energy だけをつかうデバイスは、MFiプログラムへの参加は必要ない
- 一般開発者が CoreBluetoothフレームワーク を使いアプリケーションを開発できる
- Bluetooth Low Energy のバックグラウンド・モードがある
- アプセサリという造語が作られるほど、デバイスとiOSアプリケーションは不可分

となります。

## iOSでの Bluetooth Low Energy 活用

iOS5およびiOS6では、ベンチャー企業が多種多様なアプセサリーを発表していましたが、iOSそれ自体がBluetooth Low Energyを使うことはありませんでした。iOS7からは、iOS自体が標準的なBluetooth Low Energy 周辺デバイスに対応したり、独自機能を提供しはじめています。

iOSでBluetooth Low Energyをつかって、できること、それをするためにハードウェアおよびアプリケーション開発が不要か必要かを [#table-ios-and-ble] にまとめます。

Table: #table-ios-and-ble iOSでのBluetooth Low Energy活用

番号 |したいこと                           | iOS対応 | ハードウェア | アプリケーション | MFi
:+---:+----------------------------------:+--------:+-----------:+---------------:+----
1|カスタムな周辺デバイスの販売               | iOS5    | 開発        | 開発           | 不要
2|市販の周辺デバイスを使うアプリケーション開発 | iOS5    | 市販品       | 開発           | 不要
3|iOSがサポートする周辺デバイス開発          | iOS7    | 開発        | 不要            | 不要
4|位置と近接検出                           | iOS7    | ビーコン製造 | 開発/不要       | 必要
 |                                       |         | 市販品       | アプリ         | 不要
 |                                       |         | アプリ       | アプリ         | 不要 
5|iOSの通知情報と同期する周辺デバイス開発     | iOS7    | 開発する     | 不要           | 不明
6|ユーザの健康情報の集約と参照               | iOS8    | 市販/開発    | 開発/不要      | 不要
7|iOSと連携する家電の開発                   | iOS8    | 開発        | 必要           | 必要


### iOSと連携する周辺デバイス

[#table-ios-and-ble]の1および2は、前節で述べたアプセサリーです。

カスタムな周辺デバイスを販売したいならば、ハードウェアとその対応アプリケーション開発が必要です。市販の周辺デバイスを使うアプリケーション開発、例えば心拍センサーをつかったフィットネス・アプリケーション、もできます。その場合はハードウェアは製造を委託する、あるいは市販品を利用します。

iOS7から標準的な周辺デバイスのサポートがはじまりました ([#table-ios-and-ble] 3) 。iOS7はヒューマン・インタフェース・デバイスの HID over GATT に対応したので、Bluetooth Low Energyのキーボードが使えます。iOS8は、MIDI over Bluetooth Low Energy に対応するので、音楽データのAPIで演奏データの送受信ができます。

このようなiOSがサポートする周辺デバイスは、すでにAppStoreにある文字入力や音楽に対応したアプリケーションからすぐに使えるので、独自のアプセサリと違いiOSアプリケーションを開発する必要はありません。ハードウェアの製造販売だけで事業になります。

キーボードまたは楽器インタフェースのような汎用の周辺デバイスを、独自のアプセサリとして開発しても得られるものはありません。汎用の周辺デバイスをより多く販売するためには、多くのアプリケーションが対応していなければなりません。

カスタム・プロファイルで開発してしまうと、iOSアプリケーションを自分たちで開発するか、もしくは開発キットを広く配布して対応アプリケーションを作ってもらわなければなりません。後者の場合、iOSが既に持っている標準のAPIとは別に、その周辺デバイスのための特別な文字入力や音楽データのAPIを実装する手間に見合う魅力がなければ、対応アプリケーションが広まることはないでしょう。

### 位置と近接および存在の検出

[#table-ios-and-ble]の4は、[iBeacon](https://developer.apple.com/ibeacon/) [^2060]というApple社の新しい位置と近接の検出技術の活用です。これは、Bluetooth Low Energyのデバイス発見につかうアドバタイズメントという仕組みを利用して、周囲に識別子情報を送信しつづけるビーコンと、それをフォアグラウンドおよびバックグラウンドで検出しつづけるiOSデバイスを組み合わせた技術です。

[^2060]: [iBeacon https://developer.apple.com/ibeacon/](https://developer.apple.com/ibeacon/)

iBeaconの活用は3つあります。

1つは電波を出すビーコンの製造販売です。Bluetooth Low Energyの電波到達範囲はせいぜい50メートルなので、店舗や建物での屋内位置検出には多数のビーコン設置が必要です。各社から、用途に合わせた多種のビーコン、安価なもの、電池で何年間も送信しつづけるもの、あるいはUSB給電の据置型など、が発売されています。

ビーコンを利用するアプリケーションは、iBeaconを利用したサービス提供側が開発するので、ビーコンの製造側がiOSアプリケーションを開発する必要はありません。ですが、ビーコンの設定や運営管理を手軽にするためにiOSアプリケーションは便利なので、たいていのビーコン製造側は販売しているビーコン専用のiOSアプリケーションを提供しています。

2つめは、アプリケーション開発およびサービス提供です。販売あるいは自社製造のビーコンを使い、建物などに用途にあったビーコンの設置およびiOSアプリケーション開発を提供します。iOSアプリケーションは、位置情報を扱う CoreLocationフレームワーク でビーコンの情報を取得できるので、iOSアプリケーション開発者は電波伝搬などの知識を持たなくても開発ができます。

iBeaconを使うiOSアプリケーション開発には、ビーコンの詳細な技術情報は必要ないので、MFiプログラムは不要です。ただし、アプリケーションやサービスを提供している建物に、iBeaconの商標やロゴを表示したい場合は、iBeaconの商標とロゴ利用に限定されたMFiプログラムへの参加が必要です。

3つめは、ビーコンも受信側もiOSアプリケーションで実現するものです。iOSアプリケーションはフォアグラウンド(画面が表示されている状態)のときに、ビーコンになれます。例えば、すれ違いの検出や、複数所有しているデバイス間で繋ぎ目を感じさせないアプリケーション連携をするなど、お互いの存在を伝える技術手段として使えます。

### ユーザを取り囲むデバイス群との連携

[#table-ios-and-ble]の5から7は、ユーザを取り囲む様々なデバイス群とiOSとの連携です。ユーザが装着する、いわゆるウエアラブル・デバイスは、生体情報検出とユーザへの情報通知デバイスとして、2014年以降に成長すると期待される分野です。また、家電も、ユーザがその内部に入る環境制御装置としてみれば、広義のウエアラブル・デバイスと考えられます。

iOS7から、iOSのロック画面に表示される通知情報を Bluetooth Low Energy で周辺デバイスに通知する [Apple Notification Center Service ,ANCS ](https://developer.apple.com/library/ios/documentation/CoreBluetooth/Reference/AppleNotificationCenterServiceSpecification/Specification/Specification.html) [^2070] というサービスが実装されて、そのサービスの仕様が公開されています。周辺デバイスが ANCS の仕様を実装すれば、腕時計型のウエアラブル・デバイスでよくあるメールやソーシャルメディアの通知情報の表示ができます。

<!-- TBD 質問すること -->
ANCSはiOSが提供するサービスなので、周辺デバイスを開発するだけです。iOSアプリケーションの開発は不要です。ただし設定や周辺デバイスの独自の機能を利用する場合は、専用のiOSアプリケーションを開発します。ANCSにMFiプログラムが必要かいなかは、Apple社に問い合わせてください。

<!-- TBD 質問すること -->
iOSとつながるBluetooth Low Energyデバイスの開発はMFiプログラムへの参加は不要です。ですが、Apple社のアクセサリ設計ガイドライン [Bluetooth Accessory Design Guidelines for Apple Products](https://developer.apple.com/hardwaredrivers/bluetoothdesignguidelines.pdf) [^2080]には、アクセサリ設計に認証機能を取り込むには、MFiプログラムで提供される認証仕様をサポートしなければならないとあります。周辺デバイスがiOSデバイスのANCSにアクセスするとき、iOSは認証を要求します。そのためANCSを使う周辺デバイスは、MFiプログラムの対象かもしれません。

[^2070]: [Apple Notification Center Service https://developer.apple.com/library/ios/documentation/CoreBluetooth/Reference/AppleNotificationCenterServiceSpecification/Specification/Specification.html](https://developer.apple.com/library/ios/documentation/CoreBluetooth/Reference/AppleNotificationCenterServiceSpecification/Specification/Specification.html)

[^2080]: [Bluetooth Accessory Design Guidelines for Apple Products https://developer.apple.com/hardwaredrivers/bluetoothdesignguidelines.pdf](https://developer.apple.com/hardwaredrivers/bluetoothdesignguidelines.pdf)

iOS8から[HealthKit](https://developer.apple.com/healthkit/) [^2090] が導入されました。これはiOS自体が心拍や血糖値などプロファイルが規格化されているヘルスケア・デバイスからデータを取得してiOSのデータベースに集約します。集約されたデータは、iOSの標準アプリケーション Health で表示できます。また、一般のiOSアプリケーションもHealthKitフレームワークを通じて、データベースの参照や書き込みができます。

[^2090]: [HealthKit https://developer.apple.com/healthkit/](https://developer.apple.com/healthkit/)

iOS7までは、例えばフィットネスのiOSアプリケーションを開発しようとすると、心拍センサーなどの標準的なデバイスでも、iOSアプリケーションにデバイス・ドライバに相当する部分も実装しなければなりませんでした。さらに、iOSアプリケーションはそれぞれがデータを蓄積するもので、他のアプリケーションが蓄積されたデータを参照する標準の仕組みはiOSにはありませんでした。

iO8からは、周辺デバイスからのデータ取得をiOSがおこなうので、iOSアプリケーションはアプリケーション本来の機能に注力できます。また、iOSがデータを集約するので、iOSアプリケーションをインストールすればすぐに、蓄積されたデータを過去にさかのぼり参照できます。

iOSアプリケーションはHealthKitのデータベースに書き込むことができるので、独自のヘルスケア・デバイスを開発した場合は、そのデバイスに対応したiOSアプリケーションを開発して、HealthKitのデータに書き込むこともできます。

HealthKitに対応した周辺デバイスの開発は、規格化されたプロファイル、およびカスタム・プロファイルを実装した Bluetooth LowEnergy 技術だけを使うデバイスであれば、MFiプログラムへの参加は不要です。HealthKitを使うiOSアプリケーション開発も、MFiプログラムは不要です。

iOS8で導入された家のオートメーションをもたらす[HomeKit](https://developer.apple.com/homekit/) [^2100] は、Apple社の通信仕様と、iOSアプリケーションがデバイスと通信や制御をおこなうためのHomeKitフレームワークで構成されます。

[^2100]: [HomeKit https://developer.apple.com/homekit/](https://developer.apple.com/homekit/)

HomeKitフレームワークは、周辺デバイスのグループ化とアクションを設定するものです。例えば、1階にある家電群、2階にある家電群のようなグループを設定できます。また、昼の照明設定と夜の照明設定のように、アクションを設定できます。デバイス群の操作はSiriを通しておこないます。この例であれば「1階にある照明を夜の設定にしろ」と命令すれば、グループ化とアクションの設定から、1Fにある照明群に対して、夜の設定を適用する処理を、iOSがおこないます。

HomeKitのiOSアプリケーションは、家電に付属する赤外線リモコンのように装置を個別に操作するものではなく、装置群をiOSに登録する役割を担います。また、Bluetooth Low Energyを通じたデバイスの詳細設定などの機能も必要でしょうから、専用のiOSアプリケーション開発は必要です。HomeKitを使うiOSアプリケーション開発には、MFiプログラムは必要ありません。

HomeKitに対応する家電は、Bluetooth Low EnergyまたはWiFiで通信します。それぞれMFiプログラムのもとで開示される Apple社の独自の通信仕様 Home Automation Protocol を実装します。ですから、HomeKit対応デバイスの開発は、MFiプログラムへの参加が必要です。

### AndroidとWindows Phone8の対応

周辺機器の企画作成では、対応機種が多いほど、より多く売れる感じがするため、iOS以外のモバイルOSの対応を考えるかもしれません。OS(オーエス、Operating System、オペレーティングシステム)とは、アプリケーションに基本的な機能を提供する、システム全体を管理するソフトウェアのことです。

iOS以外のモバイルOSは、Android OSがあります。このほか、2013年には、Windows Phone 8、Tizen、Firefox OS、も登場するかもしれません。

[http://www.android.com](http://www.android.com)
[http://www.mozilla.jp/firefoxos/](http://www.mozilla.jp/firefoxos/)
[https://www.tizen.org/ja](https://www.tizen.org/ja)

一般開発者から見た Bluetooth Low Energy 対応の条件は:

1. ハードウェアがBluetooth4.0に対応している
2. OSがBluetoth LEに対応している
3. ソフトウェア開発環境から Bluetooth Low Energy が使える(開発環境が一般開発者に開放されている)

の3条件が必要です。

Androidは、ハードウェアの認定要件がありません。2013年7月時点での新製品でも、Bluetooth2.0, 3.0そして4.0が混在しています。特に低価格帯にBluetooth2.0が多いようです。ただ、Bluetooth3.0の機種が、発売後にBluetooth4.0の再認証を取得してきています。発売時点で、Android OSが公式に Bluetooth Low Energy に対応していないため、ハードウェアはBluetooth4.0に対応していても、Bluetooth3.0として発売したのでしょう。

Android OSに、2013年秋頃に公開定のAPI Level18で、はじめて Bluetooth Low Energy に対応します。セントラルのみに対応していています。これ以前から、半導体や端末メーカが、それぞれ独自に Bluetooth Low Energy 開発ライブラリを提供していました。ライブラリごとに対応機種が限定されて、採用しにくいものでした。

 [https://developers.google.com/events/io/sessions/326240948](https://developers.google.com/events/io/sessions/326240948)

[http://developer.samsung.com/ble](http://developer.samsung.com/ble)

Windows Phone8は、2013年7月時点では、ハードウェア要件にBluetoothのバージョンの指定はありません。OSのサポートは、まったくありません。パソコンに使うWindows8は、ハードウェア認定要件でBluetoothは4.0を搭載することが決められています。

Tizen, Firefox OSは、Bluetoothを扱うライブラリに Bluetooth Low Energy が含まれていません。

## Bluetooth Low Energy の無線通信技術
<!-- 個々イントロ -->
通信規格、技術的に深堀り。

### 規格成立までの歴史

<!-- ゆりかごは、おんなじなんですよね。しかしなんで、北欧 -->
Bluetooth Low Energy の研究は、2001年に始まりました。ノキア・リサーチ・センターは、Bluetooth規格を継承しつつ、より低消費電力で低価格な新しい無線通信技術の開発をはじめました。[http://en.wikipedia.org/wiki/Bluetooth_low_energy](http://en.wikipedia.org/wiki/Bluetooth_low_energy)

<!-- 技術開発が世にでるのって、きっと政治的なんでしょうね -->
この低消費電力の通信技術は、紆余曲折を経てBluetoothとして統合されます。最初の研究成果は、まずBluetoot Low End Extensionとして2004年に公開されました。EU FP6プロジェクトMIMOSA(Microsystems Platform for Mobile Services and Applications)といった、パートナーと更に開発を進めた後に、この技術は2006年10月にWibree(ウィブリー)ブランドとして公開されました。

<!-- 本当はIPv6にいったかもしれないんだけど、BTブランドにはいった -->
一旦はWibreeという独立した技術として公開されましたが、その後のBluetooth SIGメンバーとの交渉により、Wibreeを将来のBluetoothの低消費電力の規格として含めることに、2007年6月に合意がなされました。そして2010年6月に採択されたBluetooth コア仕様 バージョン4に、Bluetooth LEとして統合されました。

### Bluetooth SMART READYとBluetooth SMARTロゴ

Bluetooth4.0に統合されたBluetooth LEは、Bluetooth3.0までの技術とは互換性がありません。ですから、Bluetooth LEのみに対応しているデバイスは、Bluetooth3.0までの端末と接続できません。一部分、下位互換性がなくなったため、これまでのように、1つのロゴで相互接続性を表せなくなりました。<TBD Bluetoothロゴ>

そこで、Bluetooth4.0では、クラシックBluetoothの1つのロゴから、Bluetooth SMART READYとBluetooth SMARTロゴという2つのロゴになりました。<ロゴの図> [https://www.bluetooth.org/ja-jp/bluetooth-brand/how-to-use-smart-marks](https://www.bluetooth.org/ja-jp/bluetooth-brand/how-to-use-smart-marks)

Bluetooth SMART READYは、クラシックBluetoothとBluetooth LEの無線通信機能をもち、それらがどちらか一方または同時に動作するものを示します。パソコンや携帯電話などに搭載されるのは、このBluetooth SMART READYです。Bluetooth SMART READYのロゴがあるものは、クラシックBluetoothとBluetooth LEのデバイス、すべてのBluetoothと接続できます。

Bluetooth SMARTは、Bluetooth LEの無線通信機能だけをもつデバイスを示します。Bluetooth3.0までの端末からは、このデバイスに接続できません。Bluetooth SMART READYの端末から、接続できます。キーホルダーや心拍計などの、周辺機器がこれを採用します。

Bluetooth 4.0の登場で、周辺機器は、Bluetooth3.0までに対応したものと、Bluetooth SMART READYのもの、そしてBluetooth SMARTの3種類になりました。周辺機器にも、Bluetooth SMART READYのものがあります。これは、まだBluetooth4.0では携帯電話とも接続するためだったり、あるいはスマート・ウォッチのように、クラシックBluetoothのメールや電話着信を通知するプロファイルを利用するためだったりします。

### Bluetooth Low Energy の無線通信

<!--TBD-->に、Bluetoot LEの特徴を示します。

Bluetooth LEの無線通信の概要

項目               | 値                    
:------------------|:----------------------
周波数             |   2.400-2.4835 GHz    
物理層のビットレート | 1 Mbps                
通信送信電力        | 10ミリワット ~ 10マイクロワット
伝達距離           |  50 メートル (見通し)          


Bluetooth LEが利用する周波数は、クラシックBluetoothと同じです。周波数が同じなので、デュアル・モードのデバイスは、アンテナや高周波回路をクラシックBluetoothとBluetooth LEで共用できます。

通信のビットレートは、1Mbpsです。これは0,1というビットの通信速度です。Bluetooth LEでは、データは決められた時間周期ごとにパケットの送受信でやりとりします。パケット自体の通信速度は1Mbpsですが、常にパケットが流れ続けられる規格ではないので、パケットのやり取りによる実際の通信速度は、300kbps程度になります。Bluetooth LEデバイス間の通信速度は、通信パラメータで大きく異なります。iOSデバイスでの通信速度は、おおよそ10 Kバイト/秒です。

Blueooth LEの送信電力は、最大10mW、最小10 μWです。最大出力電力時の通信距離は、見通し距離で150m程度になります。距離は、受信回路の感度や送受信アンテナの利得(高周波電力を電波にして空間に放つ効率)が高ければ、これより大きくなるかもしれません。また、建物の壁などの遮蔽物があったり、見通しではない環境では、通信距離は見通し距離よりもずっと短くなります。目安としてオフィスで30m程度は通信できます。<TBD 確認>

送信電力は、Bluetooth LEデバイス内部のソフトウェアから設定できます。ハードウェアで固定されないので、状況に合わせた、必要な通信距離が得られるような、送信電力の設定動作が可能です。例えば位置ビーコンであれば、位置を知らせたい範囲内に届く程度に送信電力を設定します。またiPhoneに取り付けるキーホルダのように、常に近距離にあるものならば、通信距離が数メートル程度になるように、送信電力を絞り込むこともできるでしょう。

### Bluetooth LEのネットワーク

Bluetooth LEで、デバイスをこう使いたい、と考えるときに、このネットワークの仕組みを知っておくと、何ができるのかがわかり、便利です。

Bluetooth LEのネットワークは、ネットワークを制御する1つのマスターに多数のスレイブが無線接続します。

この1つのネットワークを、ピコネット(Pico net)と呼びます。ピコは、イタリア語で小さいを意味するpiccoloからとられた、SI単位系で10<sup>-12</sup>を表す接頭辞ピコのことで、ピコネットは、とても小さいネットワークの意味です。中心から周囲に広がる接続の様態が星のようなので、スター型ネットワークと呼ばれます。

<TBD: スター型の図、アドバタイズメント、iPhoneを中心にペリフェラル, iPhoneがペリフェラル>

<!-- 接続手順 -->
マスターとスレイブのの接続手順は:

* スレイブがアドバタイズメント・パケットを送出
* マスターが、接続要求を出して接続
* 通信
* 切断

です。

まず、マスターがスレイブがあることを知らないといけません。スレイブは、機種情報や個体識別番号などが入ったアドバタイズメント・パケットを送出します。どのマスターでも、アドバタイズメント・パケットを受信できます。アドバタイズメント・パケットは、スレイブが、まだどのピコネットにも属していないときにだけ、送出できます。

Bluetooth LEの特徴は、スレイブの発見がとても早いことです。アドバタイズメント・パケットは、最小20ミリ秒周期(1秒に50回)で送出できます。アドバタイズメント・パケットは、は、アドバタイズメントのために割り当てられた特定の周波数範囲で送信することで、マスターはほぼ確実にこのパケットを受信できます。実際に、デバイスの発見に1秒もかかりません。<TBD 実験>

アドバタイズメント・パケットを受信してスレイブを発見したマスターは、接続要求を出して接続を確立します。接続している間、スレイブはそのマスターのピコネットに属します。接続したマスターとスレイブは、そのマスターとスレイブだけが知っている切り替え順番で、通信に使う周波数領域を切り替えながら、通信します。これを適応周波数ホッピング方式と呼びます。

同時に接続できるスレイブの上限数は、Bluetooth LEの規格では、およそ 2<sup>31</sup>(約21億)です。クラシックBluetoothでは、規格で7に制約されます。同時接続上限数は、実際には、Bluetooth LEのプロトコル・スタックの実装次第で決まります。iOSデバイスは10です。ただし、iPhoneは、10のスレイブと接続しているときでも、どのスレイブからのパケットでも、アドバタイズメント・パケットの受信はできます。<TBD 確認>

スレイブは、同時に2つ以上のピコネットに属することはできません。必ず1つのピコネットに属します。スレイブとの接続は特定のピコネットに縛られることはありません。任意のマスターと接続できます。スレイブが別のピコネットに接続するときは、まず接続を切断してから、別のマスターとの接続処理をおこないます。

切断要求は、マスターからでも、スレイブからでも、出すことができます。また、マスターとスレイブは、それぞれ一定時間通信ができなければ、切断とみなします。接続切断したスレイブは、またアドバタイズメント・パケットを送出して、次の接続要求が来るのを待ちます。

Bluetooth LEのネットワークは、とてもシンプルな設計です。接続が切断しても再接続をしたりしません。クラシックBluetoothは、iOSの設定アプリケーションから、ユーザに、スレイブとのネットワーク接続をしてもらわなくてはなりません。Bluetooth LEは、しかし、スレイブの発見と接続が速いことに加えて、iOSアプリケーションがスレイブとの接続処理を直接実行できます。接続切断時は、iOSアプリケーションで再接続が必要だと判断すれば、iOSアプリケーションから接続処理を再開できます。これにより、なんの不便もありません。

<!-- 追加 -->
他の超低消費電力無線通信技術には、例えばZigbee、他のデバイスからの通信を他のデバイスに中継する、マルチホップ通信の機能があります。マルチホップ通信ができれば、広域に散らばった多数のデバイスがネットワークを形成して、例えばセンサネットワークなどを、デバイス単体で構築出来ます。

ですが、Bluetooth LEのネットワークは、スター型で、マルチホップ通信の機能はありません。アクセサリは隣接するiPhoneと直接接続することしかできません。ハブ・デバイスとアクセサリ、という1対1対応のみが可能です。

### プライバシーとセキュリティ

無線通信の電波は四方八方に飛んでいくため、その通信がいつどこで傍受されるかは、わかりません。Bluetooth LEの規格は、利用者のプライバシーと、通信内容が第三者に漏れないセキュリティを考慮しています。

まず、無線通信は、その通信内容から容易に人物を特定して追跡できるものであっては、なりません。Bluetooth LEのマスターとスレーブは、互いを識別するために、通信でアドレスを使います。もしも、誰かのスレーブのアドレスが分かっていれば、傍受した通信からそのアドレスを探すことで、その人がいつどこにいるかを容易に追跡できてしまします。

<!-- アドレスの解説 -->
Bluetooth LEのアドレスには、パブリック・アドレスとランダム・アドレスの2つがあります。パブリック・アドレスは、製造企業が割り当てる固定値のアドレスです。このアドレスは製品が作られた時に書き込まれ、変化することはありません。もう1つの、ランダム・アドレスは、文字通り、ランダムなアドレスです。スレイブの電源を入れた時に、ランダムなアドレスが設定され、さらに15分毎に、あるルールに従って、別のランダムなアドレスに変更されます。

<!-- アドレスの選択-->
プライバシーを守るために、パブリック・アドレスを使うか、ランダム・アドレスを使うかは、そのデバイスの使われ方などで、設計者が決めます。

<!-- 通信路暗号化 -->
セキュリティーを確保するために、パケットのデータ自体を暗号化できます。スレーブはマスターに接続するときに、パケットのデータを平文(暗号化しない)とするか、AES(Advanced Encryption Standard)という暗号方式を使うかを、マスターに通知します。

<!-- 実装の選択 -->
プライバシーとセキュリティをどうするかは、利用場面にあわせて選びます。プライバシーとセキュリティを求めると、Bluetooth LEでは、スレイブとの接続時に、少し手間がかかります。

ランダム・アドレスを採用すると、例えば、スレーブの電源がOFF/ONされると、アドレスが再生成されます。そのため、iOSアプリケーションには、そのスレイブが以前に接続したものだと、識別できなくなります。ですから、例えばスレイブの電池交換をするたび、iOSアプリケーションでの接続設定が必要になります。

セキュリティーを採用すると、マスターが初めてスレイブと接続する時に、iOSアプリケーションから、iOSの設定アプリのBluetooth設定に表示が遷移します。スレイブの接続が完了すると、クラシックBlueoothと同じく、このBluetooth設定にデバイス名が表示されます。これは、暗号化につかう鍵がiPhoneに保存されたことを、示しています。このBluetoothの接続を削除すると、鍵が削除されます。

## iOSと周辺機器のインタフェース

Bluetooth LEは、iOSと周辺機器との接続手段、インタフェースの1つです。Bluetooth LEはMFiプログラムが必須ではないので、たしかに取り組みやすいのですが、想定する利用場面に使えるのか、あるいは他により適切なインタフェースがないかを検討することは、必要です。

インタフェースは用途似あわせて、適切なものを選択します。ここでBluetooth LE以外のインタフェースをみてみます。

### 有線インタフェース

iOSには、有線インタフェースと無線インタフェースがあります。

有線インタフェースは、ドックコネクタがあります。iPhone4Sまでの30ピン ドックコネクタと、iPhone5以降のライトニング  ドッグコネクタの2種類があります。ドックコネクタを通じて、USB2.0、480Mbpsのビットレートでの通信ができます。

ドックコネクタのハードウェア開発情報を入手するには、MFiプログラミングの参加が必須です。これに参加して提供される、ドックコネクタの認証チップは、Apple社の承認を受けた正規の製品であることを、ドックコネクタを通じてiPhoneに通知します。また、その製品に対応したiOSアプリケーションがiPhoneにないときは、ダウンロード画面を表示させます。

しかし機能実証のための試作で、MFiプログラムに参加するのは時間も費用もかかります。試作であれば、MFiプログラムに参加せずにドックコネクタを使うには、2つの方法があります。

* シリアル・アダプタを利用する
* MIDIインタフェースを転用する

ドックコネクタのシリアル・アダプタが60ドル程度で販売されています。115.2kbpsまでのシリアル通信ができます。試作に用途が限定されており、このアダプタに接続するiOSアプリケーションをAppStoreに出すことは、利用規約で禁止されています。

[http://www.redpark.com/c2db9.html](http://www.redpark.com/c2db9.html)

演奏装置のインタフェース規格 MIDI(ミディ、Musical Instrument Digital Interface)のドックコネクタ・アダプタが一般に販売されています。MIDI規格は、演奏データをシリアル通信で送受信するものです。このインタフェースを転用して、サーボモータを動かすデモンストレーション例があります。iOSアプリケーションのAppStoreの承認は、この方法を使うiOSアプリケーションがAppStoreで見つからず前例が見つけられないので、わかりません。

[http://youtu.be/S90heTt5-Ko](http://youtu.be/S90heTt5-Ko)

また、音響モデムの原理を利用して、イヤホン端子でデータ通信をするワザもあります。これは10kbps程度の通信ができます。iOSアプリケーションのストア承認は、AppStoreの担当者との交渉次第です。

[http://web.eecs.umich.edu/~prabal/projects/hijack/](http://web.eecs.umich.edu/~prabal/projects/hijack/)


### 無線インタフェース

iPhoneの無線インタフェースは、WiFi、Bluetooth(クラシックBluetoothとBluetooth LE)です。それぞれのビットレートとMFiプログラムの要不要をまとめます。<!--TBD-->

<!-- 表 無線インタフェースの通信速度 -->
名称              | 物理層のビットレート | MFiプログラム | 接続設定
*----------------|------------------*|-------------+---------
無線LAN (802.11g) |54Mbps             | 不要         | 必要
Bluetooth2.0     | 3Mbps             | 必須         | 必要(※)
Bluetooth LE     | 1Mbps             | 不要         | 不要
※Bluetoothの標準プロファイルを利用する場合はMFiは不要。

#### 無線LAN

無線LANは、最も高速な無線通信です。動画のストリーミングなど、高い通信速度が必要な用途には、無線LANを使います。通信速度が早いほど、電力消費量も大きくなります。ですから、大容量の電池を搭載していて頻繁に交換や充電をおこなう機器、例えばラジコンなどには、自然に適用できます。また、通信頻度や通信速度が低くてもよい分野に特化した、単三電池電池で数ヶ月も長期間動作するような、低消費電力の無線LANモジュールもあります。

[http://www.gainspan.com/](http://www.gainspan.com/)

無線LANの接続形態は、機器と1対1で接続するアドホック・モードと、複数の機器と無線LANルータを介して接続できるインフラストラクチャ・モードの2つのモードです。

インフラストラクチャ・モードは、無線LANルータが必要なので、屋内など移動しない場合に使えます。移動したり屋外での利用では、無線LANルータがあるとは限らないので、アドホック・モードを使います。周辺機器とアドホック・モードで接続すると、iPhoneの無線LANは、その機器に専有されます。もしもこのときに、外部ネットワーク接続が必要になると、WiFi以外の、3G通信かBluetoothでのテザリングを使うしかありません。

無線LANは、ユーザによる設定が必要です:

* 無線LANの接続先の設定
* iOSアプリケーションのダウンロード
* 接続機器のIPアドレスの入力

無線LANの接続先は、設定アプリからユーザがおこなう必要があります。さらに、インフラストラクチャ・モードのときは、iOSアプリケーションに、接続先機器のIPアドレスの設定が必要になります。この無線LANの設定手順は、図入りで説明した説明書を別に用意しておくとよいです。設定アプリに画面遷移してしまうので、iOSアプリケーションに設定方法を表示する方法が使えません。ですから設定アプリを見ながら設定するときに説明書があれば、ユーザが迷いにくくなります。

無線LANを使う周辺機器には、MFiプログラムは必要ありません。MFiプログラムが必要ないということは、逆に、Apple社から、機器接続やiOSアプリケーションのインストール方法などの特別の配慮を受けられない、ことでもあります。

ユーザ自身が、機器に対応するiOSアプリケーションをダウンロードしなくてはなりません。機器に接続しても、iOSアプリケーションは自動でダウンロードされません。

また、例えばUPnP(ユーピーエヌピー，ユニバーサルプラグアンドプレイ、Universal Plug and Play)やBonjour(ボンジュール)など、ネットワークに接続すれば、ユーザが設定をしなくても機器が使用可能になる、ゼロ・コンフィギュレーション技術を使えば、IPアドレス設定などを不要に出来ます。しかし、iOSからゼロ・コンフィギュレーション技術は提供されていません。必要であれば独自に実装します。

#### クラシックBluetooth

ここでは、Bluetooth LEと区別するために、Bluetooth3.0での技術をクラシックBluetoothとよびます。

クラシックBluetoothは、常時接続してデータを送り続ける用途に適し、通信速度も高いので、ヘッドセットやテザリングなどに利用できます。クラシックBluetoothの接続は、iPhoneに多数の周辺機器が接続するスター型です。コインサイズの小さなリチウムイオン電池で、1週間程度の通信ができます。電池交換は頻繁すぎて不便ですから、充電式に設計されます。

クラシックBluetoothでは、通信のみならず接続機器の振る舞いまでを含んだ機能を、プロファイルと呼びます。パソコンで言えば、通信プロトコルのみならず、デバイスドライバの仕様までを含むものが、プロファイルと呼ばれます。

プロファイルには、キーボードやマウスなどの入力装置、メールや電話着信の通知など、様々なものが定義されています。利用目的にあったプロファイルがすでにあれば、それを利用して少ない開発労力で機器開発ができます。

[Bluetooth Developer Portal, Profiles Overview](http://developer.bluetooth.org/TechnologyOverview/Pages/Profiles.aspx#Profiles)

クラシックBluetoothデバイスとの接続に、まずペアリングが必要です。ペアリングはiOSが処理するため、ユーザは、設定アプリのBluetooth設定で、デバイスを選択してペアリングをします。接続が切れるたび、ユーザによる接続操作が必要です。

クラシックBluetoothのプロファイルに従う周辺機器には、MFiプログラムは不要です。しかし、利用できるプロファイルがなく、iOSアプリケーションと直接通信したい場合は、MFiプログラムへの参加が必須です。

プロファイルの利用例として、例えば、iOSデバイスと接続できるバーコードリーダがあります。バーコードリーダ専用のプロファイルはありませんが、例えばキーボードに使うHID(Human Interface Device Profile)を採用して、読みだしたバーコード情報をテキストで送信して、iOSアプリケーションに情報を伝えることができます。

クラシックBluetoothでは、任意の通信には、SPP(Seerial Port Profile)を使います。このプロファイルは、端末間の通信を決めるものです。接続先に、端末内部で動作しているアプリケーションまでを指定する仕組みはありません。

MFiプログラムに参加すると、iOSアプリケーションと接続するための認証チップを含むハードウェアなどの開発キットが提供されます。この認証チップは、Apple社が承認した周辺機器のみがiOSアプリケーションと接続できる排他的な振る舞いをしますが、同時に、SPPに欠けている、モバイル機器には必要な、周辺機器が指定されたiOSアプリケーションにのみ接続する仕組みも、提供しています。

## アプセサリを作るには

<!-- 個々に何か書くこと -->

### ハードウェアとソフトウェアの開発体制

アプセサリのiOSアプリケーションは、ハードウェアと密接につながります。そのため、通信部分とドライバ相当は、両方をよく理解して協調して設計することが大切です。Objective-Cもできるハードウェア開発者が担当することが最適です。

iOSアプリケーションからみて、ハードウェアが期待した振る舞いをしないときは、問題がどこにあるのかを切り分けることが困難です。原因は、iOSアプリケーションのドライバ層の使い方の間違い、Bluetooth LEの通信、ハードウェアの設計、これら4つのどれかにあります。しかし、iOSアプリケーション開発者からは、通信以降を調べる手立てがありません。それらを調べられるのはハードウェア担当者です。

なにかおかしいことが起きた時に、原因箇所の特定には時間がかかります。このときに、ハードウェアの振る舞いを確認できるデモンストレーション・アプリケーションを作製しておけば、iOSアプリケーションとドライバ相当部分が原因かそうでないかが、すぐに切り分けできます。iOSアプリケーション以外に原因があるときは、通信プロトコルを見たり、ハードウェアの設計内容を確認していきます。それはハードウェア設計の担当領域です。

### ハードウェア設計

- Made for iPhoneプログラムは不要
- 部品代は5ドル、モジュールは10ドル前後
- モジュールを利用した場合、電波法の認証及びBluetoothの認証費用はかからない

 Bluetooth Low Energy は、[Made for iPhone (MFi) プログラム](https://developer.apple.com/jp/programs/mfi/) の締結が必須ではありません。クラシックBluetoothでは、特定のiOSアプリケーションと接続するデバイスの開発には、Apple社とMFiプログラムの締結が必須でした。MFiプログラムを締結して初めて、ハードウェアやソフトウェアの開発情報が提供されます。

MFiプログラムが必須ではなくなったことで、ベンチャーの参入ハードルが極端に下がりました。 Bluetooth Low Energy デバイスと接続するiOSアプリケーションは、AppStoreの承認を得られます。ただし、デバイスにMFiロゴを掲載する場合は、ロゴの使用権を得るためにMFiプログラムの締結が必要です。

 Bluetooth Low Energy の電子回路を独自に設計した場合の製造コストは5ドル程度です。これらの電子回路を小さな基板にまとめて部品化したものを、モジュールと呼びます。モジュールの価格は10ドル前後です。

モジュールを使うことで、電波法の基準認定とBluetoothの規格認定および製品登録にかかる初期費用が省けます。

電波を出す回路は、外部に電波がもれ出ない試験環境で動作させるか、あるいは、それぞれの国ごとの電波法に基づく基準認証をうけなくてはいけません。認証を取得しているモジュールを利用すれば、製品ごとに認証をとる必要はありません。

また、 Bluetooth Low Energy ロゴを表示して販売するには、Bluetooth SIGへの製品登録が必要です。製品登録には、Bluetoooth SIGへの、最低でも年間5000ドルのメンバー登録費用と、設計ごとの認証費用が必要です。

各社のモジュールは、それ単体でのBluetoothの製品登録が完了しています。無償のBluetooth SIGのメンバー登録をおこない、 Bluetooth Low Energy のモジュールを利用した派生製品として登録すれば(この登録は無償)、製品登録が完了します。


### アクセサリの実例

アプリケーションやネットワークそして事業までを統合したアプセサリは、まだ少なくこれから登場するでしょう。アクセサリ自体は、2012年の夏あたりから次々登場しています。いくつかを紹介します。

1つは、プロトタイピングのための開発キットやアクセサリです。これらは、早い時期から登場しています。まずBluetooth LEの半導体やモジュール会社が、組み込み機器開発者向けキットの提供を開始しました。iOSアプリケーション開発者のなかにも、Bluetooth LEデバイスの開発をしてみたい要望があります。次に登場してきたのが、その要望にあわせて、組み込み機器開発者でなくても使いやすい、より安価な開発キットです。

日本の技術基準適合証明を取得しているプロトタイピングに向いたものに:

* SBBLE(サブレー) [http://sbble.micutil.com](http://sbble.micutil.com)
* Konashi [http://konashi.ux-xu.com](http://konashi.ux-xu.com)
* センサータグ [http://www.tij.co.jp/tool/jp/cc2541dk-sensor](http://www.tij.co.jp/tool/jp/cc2541dk-sensor)

があります。

SBLBLE(サブレー)はマイクロチップ・テクノロジー・ジャパン株式会社のPICマイコンを採用した開発キットです。市販のUSB Bluetooth4アダプタを挿して使います。Konashiは、iOSアプリケーション側の開発がObjective-Cに加えてJavaScriptでも開発できます。ウェブ・サービスの開発者が、フィジカル・コンピューティングをiOSでおこなう場合の唯一の選択肢です。センサータグは、テキサス・インスツルメンツ社の半導体の評価キットで、25ドルと低価格です。次のセンサを搭載しています:

* 放射温度センサ、温度センサ
* 湿度センサ
* 圧力センサ
* 加速度計
* ジャイロスコープ
* 磁力計

必要なセンサが上記にあるプロトタイピングであればセンサータグを、LEDの点灯など低速の外部装置制御をiPhoneから行うならKonashiまたはSBBLEを、任意のファームウェアを開発したいときはSBBLEを選択するとよいでしょう。

キーホルダーまたはタグは、よくあるアクセサリです:

* キーホルダー、
[iPhone用探せるキーホルダー](http://buffalo.jp/products/catalog/supply/bluetooth/bluetooth/security/bshsbtpt01/)
* StickNFind [https://www.sticknfind.com](https://www.sticknfind.com)

キーホルダーは、iPhoneと接続して使うものです。iPhoneを置き忘れしそうになった時にキーホルダーから警告音を出したり、キーホルダーのボタンを押すとiPhoneから音が出る機能でiPhoneを探すのに利用します。タグは、代表的なものにStickNFindがありますが、ものに取り付けておいて、ものを探すのに使うものです。その機能は、キーホルダーのボタンを省略したもので、おおよその距離をiPhoneで確認すること、iPhoneから操作してタグから音や光を出すこと、ができます。

たいていのキーホルダーやタグは、仕様が公開されていたり、ソフトウェア開発キットが提供されていて、アプリケーション開発に利用ができます。近接検出または光や音の出力を必要とするプロトタイピングに利用できます。

この他にも:

* 心拍センサ、 [Alpha](http://www.alphaheartrate.com)
* 活動量計、[Fitbit](https://www.fitbit.com)
* 睡眠記録、[オムロン ねむり時間計](http://www.healthcare.omron.co.jp/corp/news/detail/223)
* 姿勢検出、 [Lumoback](http://www.lumoback.com)
* 腕時計、[Pebble](http://getpebble.com)

などが市販されています。

### プロトタイピングのすすめ

プロトタイピング(Prototyping)は、プロトタイプ(Prototype)を作り、早期に設計などを検証する手法です。とくに、参加者の分野が様々なブレインストーミングでは、お互いの認識のすり合わせにプロトタイプが使えます。

これは著者個人の体験ですが、粘土をこねて外形を作った、あるいはiPhoneで機能するプロトタイプを作り、それを手で触れていると、そこから驚くような発見や広がりそして展開が、急速に出ます。アプセサリの魅力は、アクセサリとアプリケーションの連携が生み出す体験です。形あるプロトタイプに触れる体験を通して、その背後にある形のないアプセサリの体験を、肌で感じられます。

形があると、つい目を奪われますが、、しかしアクセサリはアプセサリの要素にすぎません。アプセサリの体験という大きな絵を見るための、ジグソーパズルの1つのピースとして、役立ちます。

プロトタイピングにかける期間は、できればブレインストーミング中に作製、時間がかかるならば、前回のブレインストーミングの内容を覚えていて、過熱した頭が冷える程度の期間、例えば2〜3日程度、が望ましいでしょう。体験ができればいいので、実際に実装する必要はありません。その期間でできることを、工夫します。ネットワーク・サービスが必要ならば、決め打ちの画面や、紙に書いた画面をカメラで取り込んだものでも、十分でしょう。Bluetooth LEデバイスは、iPhoneのセンサで間に合うことがほとんどで、また市販されている試作用のBluetooth LEデバイスもあります。

ブレインストーミングでアイディアを出しつくしたならば、そのなかから、面白さや楽しいさ、事業として継続できるかなどの尺度で、ふるいにかけます。アイディアのなかには、必要とするセンサが販売されていない、非常に高価な部品を必要とする、電池や回路の工夫ではどうにもできない形状や大きさを求めている、ものがあります。プロトタイプにはいる前に、そのような明らかに実現不可能なものは、実装についての知識がある担当者が、メンバーにその理由を説明して、変更を加える、もしくは不採用にします。

### アプセサリのブレインストーミング

アプセサリは、何が正解か誰も知らない、新しいものです。そのため、アプセサリの企画では、ブレインストーミングという会議方法をとることがあります。ブレインストーミングは、参加メンバーがアイディアを出しあい、そのアイディアを批判せず前向きに展開し続けることで、アイディアの連鎖反応や発想の誘発を期待する会議手法です。

しかし、Bluetooth LEに限りませんが、会議方法に工夫をこらして長い時間を費やしても、成果が出ないことがあります。多くの素晴らしいアイディア、それらの検討結果、そして膨大な議事録は残ります。しかし、その結果が事業として実行されず、何もユーザの手に渡らないならば、それは成果が出せなかったことになります。

新規事業を立ち上げる目的は、新たな利益の源泉を得ることです。そのために、これまでにない製品もしくはサービスを考えます。この、考える、がくせものです。企画会議の参加者は、営業、技術開発、製造、ときには経営など、背景知識や立場が様々です。メンバー間で、メンバーの考え方、背景知識、着目している領域を、お互いに確認を取り合える、高い議論の能力が、参加者全員に求められます。

分野をまたぐ協業には、技術でできること/できないことを判別する知識、あるいはBluetooth LEの規格を作る過程ですでに考え尽くされている、利用分野や利用場面の知識の、共有が必要です。技術でできることそれ自体は、誰が考えても、同じものに行き着きます。そのようなものは、自分で考えなくても、知識を持てばよいだけです。

ブレインストーミングは、突飛なアイディアも否定せず前向きに議論を展開していくのが、肝心です。それが会議にならないように、また、議論の焦点だけはあわせることが、主催者の手腕の見せ所です。例えば、ハードウェアの機能を話していて、その大きさに影響する議論がでてきたとします。このとき、大きさは外形デザインに影響するからと、いきなりデザインの話を切り出す人がいたとします。デザインの話に切り替わるのはよいのですが、しかしデザインの話だと節目をつけてメンバー全員の頭を切り替えないと、終わることのない楽しい雑談会の始まりになります。

## まとめ




