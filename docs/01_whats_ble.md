
\putTableofcontents

# Bluetooth low energy の概要とその活用

Bluetooth low energy は、2010年に公開された Bluetooth 4.0 がその規格の一部として統合した超低消費電力無線通信技術です。

Bluetooth low energyは、より高速な通信を追い求めてきた Bluetooth 3.0 では要望があわない、少量のデータを低頻度でやりとりできれば十分だが、電池交換の手間を増やしたくないので消費電力はとても小さくあってほしい利用分野に向けて開発された新技術です。

通信には、必ず通信相手がいなくてはなりません。ですから、新しい通信技術が一般に広く普及するには、その通信相手も同時に普及しなければならないため、通常は長い時間がかかります。ところが、2011年に iOS5を搭載したiPhone4S が Bluetooth4.0 に対応しました。世界に広く普及しているiPhoneが通信相手になったことで、Bluetooth low energy は急速に普及しています。

形あるハードウェアが一般に普及するには、それを製造販売する事業者が登場しなくてはなりません。また、新しい技術を利用した製品を理解して購入してくれる顧客が増えるまでには、通常は長い時間がかかります。ところが、iOS5は Bluetooth low energy デバイスとの通信を、どの iOSアプリケーション からも使えるように開放しました。これにより、多種多様な Bluetooth low energy 製品と対応アプリケーション群が登場して、それが市場を形作っています。

このように、Bluetooth low energy は、その通信相手となる iOS とともに急速にその利用範囲を広げ市場が形作られてきています。

この章は、 Bluetooth low energy の技術概要を述べて、次にこの技術の活用場面や方法の生み出し方を見ていきます。












<!-- 全体の外観を記述する -->

## 規格の生い立ちとその特色

まず規格の生い立ちを通じて、Bluetooth low energyという新しい技術の特色を見ていきます。

世の中が新たな要望を出した時に、その要望に答えられる技術だけが一般に普及していきます。通信には必ず通信相手がいますから、通信技術が普及するには、お互いがお互いに通信しあうために技術を共有すること、つまり規格が不可欠なのです。

### Bluetooth無線技術の変遷

Bluetooth規格は、1998年に設立された非営利の非株式会社 Bluetooth Special Interest Group (SIG), Inc. (Bluetooth SIG)が開発を監督しています [^1009]。

[^1009]:[Bluetooth SIG について https://www.bluetooth.org/ja-jp/members/about-sig-overview](https://www.bluetooth.org/ja-jp/members/about-sig-overview)

Bluetooth SIG は Bluetooth 対応製品の開発、製造、販売はしません。メンバーが協力して革新できるようにして、多種多様な機器を接続するための望ましい無線技術を開発することよって Bluetooth ブランドを強化することを使命としています。

Bluetooth SIGの主な任務は:

- Bluetooth 仕様の公開
- 認証プログラムの管理運営
- Bluetooth 商標の保護
- Bluetooth 無線技術の普及促進

です。

Bluetooth low energy が Bluetooth無線技術 に統合されるまでの変遷を [#fig_BT_history] に示します。

![ #fig_BT_history Bluetooth 無線技術の変遷](fig/ch01_fig010_BT_history.png)

1999年にバージョン1.0の仕様が公開されてから、Bluetooth無線技術はより高い通信速度を目指して、バージョン2.0、3.0と仕様書のバージョンを上げてきました。そして、ヘッドセットやイーサネットなど、それまで有線接続だったものを無線接続に置き換える近接無線通信技術として、広く普及しました。

しかし、身の回りには、例えばキーボードやマウスあるいは心拍計のように、1回にやりとりするデータ量が数バイトで十分で、その通信頻度も30ミリ秒あるいは1秒ごとで十分である製品も数多くあります。そのような利用分野は、高速な通信速度よりも、より小さな電池消費量とより小さな製造費用が求められます。

ノキア・リサーチ・センターは、Bluetooth規格を継承しつつ、より低消費電力で低価格な新しい無線通信技術の開発を2001年にはじめました。この技術は、紆余曲折を経てBluetooth4.0に統合されます [^1010]。
 
[^1010]: [http://en.wikipedia.org/wiki/Bluetooth_low_energy](http://en.wikipedia.org/wiki/Bluetooth_low_energy)

この技術は、2004年にBluetooth Low End Extensionとして公開されました。さらに、EU FP6プロジェクトMIMOSA(Microsystems Platform for Mobile Services and Applications)といった、パートナーと更に開発を進めた後に、この技術はBluetoothとしてではなく、Wibree(ウィブリー)ブランドという独立した規格として2006年10月に公開されました。

一方でBluetooth無線技術は、1999年にバージョン1.0が公開されてから、2007年に Bluetooth 2.1 + EDR (Enhanced Data Rate)そして2009年に Bluetooth 3.0 + HS (High Speed)と、新しい仕様が登場しました。これらの規格は、それまでの通信規格で作られた機器とも通信ができる後方互換性を確保して、新しい規格で作られた機器同士ではより高速な通信ができるものです。

そして、2010年の Bluetooth4.0 で初めて超低消費電力無線通信技術が統合されました。[#fig_BT_history] では、この2つの技術を区別するために Bluetooth3.0 までの技術をクラシックBluetooth (Classic Bluetooth) と表記しています。Bluetooth4.0 は、クラシックBluetooth と、それとは互換性がない Bluetooth low energy という2つの技術をとりこんだ規格と言えます。

### Bluetooth Smart Ready とBluetooth Smart 

Bluetooth無線技術は、無線でデータをやりとりするだけの技術ではなく、無線を通じて機器を利用するための技術です。Bluetooth無線技術に適合した製品には、Bluetooth SIG, Inc.からライセンスの許諾をうけて、Bluetooth商標が使用できます。消費者はこの商標を見て、接続性が確保されていると安心して購入できます。

![ #fig_BT_logo Bluetooth商標](fig/ch01_fig020_BT_logo.png)

Bluetooth商標 [^1020] を[#fig_BT_logo]に示します。Bluetooth商標は、Bluetooth 3.0までは ( [#fig_BT_logo] (a) ) 1つだけでした。

[^1020]: [Bluetooth Smart マークの使用 https://www.bluetooth.org/ja-jp/bluetooth-brand/how-to-use-smart-marks](https://www.bluetooth.org/ja-jp/bluetooth-brand/how-to-use-smart-marks)

Bluetoothコア仕様は改定されてバージョンが上がっても、バージョン3.0までは、それ以前のバージョンの技術との後方互換性を保っていました。新しいバージョンで作られた製品は、すでに広く普及している以前のバージョンで作られた製品とも接続できますし、また新しいバージョンで作られた製品同士では、より高速でよりセキュリティの高い技術が利用できます。ですから、コア仕様のバージョンが上がっても、相互接続を表す商標はそれまでと同じ1つの商標でした。

ですが、クラシックBluetooth と Bluetooth low energy には互換性がないので、すでに市場に普及している Bluetooth3.0 までの機器からは Bluetooth low energy機器に接続できません。これまで保たれていた後方互換性が、初めて一部失われたのです。

このため、Bluetooth 4.0 から、Bluetooth Smart Ready ( [#fig_BT_logo] (b) ) および Bluetooth Smart ( [#fig_BT_logo] (c) ) の2つの商標になりました。

Bluetooth Smart Readyは、クラシックBluetoothとBluetooth low energyの両方を実装した機器に与えられる商標です。このような機器は、2つの機能を持つのでデュアルモードデバイス とも呼ばれます。ヘッドセットなども接続するパソコンや携帯電話などは、Bluetooth Smart Ready機器です。

Bluetooth Smartは、Bluetooth low energyだけを実装した機器に与えられる商標です。Bluetooth low energy のみの機器なので、シングルモードデバイスと呼ばれます。周辺機器は Bluetooth Smart でなければならないことはありません。消費電力を小さくしたい機器には Bluetooth Smart が採用されるでしょうし、高速なデータ通信や音声通信も必要な機器には Bluetooth Smart Ready を採用します。

Bluetooth Smart Ready機器は、Bluetooth 3.0機器を含めた、市場にある全てのBluetooth機器と接続できます。Bluetooth Smart機器は、Blueooth Smart Ready機器または Bluetooth Smart機器と接続できます。

また、Bluetoothコア仕様は、バージョン4.0が登場してからすでにバージョン4.1そしてバージョン4.2と、規格が改定されています。しかし、バージョン4.0以降は後方互換性を保っていますから、例えばBluetoothコア仕様バージョン4.2の Bluetooth Smart機器は、それ以前のバージョン4.0の機器と接続できます。

バージョンにかかわらず後方互換性が保たれていくので、Bluetooth Smart ReadyおよびBluetooth Smartの商標には、コア仕様のバージョン番号は入りません。

### Bluetooth Low Energy の無線通信技術の特徴

Bluetooth low energy は クラシックBluetooth を置き換える技術ではなく、クラシックBluetooth ではカバーしづらい利用分野に向けて開発された技術です。クラシックBluetoothの知識が邪魔になりこの新しい技術を誤解しないように、Bluetooth low energy の特徴を見ていきます。

この技術の特徴は:

- 低頻度、少量データの通信に特化
- 超低消費電力で無線通信しつづけられる

です。

Bluetooth low energy は、低頻度で少量のデータがやりとりできればいいが、必要があればすぐにデータをやりとりしたい分野に特化した技術です。

例えば、心拍センサーならば、2バイトで表せる心拍値を1秒に数回送信できれば十分です。 またテレビのリモコンは、普段は使われることがなく、たまにユーザがボタンが押されます。ですが、 ボタンが押されたら直ちにテレビが反応しなければなりません。

このような機器は、使い手が無線通信を意識しなくてもよくて、必要なときに直ちに無線通信できる技術が求められます。例えば、リモコンのボタンを押せば、すぐに機器が操作できて当たり前です。ですから、リモコンを使う前に、無線通信の開始ボタンを押させたり、あるいは無線通信が電力を消費して毎月電池交換が必要になるようでは、不便で使われません。

Bluetooth low energyは、低頻度かつ少量データがやりとりできればよいという場面に特化させて、不必要な電力消費を削ぎ落した技術です。クラシックBluetoothと比べると消費電力は1/10から1/100にでき、コンビニエンスストアでも売られているような直径2cmのリチウムコイン型電池1つで、1年間ほど無線通信しつづけられます。

超低消費電力にするには、どうしても消費電力が大きくなる無線通信回路を使う時間、つまり電波の送受信をする時間をなるべく短くするほかありません。Bluetooth low energy は、接続した機器同士が正確にタイミングを同期して、コネクション・インターバルと呼ばれる周期ごとに無線通信回路をオンにして、その間にデータをやりとりします。

### プロトコルとプロファイル

Bluetooth無線技術は、無線通信技術を通じて機器やアプリケーションがお互いに機能するための規格です。ですから、多くの無線通信技術が通信技術だけを規定するのとは異なり、Bluetooth無線技術は、通信を通じた機器やアプリケーションの振る舞いも規定します。この無線通信を通じた、データをやりとりする仕様をプロトコル、振る舞いの仕様をプロファイルと呼びます。

Bluetooth low energyは、ジェネリック・アトリビュート・プロファイル(Generic Attribute profile, GATT Profile)という、ものをデータベースとして表現する仕組みがあります。すべての機器のプロファイル、つまりふるまいは、このGATTプロファイルを使い作られます。

Bluetooth Smart機器では、GATTプロファイルをベースにして、任意のプロファイルが設計できます [^1030]。これをカスタム・プロファイルと呼びます。しかし、体重計や心拍センサーのような一般的な機器では、メーカーごとにばらばらのプロファイルではなく、1つのプロファイルに統一されることが必要です。そのようなものには、メーカーなどが提出したプロファイルをBluetooth SIGが承認することで、採択済みBluetoothプロファイルにすることができます。

[^1030]:[​Bluetooth Interoperability and Profiles https://developer.bluetooth.org/DevelopmentResources/Pages/Custom-Profile-Development.aspx](https://developer.bluetooth.org/DevelopmentResources/Pages/Custom-Profile-Development.aspx)

カスタム・プロファイルにより、オリジナルの多種多様なBluetooth Smart機器をすばやく製品化することができます。そして、
一般的な機器は、採択済みBluetoothプロファイルに従うことで、どのアプリケーションからも利用ができる製品として、市場に流通させることができます。

### カスタム・プロファイルとアプセサリ

カスタムプロファイルのBluetooth Smart機器と接続するiOSアプリケーションの構成を [#fig_app_and_device] に示します。

任意の設計が許されるカスタム・プロファイルに、iOSが対応することは不可能です。また、パソコンとは異なりiOSでは、ユーザがインストールできるのはアプリケーションだけで、任意のデバイス・ドライバをインストールすることはできません。

そこで、iOSはアプリケーションに、CoreBluetoothフレームワークを通じて、アプリケーションからBluetooth Smart機器の探索と発見、接続と切断そしてGATTサーバへのアクセスを提供しています。アプリケーションに、デバイス・ドライバに相当する処理部分を持たせることで、カスタム・プロファイルに対応できます。

![ #fig_app_and_device Bluetooth Smart機器と接続するアプリケーション](fig/ch01_fig030_app_and_device.png)

CoreBluetoothフレームワークは、GATTベースプロファイルをアプリケーションに提供するので、iOSアプリケーションからは、Bluetooth Smart機器がGATTサーバというデータベースに見えます。アプリケーションからは、Bluetooth low energyのパケットのやりとりや無線通信は隠蔽されます。

Bluetooth Smart機器とのやりとりは、その機器のGATTデータベースへのアクセスで行われます。データベースの値は、機種が製造された時に書き込まれる機種名のような固定値、機器のセンサーが検出した外界や機器内部の物理値や物理値から計算された値、そしてエアコンの設定温度や運転状態のような制御目標値や動作指示値などの意味をもちます。例えば [#fig_app_and_device] の心拍センサーのGATTサーバには、胸や手首などのセンサーの設置位置や、刻一刻と変化する測定された心拍値が記録されています。

次々と登場する新しいBluetooth Smart機器には、キーボードのような従来からある周辺機器と異なり、iOSアプリケーションと連携して初めて価値を感じる機器が登場してきています。そのような、アプリケーション(Application)とアクセサリ(Accessory)が渾然一体となったものは、2つの単語を組み合わせたアプセサリ(Appcessory)という造語で呼ばれます。

### スマートフォンでのBluetooth low energy体験

Bluetooth low energy は、スマートフォンという新しい通信相手とアプセサリという新しい分野を見つけたことで、急速にその利用が広まっています。その体験は、クラシックBluetoothそして通信相手がパソコンであった頃の体験とは異なります。過去の体験は知識としていかしつつ、今ある新しい技術と過去にはなかったスマートフォンという周囲環境をふまえた、柔らかい発想が重要です。

Bluetooth low energyには、クラシックBluetoothにはなかった体験が作れます。ビーコンのような無線接続をしない利用場面も登場しています。クラシックBluetoothと同じように無線接続をする利用場面でも、細かい体験が異なります。

例えば、クラシックBluetoothでは、新しい機器に接続するときには必ずペアリングという、ユーザへの接続確認が必要でした。ですが、Bluetooth Smart機器では設計次第で、ペアリングなしにすぐに接続することも、あるいはペアリングをして高度なセキュリティーやプライバシー保護の機能を活用することもできます。

例えば、公共施設のフィットネス機器を自分のスマートフォンに接続して、一時的に利用したいだけならば、一手間かかるペアリングは不要に思うでしょう。周囲にいればお互いが見えるのですから、運動データを保護する必要もないでしょう。しかし、自宅にある自分が所有するフィットネス機器であれば、運動データが誰かに盗聴されては嫌ですから、ペアリングをして強固なセキュリティー機能でデータを保護したくなるでしょう。

逆に、クラシックBluetoothでの体験はそのままBluetooth low energyでも実現できるとは限りません。

例えば、Bluetooth low energy は、大きなデータファイルのやりとりには適しません。GATTベースのアーキテクチャでの実効通信速度は60kビット/秒程度と、クラシックBluetoothでの実効通信速度に比べて1桁から2桁小さいものです。Bluetooth Smart機器のファームウェア更新であれば100キロバイト程度ですから15秒程度で送信できます。しかし、iPhoneで撮影した写真ファイル・サイズは2メガバイトを超えていますから、1枚を送信するだけで6分間かかります。

また、Bluetooth low energy には、音声をやりとりする仕様はありません。しかし、ウエアラブル機器では、例えば着信電話にすぐでられるように、常に使うわけではないがたまに音声通話は使いたい場面は多くあります。将来には、そのような機能が規格に取り込まれていくかもしれません。

### Bluetooth無線技術のこれから

Bluetooth無線技術は、スマートフォンと目に見える範囲にある多種多様な機器とを接続する技術として、広く普及しました。そしていま、身の回りにあるものやものごとがネットワークにつながることで、新しいさらに便利な世界が作れるのではないかと話題になっています。その新しい時代に向けて、Bluetooth無線技術は、新しい技術や利用方法を急速に採用してきています。

これまでも、Bluetooth Smart機器の利用場面をより便利により広げるために、強力なセキュリティ技術が取り込まれてきました。今後も要望にあわせて、例えば無線通信速度の高速化や音声通信など、求められる新しい技術を規格に取り込むでしょう。

さらに、家電が連携するスマートホームなどが求める、Bluetooth Smrt機器群がパケットを中継しあい自律的にネットワークを構築する技術もはいってくるでしょう。さらに、インターネットとものとものごとをつなぐために、スマートフォンを介さずに、Bluetooth Smart機器からインターネットに接続したり、逆にインターネットからBluetooth Smart機器に接続する技術も取り込まれていくでしょう。

このような急速な新しい技術の取り込みは、通常はその採用機器の一般販売を阻害します。その規格を採用した機器を開発しても、一般販売を開始する頃には新しい規格が登場して使えなくなると消費者に思われると、機器を買ってもらえないからです。

Bluetooth無線技術の半導体は、それを見越して、ファームウェアを無線で更新できる機能を入れて、今後登場する新しい技術に対応できるように設計されています。Bluetooth無線技術は、これまで後方互換性を保持して市場にあるあらゆる機器との相互接続を確保してきた実績があります。

これから、いくつもの超低消費電力無線技術の規格が、家庭や職場で利用してもらおうと登場してきます。それらの中でも、Bluetooth無線技術は、強力なブランドを作り上げていくと思われます。



















<!-- リンク層の話をここにまとめる -->

## Bluetooth low energy の無線通信技術

通信は一人では成り立ちません。必ず同じ手順でやりとりする相手がいなくては成り立ちません。そのお互いとお互いのやりとりの手順を提供するものが通信規格です。通信規格の多くは、規格適合の認証制度が運用されています。その認証制度があるから、異なる製造会社が出荷した製品間の無線通信が実現されます。

無線通信技術は、無線通信やパケット通信などの高度な技術をいくつも組み合わせて初めて実現できます。しかし、規格適合している無線通信モジュールや、ソフトウェア開発を容易にするiOSのフレームワークを使うならば、それらの技術の詳細を知らなくても開発ができます。

たしかに、目的がはっきりした開発であれば、提供される無線モジュールなどの利用手順に従うだけでよく、その内部にある技術詳細を知る必要はありません。

しかし、目的もはっきりしない実現可能性を自分で判断しなければならない場面であれば、その内部にある技術がどのような性質であり、どう活用できるのかを知る必要があります。

Bluetooth low energyの無線通信技術は、その最大の特徴である超低消費電力がどのように実現されているかは、知るだけでも単純にたのしいものですし、またその知識が多種多様の利用場面を考えだす基礎力にもなります。

ここでは、Bleutooth low energyという通信技術が、どのような性質をもっているのか、またどのような工夫や考え方で作られているのかを見ていきます。

### 無線通信を会話に例えると

Bluetooth Smart機器が送受信している電波は人間の目や耳では捉えられません。しかし、それらの機器間の無線通信の様子は、人間が目を閉じて音声だけで周囲と会話している状態だと思えば、容易に想像ができます。人間は、外部からの情報のほとんどを視覚から得ています。ですから、目を閉じて聴覚だけの状況を想像することが重要です。

声と聴覚のそれぞれを使う使わないの組み合わせから、次の4つの使い方がでてきます:

1. 話さないし聞かない
2. 話すだけ
3. 聞くだけ
4. 話すし、聞く

話すだけでも、周囲に自分の存在を知らせることができます。聞くだけでも、周囲に誰がいるかを知ることができます。

Bluetooth low energyの通信は、周囲に自分の存在を知らせること、そして周囲に誰がいるかを知ることから始まります。お互いにお互いの存在を検出して初めて、3つめのお互いのやりとりを開始できます。

お互いに会話をするには、 相手に自分の声が聞こえること、そして相手の声が自分に聞こえることが必要です。

声の大きさは、電波の送信電力に相当します。大きな声をだすほど、より遠くまで伝わります。そして、耳の感度が高いほど、また周囲が静かなほど、遠いところで発せられたより小さな声が聞き取れます。耳の感度は電波のアンテナや半導体の性能に、周囲の静かさは電子レンジやWi-Fiなどの周囲にある電波を発信している機器に対応します。

通信が成り立つには、お互いの声がお互いに聞こえる必要があります。声は大きいけれども耳の感度が低いと、相手には声が届くけれども、相手の声が聞こえないかもしれません。また声が小さくても耳の感度が高ければ、その逆になります。いずれにしても、通信は成り立ちません。

お互いに会話をするには、さらに次の条件が必要です:

- 話すタイミングと聞くタイミングが合うこと
- 話している内容がお互いに理解できること

ここでは、自分が話している間は自分の声が邪魔になり、相手の声が聞こえないとしましょう。そうすると、お互いに話すタイミングと聞くタイミングをあわせなくてはいけません。また、日本語しかわからない人が英語を聞いても理解できないように、相手が話した内容を自分が理解できなければなりません。

この目を閉じた状態での会話の様子は、Bluetooth Smart機器どうしが通信する様子そのままです。これらの基本的なやりとりをまとめる仕様が、Bleutooth無線技術ではBluetoothコア仕様と呼ばれます。

声も電波も、周囲に広がるものなので、誰かがじっと耳をすましているかもしれません。またやりとりのタイミングに合わせて、誰か知らない人が電波を送信して不正に情報を読み出したり、書き込んだりしようとするかもしれません。ですから、この普段の会話の場面からは気づきにくいのですが、無線技術には、強固なセキュリティとプライバシーの保護が求められます。

それでは、この会話のたとえから、具体的な数字を交えて、Bluetooth low energyの技術の詳細を見てみます。

### Bluetooth low energyが使う2.4GHzの電波

Bluetooth無線技術は、周波数が2.4GHzの電磁波を使います。Hz(ヘルツ)は周波数の単位で、1Hzは1秒あたり1回の振動です。G(ギガ)は、 $ 1 * 10^9 $ を表す接頭辞です。ですから1ギガは10億を意味します。2.4GHzは、1秒間に24億回振動するという意味です。

電波は公共の財産です。国が、利用目的ごとに周波数を割り当てて、事業者に免許を発行して管理運営しています。この2.4GHz帯という周波数帯は、水が強く吸収する周波数なので、電子レンジのように電波を無線通信以外の産業・科学・医療に高周波エネルギー源として利用するための周波数帯に割り当てられていました。

このように、もともと2.4GHz帯は通信に使われる周波数帯ではありませんでした。しかし、半導体技術が発達して2.4GHz帯の高周波が扱えるようになると、世界各国で共通して利用できる周波数帯として、通信に利用が割り当てられました。そして現在は、無線LANやBluetooth無線技術などの、いくつもの高度なデータ通信が利用する、世界各国で広く一般で通信に使われる周波数帯になりました。

電磁波が真空中を伝わる速さ、つまり光速は $ 3 * 10^8  メートル/秒 $ ですから、2.4GHzの電磁波の波長は12.5 センチメートルです。電波を送受信するアンテナの大きさは、ほぼ波長に比例します。波長がこれくらい小さいと、アンテナが小型機器に十分収まる大きさにでき携帯機器に都合がよい周波数帯です。

また高周波信号を処理するには高速の半導体素子が必要です。身の回りにあるパソコンや携帯機器のプロセッサーの動作クロックが2GHzに達しているように、現在の半導体技術は、2.4GHzの高周波信号を扱う半導体素子を安価に大量に製造できます。

電波は波の性質を持っています。お風呂で手でお湯を押すと波が伝わっていきますが、電波もこの波と同じように空間を伝わっていきます。波は、何かにぶつかると反射したり吸収されたりします。またお風呂で2つの波をぶつけると、水面にいろいろな強弱の高さが現れるように、干渉して強め合う領域と弱め合う領域が生じます。

Bluetooth無線規格は最低受信感度と、電波の送信電力の最大最小値を規格で規定しています。送信側と受信側がお互いに見える状態で、大地を含めて電波を反射したり吸収するものが周りに何もない状態で、送信電力を最大にした時の通信距離は50メートルくらいです。

Bluetooth low energyを、相対位置や近接の検出に利用する場面では、この受信信号の強弱が目に見えてきます。

受信側は、受信信号の強さだけからビーコンまでの距離を推定します。ですがビーコンの周囲には、壁や大地などの電波を反射したり吸収するものがあり、反射した電波が強め合ったり弱めあったりしている場所があったりして、ビーコンまでの距離と受信信号の強弱の関係は、単純なものではなくなります。

また電子レンジに使われるほど、水は2.4GHz帯の電波をよく吸収します。人体のほとんどは水ですから、ビーコンと受信側の間に人が出入りすると、受信信号強度は桁違いに変化することもあります。
受信信号強度に影響するものが建物などの周囲環境だけならば、ビーコン設置時に信号強度分布を計測しておいて補正することもできるかもしれません。しかし、人のような刻一刻と変化するものも影響をあたえます。

この電波の性質があるため、ビーコンとの距離の推定値は、メートル単位の値ではなく、とても近い、近い、遠いといった3段階の距離区分で与える使われ方をします。

### 超低消費電力無線通信の技術

超低消費電力無線通信技術は、2.4GHzという高周波信号を扱う送受信回路をオンにする時間を極限まで小さくするための工夫の集まりです。

Bluetooth low energyのパケット通信を [#fig_low_energy_packet] に示します。図の横線は時間軸を示します。時間は左から右に流れていきます。グレーの四角は、送信回路が動いている期間を示します。網目の四角は、受信回路が動いている期間を示します。

高周波回路の消費電力は、直感的には外部に電波を創出する送信回路が大きいと思えるかもしれません。しかし実際の半導体回路では、むしろ受信回路のほうが送信時よりもすこし大きくなります。ですから、[#fig_low_energy_packet] の消費電力は、四角の横幅で示されるパケットの送受信時間で与えられます。

![ #fig_low_energy_packet Bluetooth low energyのパケットのやりとり](fig/ch01_fig040_packet.png)

Bluetooth low energyは、送信している電波の周波数をほんの少し高くしたり低くしたりして0と1のビット・データを送信します。そのビット・データのひとかたまりをパケットと呼びます。

無線通信では、他の無線機の信号に邪魔されたり受信信号強度が弱くて、ビットの0と1が間違えて受信されることはよくあります。ですから、パケットには、送信したいデータに加えて、そのデータが正しいかを確認できる検査用のデータが入っています。受信したパケットを検査して、受信データに誤りがあると分かったならば、そのパケットを再度送信してもらうことを繰り返すことで、誤りのないデータのやりとりができるのです。

機器の発見でのパケットのやりとりが、 [#fig_low_energy_packet] (a) です。機器情報を表すアドバタイジング・パケットと呼ばれるパケットを、アドバタイジング・インターバルという期間ごとに送信する役割を、アドバタイザと呼びます。アドバタイザを発見する役割をスキャナと呼びます。

Bluetooth low energyは、一方がより消費電力が小さくなるように非対称に設計されています。[#fig_low_energy_packet] (a) の四角の大きさをみると、いつ来るかわからないアドバタイジング・パケットを検出するスキャナのほうが、アドバタイザよりも消費電力が大きいとわかります。

[#fig_low_energy_packet] (a) は模式図なので、四角の大きさが実際の通信の送受信時間を表していないことに注意してください。Bluetooth low energyの1つのパケットは最大376マイクロ秒です。1マイクロ秒は100万分の1秒です。ですから、アドバタイジング・パケットの幅は最大366マイクロ秒です。その一方で、スキャンはアドバタイジング・インターバル程度の期間なので、数秒程度になることもあります。

通常は、消費電力の大きなスキャナの役割をiOSデバイスに、アドバタイザの役割を周辺機器に割り当てます。iOSデバイスは、充電式の大容量電池があるので、消費電力の大きな役割はiOSデバイスに担わせます。また、この役割の割り当てだと、ユーザはスキャナであるiOSデバイスから周辺機器を探すので、自然な利用場面になります。

アドバタイジング・インターバルは、スキャナが機器を発見するのにかかる時間になります。この時間が短いほど、発見が早くなりますが、アドバタイザの消費電力が増えます。消費電力と使いやすさの兼ね合いをどうするかは、周辺機器の設計によります。

Apple社はiOSデバイスと接続するBluetooth Smart機器の設計ガイドライン [^1110] を公開しています。ここでは、アドバタイジング・インターバルを、最初の30秒間は20ミリ秒に、30秒後からは150ミリ秒から1.3秒の範囲の値として、最初は発見しやすく、その後は消費電力を抑える設定を推奨しています。1ミリ秒は、1000分の1秒です。

[^1110]:[Bluetooth for Developers - APple Developer https://developer.apple.com/bluetooth/](https://developer.apple.com/bluetooth/)

機器を発見すると、接続処理を行いお互いにパケットをやりとりし続ける接続状態になります ([#fig_low_energy_packet] (b) )。パケットのやりとりを管理する役割をマスター、マスターに応答してパケットを返す役割をスレーブと呼びます。スキャナがマスターに、アドバタイザがスレーブに、役割を切り替えます。

マスターはコネクション・インターバルという期間ごとに、スレーブにパケットを送信します。マスターとスレーブは接続時にお互いの時計を同期しているので、スレーブはマスターがパケットを送信してくる時間だけ受信回路をオンにしてパケットを受信して、マスターにパケットを返します。

お互いにやりとりするデータがある限り、このパケットのやりとりが続きます。やりとりするデータがなくなれば、パケットのやりとりは終了して、次のコネクション・インターバルまで、マスターもスレーブも高周波回路をオフにしたままになります。これが超低消費電力の工夫です。設計ガイドライン [^1040]は、コネクション・インターバルを20ミリ秒から2秒の範囲を推奨しています。

### Bluetooth low energyのピコネット

[#fig_piconet Bluetooth] に示すように、Bluetooth low energyの機器はパケットを使い情報をやりとりする、つまりネットワークを形作ります。図の丸で囲まれたアルファベットは、機器それぞれを示します。矢印は機器の接続を示し、矢印の向きはマスターからスレーブを示します。

![ #fig_piconet Bluetooth low energyのピコネット](fig/ch01_fig050_piconet.png)

無線通信技術には、ある機器が送信したパケットを別の機器が中継をして、機器を束ねた1つの大きなネットワークを作る技術を提供するものがあります。しかし、Bluetooth無線技術は、目の前にある機器と直接無線で接続する技術で、このようなパケットの中継機能はありません。そのため、Bluetooth無線技術が作るネットワークは、直接電波が届く範囲に限られた小さなネットワークになります。

ピコネットは、Bluetooth無線技術の造語で、イタリア語で小さいを意味するpiccoloからとられた、SI単位系で $ 10^-{12} $ を表す接頭辞ピコとネットワークをつないだ、この小さなネットワークを意味する言葉です。

[#fig_piconet Bluetooth] (a)は、スキャナとアドバタイザが作るピコネットです。アドバタイザの送信したパケットは、その周囲にある複数のスキャナに届きます。機器の発見やビーコンに使われます。

[#fig_piconet Bluetooth] (b)は、接続しているマスターとスレーブがつくるピコネットです。マスターDは、スレーブCとスレーブEの2つのスレーブにそれぞれ接続しています。スレーブCとスレーブCからはマスターDが見えるだけで、スレーブはお互いの存在を知ることはありません。

クラシックBluetoothでは、1つのマスターと同時に接続できるスレーブの数は7つまでです。Bluetooth low energyでは、およそ $ 2^{31} $ (約21億)です。ですから、マスターに同時接続できるスレーブの上限数は、規格ではなくハードウェアなどの制約で決まります。

Bluetooth 4.0 の Bluetooth low energy では、[#fig_piconet Bluetooth] (b)のような、1つのマスターに複数のスレーブが接続するネットワークだけが許されていました。

このネットワークはマウスやキーボードを接続するにはよいのですが、例えば家族で利用するリビングのエアコンでは、ある1台のiPhoneと接続すると他のiPadやiPhoneからは接続ができませんから、とても不便です。

そこで、Bluetooth4.1からは[#fig_piconet Bluetooth] (c)のように、マスターが同時にスレーブになること、またスレーブが同時にマスターになること、さらにはマスターおよびスレーブは同時にアドバタイザになることが許されました。さらに、スレーブは同時に複数のマスターと接続してもよくなりました。

### スループットとレイテンシー

スループットとレイテンシーの2つの値は、通信の性能を表す重要な値です。スループットは1秒あたりに届けられるデータ量を、レイテンシーは今届けようとしたデータが実際に相手に届くまでにかかる時間です。レイテンシーは日本語で遅れ時間と言います。

原理的には、スループットはコネクション・インターバルによらないはずです。マスターとスレーブは、コネクション・インターバルごとに通信を開始して、やりとりすべきデータがあるかぎりパケットを交換し続けます ([#fig_low_energy_packet] (b) )。実際には、送信データを作る時間が必要になると、その時点でパケットのやりとりが終了して、次のコネクション・インターバルまで待つことになるので、スループットとコネクション・インターバルの関係は実装によります。

レイテンシーはコネクション・インターバル程度になります。例えばキーが押された情報を送信しようとすれば、それが実際に送信されるのは次のコネクション・インターバル以降です  ([#fig_low_energy_packet] (b) )。

コネクション・インターバルが短いほどレイテンシーは短くなりますが、パケットをやりとりする回数が増えますから無線通信の消費電力も増えます。求められるレイテンシーと消費電力の兼ね合いから、コネクション・インターバルを適切な値に設定します。

パソコンのキーボードは、人間が画面を見ながらキーをタイプするので、押された結果はすぐ画面に表示されなければなりません。画面表示更新レートが60 フレーム/秒であれば、1フレームの表示時間は 17 ミリ秒 です。Bluetooth Smart機器の設計ガイドライン [^1040] は、普通のBluetooth Smart機器はコネクション・インターバルに20ミリ秒以上を推奨していますが、キーボードなどの入力装置は 11.25 ミリ秒まで受け入れるとあります。

コネクション・インターバルをはじめとするコネクション・パラメータは、接続中に更新できます。待機状態では長いコネクション・インターバルにして電力を節約して、動作を開始したならばコネクション・インターバルを小さくして必要な機能を提供する機器が設計できます。

### 無線通信の混信対策と共存の技術

Bluetooth無線技術が使う2.4GHz帯は、電子レンジや無線LANなど、いくつもの電磁波を利用する機器がひしめき合う周波数帯です。ですから、電子レンジからの漏洩電波が妨害となり通信ができなくなったり、他の無線通信機器の通信に影響を与えたりしないように、共存するための技術が必要です。

共存するための工夫の1つが、空中線電力の上限設定です。送信回路がアンテナに出力する電力の大きさを空中線電力または出力電力と呼びます。空中線はアンテナの日本語表記です。電波はアンテナから四方八方に広がっていきますから、混信したり妨害になったりしないように、空中線電力は国ごとの技術基準で上限が規定されています。

Bluetooth low energyの規格は、空中線電力を最大10ミリワットとしています。日本の技術認定基準では、Bluetooth が採用している周波数ホッピング方式は 3 ミリワット/MHz を上限としています。Bluetooth low energyの周波数帯域は1MHzなので、日本での空中線電力は 3 ミリワット (4 dBm) が上限になります。

接続したBluetooth Smart機器は、コネクション・インターバルごとに通信に使う周波数を切り替えていく、適応周波数ホッピング方式を採用しています。もしも他の機器が使っていたりして、ある周波数では通信ができなくても、次のコネクション・インターバルで切り替えた違う周波数であれば、通信ができるかもしれません。

Bluetooth low energyは、2.4 GHz から 2.4835 GHz の 83.5 MHz の周波数幅を2 MHz 幅の40のチャンネルに分割して、チャネルを切り替えて通信します。

この周波数帯とチャンネルの関係は、ピアノの鍵盤に例えることができます。ずらっと並んだ鍵盤が周波数帯を表します。左から右に、周波数が低い方(低音)から高い方(高音)に鍵盤が並んでいます。鍵盤は1つのチャンネルに相当します。鍵盤を押せば、特定の周波数の信号(音)が出力されます。

1つのチャンネルでの通信は、例えばドの鍵盤の音を、ほんの僅か音色を変化させてデジタル・データを送信しているようなものです。他の機器が隣接するチャンネル、この例でいえばドの鍵盤の両隣にあるシやレの音、で通信をしていても、ドのあたりの音だけを通してシやレの音は通さないフィルタリングする信号処理を使えば、目的の信号だけを取り出せます。

コネクション・インターバルごとに違うチャネルつまり周波数にホッピングしていくので、周波数ホッピング方式と呼ばれます。

また、すぐ近くに無線LANなどがあって、通信に使えないチャンネルが事前にわかる場合があります。Bluetooth Smart機器は、状況に応じて通信に使えないチャンネルを指定できます。周囲の状況に適応していくので、これを適応周波数ホッピング方式と呼びます。















<!-- データ表現 -->

## Bluetooth low energy のデータ表現

Bluetooth low energyは、多種多様なものに向けた無線通信技術です。ですから、この規格は、今はまだない機器が新しく登場しても、それらが相互に接続して利用できる仕組みを提供しなければなりません。

クラシックBluetoothは、これまでの有線接続を無線接続で置き換えるための技術だと言えます。

クラシックBluetoothは、利用場面が規格で決められています。通信とデータ表現仕様を1つの組にして、利用場面ごとに適したものとなるように、決めています。例えば、同じオーディオ・データを送る機器でも、通話に使うヘッドセットには音声品質よりも小さい遅延時間が重要であり、音楽鑑賞に使うヘッドフォンでは、遅延時間よりも高品質な音が求められます。

Bluetooth low energyは、多種多様なもののための無線通信規格です。無線通信から、多種多様なものを見ると、それはデータの塊に見えます。そこで、Bluetooth low energyは、ものを表現するために、サービスとキャラクタリスで構成されるデータベースとそのデータ同期の仕組みを提供しています。

Bluetooth low energyの、このデータベースの仕組みは、スマートフォンのアプリケーション開発にも影響しています。

アプリケーションからクラシックBluetooth対応機器を見ると、音声データの入出力端子や、任意の通信データの入出力端子など、通信ソケットに見えます。ですが、アプリケーションから見たBluetooth low energy対応機器は、データベースに見えます。

この節では、この多様性を実現している要となる、Bluetooth low energyのデータ表現を見ていきます。

### サービスとキャラクタリス

無線通信から"もの"をみると、それは情報の塊、つまりデータベースとして認識できます。スマートフォンのアプリケーションから、Bluetooth low energy で接続した機器をみると、サービスとキャラクタリスというデータの集合体に見えます。

Bluetooth low energy のサービスとキャラクタリスは、ものをデータベースとして表現する仕組みです。

サービスは、キャラクタリスの集合です。キャラクタリスは、値を格納するものを表します。キャラクタリスは、読み出し、書き出し、そして値の変更の接続先への通知の3つの属性が設定できます。キャラクタリスには最大TBD 512バイトまでのバイナリ・データを格納できます。

キャラクタリスの値は、外部センサー、内部状態、および制御目標のいずれか3つの意味をもちます。例えば、室内照明であれば、室内気温という外部センサーの値、コンプレッサーの動作状況やファンの回転数といった内部状態、および設定温度という制御目標があるでしょう。

サービスとキャラクタリスには、その種類を表す UUID という 128 ビットの識別子が設定れています。UUIDの値とその意味は事前に定義されているので、接続したスマートフォンのアプリケーションは、UUIDの値でそれがどのようなものなのかを判別できます。

iOSアプリケーション開発者ならば Objective-C でいう、クラスのインスタンスがサービスに、プロパティがキャラクタリスに対応していると理解できます。プロパティには、読み書き属性があります。またキー値監視( Key-Value Observing ) [^1130] でプロパティの値変化の通知が受け取れるのと同じく、キャラクタリスに監視登録をすれば、その値変化の通知を受け取れます。

[^1210]: [Introduction to Key-Value Observing Programming Guide]( https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/KeyValueObserving/KeyValueObserving.html )

サービスとキャラクタリスの検索と取得、そしてキャラクタリスへの値の読み書きと値変化の通知取得の仕組みは、通信路の上にある アトリビュート・プロトコル(Attribute Protocol、ATT) と Generic Attribute Profile(ジェネリック アトリビュート プロファイル、GATT) の2つの層です。

Bluetooth low energy を搭載する周辺機器のファームウェア、つまり周辺機器に内蔵されているアプリケーションの開発は、この2つの層の上に実装します。つまり、データベースとして抽象化された層で開発します。これは、通信路に流れるバイナリ・データの流れを直接扱う通常よくある無線通信機器のアプリケーション開発と異なる点です。

### もののデータベース表現

Bluetooth low energy は、ものを、これ以上分割できない最小の機能の集合として見ます。

機器は、その最小単位の機能に対応する種類のサービスの集合体となります。機器が同じ機能のハードウェアを複数持っていれば、その種類のサービスを複数持ちます。例えば、温度センサーは1つのサービスにできます。室内エアコンが、室外温度と室内温度それぞれの温度センサーをもっているなら、それぞれの温度センサーに対応する2つのサービスを持ちます。

もしも最小の機能ではなく、機器の見た目そのままを分割単位とするとどうなるのでしょうか。

例えば、赤外線リモコンがある照明機器の、Bluetooth low energy 搭載にした新製品を開発するとします。赤外線リモコンの受信回路を、Bluetooth low energyの無線回路で置き換えて、赤外線リモコンはスマートフォンのアプリケーションで提供するとします。

ちょうどリモコンを1つのサービスとみたてて、そこに赤外線リモコンのボタン1つ1つに対応するキャラクタリスを入れたとします。このやり方でも、1アプリケーションに1機種が対応するだけなら、うまくいきます。

しかし、2機種3機種と対応機種が増えていくと、新機種ごとに機器内部の受信回路とスマートフォンのアプリケーションとを開発しなくてはなりません。これでは、開発にかかる費用も時間も大きくなります。

ここで、機器の最小機能単位で設計すればどうなるでしょうか。

例えば、照明機器であれば、どの機種にも共通する基本機能、電源のオン・オフ、明るさ調整および色合い調整などを1つのサービスにしたとします。この設計であれば、開発した機器とスマートフォンのアプリケーションは、今後発売されるものも含めた全ての照明の基本機能に対応できます。

また、上位機種に、例えば映画鑑賞時の照明機能のような、それまでなかった新機能を追加したとします。これは、基本機能とは独立した機能なので、この心機能を1つのサービスとして追加します。こうすると、基本機能のソフトウェアのソースコードは、そのまま再利用して、追加したサービスに対応するソースコードのみを新規開発することで、上位機種に対応するアプリケーションが開発できます。

このように、お互いに独立した最小単位機能をサービスに対応させることで、ソースコードの再利用をはじめとした利点が生じます。

### データベースとしてのものの表現

ものを Bluetooth low energy から見ると、それは最小の機能の集合を表すデータベースでしかありません。Bluetooth low energy は、最小の機能単位とその組み合わせで、多種多様なものを表します。

例えば、身の回りには多種多様の照明機器があります。天井や机そして床に設置されるシーリング・ライトやテーブル・ライトそしてフロア・スタンド、また外観デザインも1つ1つ異なります。人間には多種多様に見えますが、しかし、その機能はどれも照明機器です。ですから、Bluetooth low energy から見れば、いずれも照明機器の基本機能を表す1つのサービスでしかありません。

また、懐中電灯は電池を内蔵した照明機器です。これは電池残量などの基本機能をあらわすサービスと、照明基本機能のサービスの、2つのサービスの組み合わせで表現できます。このように照明機能もある機器でも、機能に対応するサービスの組み合わせとして表現ができます。

またサービスは、新しい機能が必要となった時に、従来のサービスはそのままに新しいサービスに拡張する仕組みがあります。これは、オブジェクト指向のクラス継承に相当します。

例えば、人を検出して自動点灯する照明機器が登場して、それを照明基本機能に追加したいとします。この場合は、従来のサービスに人体検出を表すキャラクタリスティクスを追加した新しいサービスを定義して対応できます。

新しいサービスの定義でできることは、従来サービスにキャラクタリスを追加することだけで、キャラクタリスを削除することはできません。また、すでにあるキャラクタリスの値の意味を変えることもできません。ですから、新しいサービスは、その追加されたキャラクタリスを無視すれば、従来サービスとして扱うことができます。

このように、Blueooth Low Energyの、ものを表現するデータベースは、多様性と将来の拡張性そして後方互換性を保てるようになっています。

多様性は、サービスの組み合わせの掛け算で実現できます。将来の拡張性は、サービスの拡張で対応できます。また新しいサービスはその元となったサービスとして扱えるので、その新しいサービスに対応していないアプリケーションでも従来機能を同じように利用し続けることができます。つまり、後方互換性が自動的に保たれます。

### サービスとプロファイル

Bluetoothは、Bluetooth で機器と通信したときの振る舞いと、その使われ方の定義とをプロファイルと呼びます。プロファイルの定義のなかで、機器の機能を表すサービスも定義されます。

簡単にいえば、サービスの定義までが機器単体の機能を定義します。プロファイルは、スマートフォンのアプリケーションとその機器とが、お互いにどう振る舞うのかを定義します。プロファイルの定義は、Bluetoothの相互接続を確保するための仕組みです。

サービスが最小単位の機能を表していたように、プロファイルも最小単位の使い方を定義します。たいていの製品は、複数のプロファイルを持ちます。

鍵の置き忘れ防止に Bluetooth low energy がよく使われている、キー・フォブ (key fob) と呼ばれる鍵に取り付けるアクセサリを例に、kのプロファイルとサービスの組み合わせの実例を見てみます。

スマートフォンとキーホルダーとは、無線接続して使います。鍵もしくはスマートフォンのどちらかを置き忘れると、距離が離れて電波強度が下がるか通信が切断します。この時に警告を出力して、置き忘れを防止します。また、鍵もしくはスマートフォンのどちらかが見つからない時は、ボタンを押して接続先の機器から音を出させることができます。

このキーホルダーには、Proximity Profile (プロクシミティ・プロファイル) [^1140] と Find Me Profile (ファインド・ミー・プロファイル) [^1150] の2つのプロファイルが実装されます。

Proximity Profile は、ある一定距離離れた時にキーホルダーから警告を出力する振る舞いを定義します。 Find Me Profile は、ボタンが押された時に接続先から警告を出力させる振る舞いを定義します。つまり、製品の2つの機能がそれぞれプロファイルとして定義されているわけです。

[^1220]: [Proximity Profile (PXP), https://developer.bluetooth.org/TechnologyOverview/Pages/PXP.aspx](https://developer.bluetooth.org/TechnologyOverview/Pages/PXP.aspx)

[^1230]: [Find Me Profile (FMP), https://developer.bluetooth.org/TechnologyOverview/Pages/FMP.aspx](https://developer.bluetooth.org/TechnologyOverview/Pages/FMP.aspx)

プロファイルは、1つのサービスを共有して利用できます。例えば、さきほどの Proximity Profile と Find Me Profile は、いずれも Immediate Alert Servide (イミディエイト・アラート・サービス)  [^1160] を使います。

[^1240]: [Immediate Alert Service https://developer.bluetooth.org/gatt/services/Pages/ServiceViewer.aspx?u=org.bluetooth.service.immediate_alert.xml](https://developer.bluetooth.org/gatt/services/Pages/ServiceViewer.aspx?u=org.bluetooth.service.immediate_alert.xml)

イミディエイト・アラート・サービスは、警告音を出す機能です。Proximity Profile では、置き忘れの警告レベルの設定に使われます。Find Me Profile では、直ちに警告を出力するために使われます。2つのプロファイルが1つのサービスを共有しても、使い方に不都合を生じない問題ありません。

### カスタム・プロファイルとプロファイルの標準化

Bluetooth low energy は、自由にプロファイルを設定できます。これをカスタム・プロファイルと呼びます。カスタム・プロファイルに必要なサービスやキャラクタリスも自由に設定ができます。

サービスやキャラクタリスは、UUIDという識別子で識別します。通常は、識別子は、違う人が同じ識別子を違う人が違う意味で重複して利用しないように、サーバーや認証機関で一元管理されています。

このUUIDは、サーバーがない一元管理することができない分散処理系で、個々の機器が勝手に生成しても、それらが重複しないように工夫されてた識別子です。Mac OS X であれば、ターミナルでコマンド uuidgen を実行すれば、UUIDを生成できます。

独自の Bluetooth low energy 機器の開発は、まず機器の振る舞いをカスタム・プロファイルとして定義して、次に、そのプロファイルに必要なサービスとキャラクタリスに生成したUUIDを割り当てて、設計していきます。カスタム・プロファイルの機器に対応するスマートフォンのアプリケーションは、そのカスタム・プロファイルの定義とサービスとキャラクタリスのUUIDの情報があれば、設計できます。

また Blutooth SIG のメンバーになることで、Bluetoothにプロファイルを提案して採択してもらうことができます。

1社で製品とその対応アプリケーションを提供するだけであれば、カスタム・プロファイルでよいのです。ですが、例えば心拍計のような一般的な機器でこのようなやり方をすると、同じ目的の機器に対して、会社ごと異なる無数のカスタム・プロファイルが出てきてしまいます。

業界に関わる会社群が、標準化したプロファイルを Bluetooth SIG に提案して採択してもらい、同じ振る舞いを1つのプロファイルに統合することが、機器市場をつくり上げるうえでも必要になります。

2015年1月には、次の15のプロファイルが採択されています。Bluetooth low energy が登場する以前から無線化が進んでいた、フィットネスや自転車などの分野で使われる機器のプロファイルが、特に早くから採択されてきています。

[Profiles | Bluetooth Development Portal](http://developer.bluetooth.org/gatt/profiles/Pages/ProfilesHome.aspx)

- アラート通知 (Alert Notification)
- 血圧計 (Blood Pressure)
- 自転車のパワーメータ (Cycling Power)
- 自転車の速度とペダル回転数 (Cycling Speed and Cadence)
- デバイスの発見 (Find Me)
- 血糖値 (Glucose)
- 体温計 (Health Thermometer)
- 心拍 (Heart Rate)
- 入力装置 (HID OVER GATT)
- 位置と経路誘導 (Location and Navigation)
- 電話の警告(Phone Alert Status)
- 近接 (Proximity)
- ランナーの速度とペース (Running Speed and Cadence)
- スキャナの通信パラメータ設定 (Scan Parameters)	
- 時刻 (Time)

















<!-- レイヤをまたいだ、セキュリティとプライバシーの話をまとめる -->

## セキュリティとプライバシー

通信技術には、想定される人間の悪意や犯罪行為に対抗できる、強固なセキュリティの確保とプライバシー保護の技術が必要です。

機器を電線で接続しなくても利用できたり、あるいは近づけるだけで通信ができる無線通信は、無線LANや電車の自動改札などで日常的に利用しています。通信では、クレジットカード情報のような課金などの重要な情報もやりとりされているので、不正な利益を得ようとする人も出てくるかもしれません。

無線通信は電波で通信しますが、電波は四方八方に広がっていきます。ですから、誰かがこっそり通信を傍受して、自分しか知らないはずの情報をこっそり盗みだすかもしれません。あるいは、外部から電波を送って機器を不正に操作したりするかもしれません。

### 無線通信の利用場面と暗号化技術

通信のセキュリティ技術に、認証 (Authentication)と 認可 (Authorization)という2つの単語があります。認証は、通信相手が正しい相手であることを確認する方法のことを言います。認可とは、認証により確認されたものに対してアクセス権限の制御を行い、相手に固有のサービスを提供することを言います。

認証や認可の仕組みは、通信する機器同士がお互いに知っていなければならないものですから、通信規格が提供しなければなりません。しかし、認証や認可をどう使うかは、利用場面にあわせて設計するものです。

例えば、スポーツジムにあるトレーニング装置からスマートフォンに心拍データを取得する一時的な利用であれば、すぐに使えることが便利ですから、だれでも利用できるように設計します。その場合は認証の仕組みを使うことはないでしょう。ですが、個人が所有する心拍センサーであれば、他人が勝手に接続してデータを読み取られるのは嫌なことですから、認証の仕組みを必ず入れるでしょう。

無線通信は、人間であれば目を閉じて声だけで周囲と会話するようなものです。人間であれば声色で相手が誰かを判定できますが、電波には人間の声色のような機器に固有の情報はありません。無線通信の認証と認可は、暗号化技術で実現されています。

### 無線通信への攻撃方法

Bluetooth無線技術は、次の悪用や攻撃方法を想定しています [^1310]。

- 受動的な盗聴 (passive eavesdropping)
- トラッキング (tracking)
- 中間者攻撃   (man-in-the-middle attack, MITM)

[^1310]: [​Security, Bluetooth Smart (Low Energy), https://developer.bluetooth.org/TechnologyOverview/Pages/LE-Security.aspx](https://developer.bluetooth.org/TechnologyOverview/Pages/LE-Security.aspx)

電波は周囲に広がるうえに、Bluetooth無線技術は規格化された技術なので、電波を受信して通信内容を解析することはとても容易にできます。

まず、受動的な盗聴は、受信するだけの盗聴です。Bluetooth Smart機器の通信は最大でも50メートル程度ですが、指向性の高いアンテナと感度の良い受信装置を使えば、その通信距離よりもはるかに遠距離から盗聴することもできます。受動的な盗聴に気づくことは困難です。

受動的な盗聴で、トラッキングができます。Bluetooth無線技術は利用者が常に身につけたり持ち歩く機器に使われます。機器がやりとりするパケットには、返信するときに必ず必要になる発信元の識別情報が入っています。その識別情報をたどっていくと、ユーザがどこにいたかというプライバシー情報が収集できるかもしれません。

また、能動的に電波を送信することもあります。Bluetooth Smart機器が通信しているタイミングに合わせて、正当なパケットを打ち消すほど強力な電波を送信して、パケットのやりとりの間に割り込み、不正に情報を引き出したり機器を操作するかもしれません。

このような高度な技術を使わなくても、攻撃できる場合もあるでしょう。ユーザが近づいただけで反応するBluetooth Smart機器であれば、受信した電波を再送信する中継装置のようなものを使えば、暗号化に関係なく機器を遠方から反応させられるでしょう。これはユーザが近づいただけで機器が反応するという設計がもたらす脆弱性で、無線規格では対応ができないものです。

### ペアリングとボンディング

Bluetooth low energyは、AES(Advanced Encryption Standard)というアメリカ国立標準技術研究所が公開している共通鍵暗号化方式を使います。AESの鍵長は128ビット、192ビット、そして256ビットの3つが選べますが、Bluetooth low energyは128ビットの鍵長を使います。

共有鍵暗号化方式とは、同じ鍵で暗号化と復号化とができる暗号化方式です。暗号化に使う鍵それ自体を通信相手に渡して共有するために、共有鍵暗号化方式と呼ばれます。

Bluetooth low energyは、2つの機器間でこの鍵を交換する手順をペアリング、交換した鍵を保存して再接続してもセキュアな接続が続けられるようにすることをボンディングと呼びます。

通常はペアリングをするならばボンディングもするように設計しますが、ペアリングはするがボンディングはしない設計も可能です。例えば、スポーツジムにある共有機器で、使用中はセキュアな接続をさせたいが同じ機器を継続して利用することはないならば、ペアリングはするがボンディングはしない設計が使いやすいでしょう。

スマートフォンとBluetooth Smart機器とをペアリングするときに、PINコードと呼ぶ6桁の数値を入力することがあります。このPINコードは、鍵を交換する通信を暗号化するテンポラリ鍵に使われます。Bluetooth Smart機器は、ペアリングでPINコードを入力させないようにも設計できます。このときはPINコードは0であると扱われます。

6桁のPINコードは、強固なセキュリティとはいえません。もしも鍵を交換する通信が受動的に盗聴をされていると、そのデータにPINコード0から999,999までを総当りで解析するだけで、鍵そのものを取り出せます。6桁の数字を2進数で表現すると20ビットです。鍵長が20ビットの暗号化通信の解析には、1分もかからないでしょう。

Bluetooth low energyは128ビットの鍵長を使いますが、この鍵長であれば総当りでは解析に何千億年もの時間がかかり、解読すること自体が現実的ではなくなります。もしもPINコードを128ビット長にしようとすると、ランダムな英数小文字を24文字入力しなくてはなりません。これほどの文字数ではタイプミスばかりして、不便でしかありません。

そこでBluetooth low energyは、人間によるPINコード入力以外に、NFC (Near Field Communication)やQRコードなどの、無線通信以外の方法で128ビット長のテンポラリ鍵を交換する方法も提供しています。セキュリティを求めるならば、これらも検討します。

共有鍵暗号化方式では、どうしても鍵それ自体を相手に渡さねばなりません。そこでBluetoothコア仕様4.2では、Bluetooth low energyにも公開鍵暗号化方式がとりいれられました。公開鍵暗号化方式は、暗号化に使う公開鍵と復号化に使う復号鍵が別々の鍵になる方式で、通信相手には公開鍵だけを渡します。秘密鍵は通信でやりとりされないので、もしもペアリングを受動的に盗聴されていても、秘密鍵は盗み出せません。

Bluetooth low energyの認証および認可は、1つ1つのパケットの単位でおこなわれます。AESは、128ビットのデータを1ブロックとしてブロック単位で暗号化する方式です。ですから、ブロックの値が同じであれば、暗号化された値も同じになります。Bluetooth low energyは、パケットが同じデータを運んでいても、暗号化データは全く違う値になるように、また同じ暗号化データが現れることがないように、ブロックに通信開始ごとにランダムに割り当てる値とパケットごとに割り当てるシーケンス値も混ぜ込みます。

受動的な盗聴への対策として、パケットの暗号化、またGATTでキャラクタリスティクスの暗号化ができます。通信全体を暗号化すると暗号化処理の重さや消費電力の増加が問題となる場合や、特定のキャラクタリスティクスだけを保護したいならば、GATTのキャラクタリスティクス単位でそのデータを暗号化する手段がよいでしょう。

トラッキングへの対策として、パケットのやりとりのために必ずパケットに入る発信元アドレス値を、ランダム値に変更することができます。ペアリングをした機器は、認証した機器かどうかを、ランダム値から鍵を使い判定できます。受動的な盗聴をして発信元アドレス値を集めても、鍵を持たないならば機器とアドレス値の対応づけができないので、トラッキングへの対抗になります。

受動的な盗聴と能動的なパケットの差し込みを行う中間者攻撃への対策は、通信の暗号化以外にも、GATTのキャラクタリスティクスごとの認可でも対策できます。例えば、キャラクタリスティクスに認可があるものだけが書き込みが可能という属性をつけておけば、鍵を使い生成する正しい署名データがあるものだけが、書き込みできます。
















## iOSデバイスとアプセサリ

Bluetooth無線技術は、キーボードやマウスあるいはヘッドセットなど、それまで有線接続だった周辺機器を無線接続にする技術として広く普及しています。Bluetooth low energyは、それらの従来の周辺機器にも使われていますが、これまでになかったユニークで多種多様な周辺機器を生み出してきています。

この新しい体験は、Bluetooth Smart機器と、スマートフォンのアプリケーション、そしてネットワーク・サービスの3つの連携から生み出されます。これまでの周辺機器にはなかった、この新しい概念は、アプリケーション(Application)とアクセサリ(Accessory)を組み合わせたアプセサリ(Appcessory = App + cessory) という造語で表現されます。

このアプセサリの市場は、2011年からiOSとiOSデバイスがBluetooth low energyを一般アプリケーション開発者に開発環境を解放したことで生み出されています。iOS7およびiOS8でのBluetooth low energyの活用をふりかえることで、アプセサリとは何かを見ていきます。

### クラシックBluetoothでのiOSの周辺機器開発

iOSではクラシックBluetoothでの周辺機器は、キーボードやヘッドセットなどの一般的な周辺機器か、特定のiOSアプリケーションとだけ通信できる専用周辺機器かの、いずれかのみが開発できます。

Bluetooth無線技術は、無線通信と機器の振る舞いとを組にして、無線通信とデータ表現などを組み合わせた、利用場面に最適化した技術を提供しています。

例えば、ヘッドフォンの機能は、iOSデバイスと接続して音を再生することです。ですが、説明書を見ると、電話などの通話や高音質の音楽再生など、いくつものプロファイルに対応していることがわかります。音を再生するといっても、会話に使われる通話には音質はほどほどでよいが低遅延であることが、音楽再生は遅延時間はほどほどでもよいが高音質であることなど、要求が異なります。

Bluetooth無線技術は、通信と振る舞いとを組み合わせて、プロファイルという機器ごとに適した技術仕様にまとめることで、利用場面の要求に応えられる技術となりました。またBluetooth SIGがプロファイルの認証制度を提供することで、周辺機器は周辺機器として製造販売に専念でき、またスマートフォンやパソコンなどは、個別の機器との相性問題を心配する必要がなくなります。

iOSでは、パソコンでいうデバイス・ドライバに相当する部分をiOSが提供することで、プロファイルに対応しています。iOSは入力装置という抽象化された形でアプリケーションに機能を提供します。したがってアプリケーションは、ヘッドセットが有線接続か無線接続かを気にする必要はありません。またキーボードがタッチ画面であっても無線接続であっても、日本語入力変換などの快適なキー入力体験が得られます。

このプロファイルは、広く使われる一般的な周辺機器にはとても有効な仕組みです。ですが、例えばある会社がBluetooth無線技術を使い自社からユニークな自社製品を開発製造しようとすると、この仕組みは使えません。プロファイルの定義とBluetooth無線規格への盛り込みは大変な手間と費用がかかります。また、プロファイルを作ると、どの会社からも同じ振る舞いをする製品を開発販売できるのですから、自社の製品という強みが失われます。

かつてUSBが登場する以前は、パソコンの周辺機器による拡張には、シリアル・ポートというシリアル通信端子が使われていました。Bluetooth無線技術には、そのシリアル・ポートに相当する任意のバイナリ通信を提供する シリアル・ポート・プロファイル ( Serial Port Profile, SPP ) があります。カスタム製品は、このシリアル・ポート・プロファイル を使って開発されます。

ですが、iOSはシリアル・ポート・プロファイルをサポートしません。クラシックBluetoothを使うiOS周辺機器開発は、Apple社と Made for iPhone(MFi)プログラム と呼ばれる秘密保持契約を締結して初めて提供される開発キットを使って開発します。どのような通信をおこなっているのかなど技術詳細は、秘密保持契約のもとにあるので、一般にはその詳細を知ることはできません。

MFiプログラムをうけて開発製造したカスタム機器は、その機器と対応するiOSアプリケーションと接続できます。他の任意のアプリケーションからは、その周辺機器を使うことはできません。

### Bluetooth low energyとiOSと連携するアクセサリ

Bluetooth low energyは、キーボードのような従来からある周辺機器およびカスタム機器が開発できます。また、iOSはビーコンやHomeKitあるいはハンドオフなどの独自サービスの基盤技術として活用しています。

Bluetooth low energyのプロファイルは、GATTベースのアーキテクチャ(GATT-based architecture)と呼ばれ、ジェネリック・アトリビュート・プロファイル(GATT)を使って作られます。GATTベースプロファイルには、Bluetooth SIGによる採択済みプロファイルと、開発製造者が任意に定義するカスタム・プロファイルがあります。

採択済みプロファイルとカスタム・プロファイル、いずれもGATTベースのプロファイルであることに違いはなく、その違いはプロファイルがBluetooth SIGにより採択されているか、されていないかです。Bluetooth Smart機器Bluetooth SIGの認証をうけてはじめて製品登録ができます。採択済みプロファイルを採用している製品は、採択プロファイルまでが、カスタム・プロファイルの製品ではジェネリック・アトリビュート・プロファイルまでが認証の対象になります。

MFiプログラムを締結していない一般開発者に開放されたCoreBluetoothフレームワークは、ジェネリック・アトリビュート・プロファイルへのアクセスを提供します。ですから採択済みプロファイルでもカスタム・プロファイルであっても、どちらもアプリケーションから直接利用できます。またOS X Lion (10.7)からCoreBluetoothフレームワークがサポートされています。したがって、iOS向けに開発したBluetooth Smart機器のライブラリはそのまま OS Xで利用できます。

パソコンでは、アプリケーションはデバイス・ドライバを通じて周辺機器を使います。デバイス・ドライバは特定の周辺機器の機能と、オペレティング・システムが定義する一般化された周辺機器の仕様との橋渡しをします。これは、プリンタのような一般的な周辺機器を、どのアプリケーションからも抽象化された周辺機器が利用できる優れた方法です。

Bluetooth Smart機器でも、キーボードのような一般的な周辺機器は、iOSが対応します。またiOSが対応しているプロファイルには、一般アプリケーションからアクセスできません。例えば、キーボードは、iOSの日本語変換などの入力機能があって初めて使える周辺機器です。もしもジェネリック・アトリビュート・プロファイルを通じて一般アプリケーションがキー情報を直接取得できても、あまり使い道はありません。このような一般的な周辺機器は、クラシックBluetoothでそうであったのと同じように、OSがサポートすべき機器です。

Bluetooth low energyは、特に早くからフィットネス分野の心拍計や体重計に使われています。iOS標準アプリの1つ HealthKit は、健康に関するいくつものプロファイルに対応しています。HealthKitが取得蓄積したデータは、iOSアプリケーションからHealthKitフレームワークを通じて取得できます。HealthKitそれ自体はアプリケーションですが、ちょうどパソコンでいうデバイス・ドライバとデータ蓄積の機能を、他のアプリケーションに提供しているといえます。

アプセサリと呼ばれるカスタム・プロファイルのBluetooth Smart機器は、独自プロファイルで、自社のアプリケーションとの連携で初めて価値が出るように作られます。ですから、アプセサリでは、パソコンのように周辺機器を一般化したり抽象化する必要がありません。また、iOSではユーザがインストールできるものはアプリケーションだけです。ですから、アプリケーションがデバイス・ドライバに相当する部分までを含みます。

クラシックBluetoothの周辺機器は、有線接続で機器のケーブルを接続していたのと同じように、ユーザが設定画面から機器に接続して利用します。しかしアプセサリでは、ユーザが機器にいちいち接続するのでは不便になります。iOSは、アプリケーションが直接Bluetooth Smart機器に接続できます。

iOSアプリケーションには、画面に表示されてユーザが操作しているフォアグラウンド状態と、画面に表示されていないバックグラウンド状態があります。もしも
iOSアプリケーションがフォアグラウンド状態でしかBluetooth Smart機器と通信ができないようだと、ユーザは常にiOSアプリケーションを起動してBluetooth Smart機器を操作する、リモコン・アプリケーションしか作れません。

iOSには、アプリケーションが画面に表示されていない状態でも、Bluetooth Smarto機器に反応できる強力な仕組みがあります。Bluetooth Smart機器との通信が断絶したり、接続できる範囲にはいったり、また接続している機器からデータが送られてきたときに、もしもiOSアプリケーションが終了していれば、iOSがアプリケーションを起動して、Bluetooth Smart機器とのやりとりの処理を継続させます。

この強力なバックグラウンドでの機能が、アプセサリと呼ばれる利用場面を実現可能にしています。ユーザは意識していなくても、Bluetooth Smart機器とアプリケーションがいつのまにか同期している自然な体験が作られます。

### Apple社独自の周辺機器仕様

iOSはBluetooth low energyを一般開発者に開放しただけではなく、iOSの様々な機能の技術基盤としても活用しています。さらに、Apple社は、独自の周辺機器仕様を公開して、Apple IDおよびiCloudと連携する機器開発の機会を提供しています。

iOS独自の周辺機器の仕様には、Apple Notification Center Service (ANCS) と Apple Bluetooth Low Energy MIDI の2つが一般に公開されています [^1410]。この2つの仕様はMFiプログラムの対象ではありません。またApple社独自のゲーム専用コントローラの仕様があります。これはMFiプログラムの対象です。このコントローラは、ゲーム開発の機能を提供するGameKitフレームワークを通じて利用できます。

メールやソーシャルメディアの通知を知らせるBluetooth Smart機器は、スマートフォン連携での定番といっていい機器です。ANCSは、iOSの通知画面に表示される情報をBluetooth low energyを通じて周辺機器に伝える仕様です。

様々なアプリケーションからユーザに通知される通知画面の情報は、おそらくユーザのプライバシーの保護のために、iOSアプリケーションからは読み取れません。ですから、もしもiOSアプリケーションで通知機能を実現しようとすると、アプリケーション自体に様々なメールやソーシャルメディアの通知取得機能を実装しなくてはなりません。ANCSを通じて、Bluetooth Smart機器は通知情報をiOSから直接取得できます。

Apple Bluetooth Low Energy MIDI は、電子楽器の演奏データを機器間でデジタル転送するための規格 MIDI（Musical Instrument Digital Interface、ミディ）をBluetooth low energyでやりとりするApple社の独自仕様です。楽器の音がずれてはならないので、この仕様はデータ形式だけではなく、低レイテンシにするための通信パラメータまでを規定しています。

この仕様に準じるBluetooth Smart機器は、CoreBluetoothフレームワークではなく、音を扱うためのCoreAudioKitフレームワークを通じて、アプリケーションから楽器として利用ができます[^1410]。

[^1410]:[Technical Q&A QA1831 Adding Bluetooth LE MIDI Support, https://developer.apple.com/library/ios/qa/qa1831/_index.html](https://developer.apple.com/library/ios/qa/qa1831/_index.html)

### Bluetooth low energyとビーコン

iBeacon [^1410] は、iOS7で導入された新しい位置と近接の検出技術です。Bluetooth low energyのアドバタイジング・パケットをブロードキャストするビーコンと、iOSの常時ビーコン検出の機能を組み合わせて使います。屋内の経路案内や博物館の展示案内あるいは紛失物の探索などに利用できます。

[^1410]:[https://developer.apple.com/ibeacon/](https://developer.apple.com/ibeacon/)

ビーコン検出機能は、位置情報を提供する CoreLocationフレームワークを通じて一般開発者に提供されています。開発者は Bluetooth low energy を意識することなくiBeaconを利用できます。

iOSは強力なビーコン検出を提供します。iOSデバイスが再起動してもビーコン監視は継続します。さらに、ビーコンを検出した時にアプリケーションが終了状態であれば、iOSがアプリケーションを起動して検出イベントをアプリケーションに通知します。

ビーコンは、CoreLocationフレームワークとCoreBluetoothフレームワークを使いiOSアプリケーションを使ってiOSデバイスをビーコンにするか、またはiBeaconのハードウェア仕様にしたがって製造したビーコンを利用します。このiBeaconのビーコン技術仕様はMFiプログラムの対象です。

Bluetooth low energyのアドバタイジング・パケットは、どの程度の周期で送出されるかが事前にわからないので、通常は、アドバタイジング・パケットを検出する間は、2.4GHzの高周波受信回路を動かし続けます。ですから、単純にアドバタイジング・パケットを利用するビーコンを24時間監視すると、消費電力が無視できない大きさになります。

iBeaconは、ビーコンのアドバタイジング・インターバルを規定します。そしてiOSは、その技術仕様を前提にして、iOSデバイスのハードウェアとソフトウェアとを最適化して、消費電力を小さくしています。このビーコンとiOSとの統合された最適化ではじめて、ビーコンの常時検出が実現されています。

ビーコンは、任意に設定できる128ビットの識別子(UUID)と2つの16ビット値を送出できます。iOSアプリケーションは、検出対象のビーコンのUUIDを必ず指定しなければならないので、周囲にある任意のビーコンを検出することはできません。ですから、誰かが設置したビーコンの識別情報を盗みだすスニッフィングなどの悪用はできないようになっています。

iBeaconは、iOS標準アプリのPassbook [^1420] が利用しています。ビーコンがあるとロック画面にパスが表示されます。

[^1420]:[Passbook for Developers, https://developer.apple.com/passbook/](https://developer.apple.com/passbook/)

### HomeKitとBluetooth low energy

HomeKit [^1430] は、照明機器や電子錠などの身の回りにある機器とiOSデバイスとを、 Bluetooth low energy または Wi-Fi で連携させる技術です。HomeKitは、Siriを通じて自然な音声コマンドで機器が操作できるという、映画では見慣れた誰もが理解しているアプリケーションを提供しています。

[^1430]:[https://developer.apple.com/homekit/](https://developer.apple.com/homekit/)

機器が連携さえしていれば、サービス提供者やアプリケーション開発者が工夫して、多種多様なアプリケーションが新たな便利さや利用シーンを作り出されていきます。しかし、アプリケーションが登場するには、機器が連携してからしばらく時間がかかります。音声コマンドによる操作は、今はまだないサード・パーティのアプリケーションがなくとも、HomeKitを特徴づけるアプリケーションとなっています。

HomeKit は、機器開発のためのHomeKit対応機器の通信仕様と、iOSアプリケーション開発のための機器の登録や操作を提供する HomeKitフレームワークの2つで構成されます。HomeKit対応機器の開発は、MFiプログラムの対象です。HomeKitフレームワークは、一般開発者に開放されています。

電化製品を遠隔操作する技術は、古くから使われてきた技術です。例えば、1975年に開発された屋内電力配線で制御信号を送る技術X10は、電灯の遠隔操作パネルなどに欧米で広く使われています。X10のように専用制御装置を使うならば、すべての機器が屋内電力配線につながりますが、HomeKitではユーザはiOSデバイスを通じて機器とつながります。そのため、HomeKitは無線通信を使います。

電波は四方八方に広がるものなので、電化製品の無線化ではセキュリティの確保とプライバシーの保護が重要な課題になります。Bluetooth low energy にも、もちろんそれらの技術が盛り込まれていまが、HomeKitはそれらの技術は使っていません。HomeKitは、Bluetooth low energyを単にデータをやりとりするだけの無線通信として利用しています。セキュリティやプライバシーは、Apple社独自仕様で守られます。

### iOSと Bluetooth low energy の今後

iOSの Bluetooth low energy との関わりとその活用を見てきました。多種多様なものを無線接続にできる Bluetooth low energy は、モバイル機器を中心にした情報とものとの関わりを作る重要な技術となってきています。

現在のアプセサリは、ちょうどAppStoreが登場してアプリケーションの販売とアプリケーション内課金という収益が得られる場が生まれたことで、短期間に数多くのiOSアプリケーションが登場した様子に似ています。

アプセサリでは、フィットネスや健康維持の分野で急成長する会社が登場しています。iOSアプリケーションを通じて提供されるサービスを生み出し初期の競争を生き残った企業が、今の成熟したモバイル市場で大きな売上を生み出しているように、アプセサリも規模の拡大と成熟を迎えていくでしょう。

これまでのアプセサリは、iOSデバイスと周辺機器が、電波が届く範囲で1対1に接続するものです。ですがiBeaconやHomeKitなどはそうではありません。

iBeaconは、新しい近接と位置の検出技術ですが、それだけではなくブロードキャストによる接続しない場面に広く応用できます。例えば、コーヒーサーバーの備品補給が必要なときに、ビーコンでそれを知らせる利用方法があります。フィットネス機器と違い、コーヒーサーバーのように、iOSデバイスと常に無線接続させたいわけではない機器でも、ブロードキャストを利用すれば、まれに機器から通知したい情報をユーザに届けることができます。

HomeKitは、電化製品を無線接続する技術ですが、iPhoneやiPadなど数多くのiOSデバイスをシームレスに利用している現在のユーザからみれば、それらのデバイスと同じように、電化製品をiCloudに取り込むブランドと言えます。例え Bluetooth low energy を使っていても、周囲にあるiOSデバイスが、その機器とiCloudとを連携させることで、ユーザはどこにいるかに関係なくiCloudを通じて機器を利用できるでしょう。

iOSとBluetooth low energyが、今後どのような発展を遂げるのかは、予測はできません。

Bluetooth low energyは、ハードウェアの機能と、ユーザから見た利用場面つまりプロファイルを分離するものと言えます。また、iOSのヘルスアプリのように機器からユーザ・データを分離できるものとも言えます。そして、Bluetooth low energyがある領域は常に、何かしらのハードウェアと、スマートフォン、そしてネットワーク・サービスの3つの要素があります。これらの分離と3つの要素の組み合わせとが、今までにない価値をユーザに届けることでしょう。


















<!-- アプセサリと事業 -->
## アプセサリとその事業

アプセサリは、アプリケーションとBluetooth Smart機器との連携で生まれる、これまでにない新しい価値を表すための造語です。アプセサリが広く一般に使われるには、必ずBluetooth Smart機器というハードウェアの普及が必要です。そしてハードウェアを一般に広く普及させようとすれば、それは事業になります。

国語辞典には、事業とは、大きく社会に貢献する仕事とあります。また日本の国税法令には、事業とは同種の行為を反復、継続、独立して行うこと、としています。本書はBluetooth Smart機器の試作に焦点をあてています。試作は事業を始めるための実験的な製作や実験ですから、試作自体は事業ではありません。

アプセサリによる事業を産み出すための試作は、工業分野で一般的に行われている試作とは異なります。Bluetooth Smart機器やアプリケーションといった目に見えるものの試作品を作り試験することを繰り返すようなものではありません。また、ハードウェアやソフトウェアといった個別要素を積み上げていけばよいものでもありません。

試作への考え方や取り組み方は、それぞれの分野や立場あるいは予算や環境により千差万別です。事業規模のアプセサリのための試作を一般化することは困難ですが、ここでは、アプセサリの事業のための試作をおこなうときの、考え方のパターンを示してみます。

### 資本と拡大再生産

産業革命は、18世紀半ばから始まった、蒸気機関などの動力源の発明とその応用がもたらした生産技術の変革、そしてその革新的な生産活動が社会と経済にもたらした変革と発展の総称です。それまでの手工業的な生産は、資本家が労働者を雇い入れ生産機械を使う大工場による生産へと発展して、均質な製品が大量生産されて安価になっていく時代になりました。

資本主義経済は様々な改良を加えられつつ、産業革命から200年以上経過した現代も広く使われています。そのなかで会社事業を営むこと、つまり経営の資源は、ヒト・モノ・カネの3つに、形がない資産を表す情報を加えた4つの要素だと言われています。

経営は、ヒト・モノ・カネそして情報を使い、なにかを生産します。そのなにかは市場などを通じて、最終的に売上というお金になります。売られたものは、どこかでだれかに消費されます。同じだけの資本から、より大きな売上が得られれば、より多くの利益が得られます。生産と販売そして消費のサイクルを繰り返すことで、資本をより活用できるところに、より多くの資本が集まり、社会全体の富が増えていきます。

アプセサリの事業でも、Bluetooth Smart機器というハードウェアが製造販売されて初めてサービスが普及するので、このサイクルを繰り返します。

### ハードウェアのライフサイクルと課金

アプセサリの構成要素の1つ、Bluetooth Smart機器というハードウェアの流れに注目します。研究開発から生み出されたハードウェアは、製造されてから、流通と販売、利用、そして破棄の5つの段階をたどり、そのライフサイクルを終えます。流通販売を通じてBluetooth Smart機器を取得した利用者は、その機器と連携するアプリケーションやアプリケーションを通じたネットワーク・サービスを利用します。

利用者がお金を支払うタイミングは、このハードウェアのライフサイクルのうち、販売と利用の2つの段階です。Bluetooth Smart機器は、リサイクルの仕組みが整備された家電に組み込まれていたり、あるいはウェアラブル機器などの小型電子機器であるので、破棄は地方自治体に任せることができます。

したがって、売上を得る組み合わせは、販売時点のみ、販売時点と利用期間、利用期間のみの3つの組み合わせがあります。

販売時点のみで売上を得る方法は、例えば家電や電化製品などを購入するのと同じ体験になります。販売時点と利用期間で売上を得るのは、例えばスマートフォンというハードウェアを購入した後に通信という月額課金サービスを利用しているのと同じような体験になります。また利用期間のみで売上を得るのは、例えばソーシャルゲームのように基本機能は無料で利用できるけれども、拡張機能はアプリケーション内課金を通じて購入する体験と同じです。

ハードウェアの製造と流通販売には費用がかかっています。ですから事業者にとっては、その費用をなるべく早くに回収できたほうが、うれしいことになります。ですから、販売時点で費用を回収するのが、もっとも嬉しい方法です。この場合、ネットワーク・サービスの利用料金は、販売価格に織り込んでおきます。

しかし、1つのハードウェアあたりの利用期間が利用者ごとに違いすぎると、利用料金が織り込まれた販売価格を高いと感じる人が多くなるかもしれません。あるいは、サービスの経費が無視できない大きさになる事業もあります。その場合は、販売時点と利用期間の両方で費用を回収します。

また、ハードウェアを普及させるために、製造原価あるいはそれを下回る価格で販売、もしくは無償で配布することがあります。この場合は、利用期間で費用を回収します。この方法は、ハードウェアの費用を回収するまでの期間を持ちこたえる十分な資本が必要ですが、競争が激しい事業分野で利用者数の増加率または絶対数が極めて重要な経営指針となる場合や、利用者が初期費用に強く反応する分野では有効です。

### Bluetooth Smart機器の利用分野

アプセサリを事業にすると、ハードウェアとしての機能が同じBluetooth Smart機器でも、そのハードウェアとかけ算される形のないアプリケーションやサービスによって、様々なアプセサリが生み出されます。

ハードウェアをその機能に注目すると:

- 周辺機器としての機能
- 使ってもよいし使わなくてもよい追加機能
- 必ず使われる機能

の3つに分類できます。

デジタル体重計を例にして、この機能が同じハードウェアを、これらの3つの場面にあてはめると、どのように違うものに見えてくるかを、見ていきます。デジタル体重計は、すでに液晶パネルや電池があるので、既存の設計にBluetooth low energyの通信モジュールを追加するだけで、容易にBluetooth Smart機器にできます。ですが、販売価格が3000円から1万円程度のデジタル体重計にとって、部品価格が5ドルほどの通信モジュールは決して安価な部品ではありません。

体重計、あるいはキーボードや楽器などといった周辺機器では、採択済みプロファイルにしたがい、それぞれ作られたハードウェアとアプリケーションとが接続します。このハードウェアとソフトウェアは、様々な事業者が提供するものを、任意に組み合わせて利用することができます。ですから、周辺機器はアプセサリではありません。

例えば、採択済みプロファイルには体重計のプロファイル Weight Scale Profile があります。iOSの標準アプリの1つヘルスケア・アプリは、この体重計のプロファイルに対応していますから、体重計を購入してくれば、iOSからすぐに利用できます。

周辺機器は、周辺機器として機能することに価値があります。ですから、他社製品とはハードウェアとしての価値で差別化が図られます。周辺機器としての機能があれば、どの製品も同じように使えるので、周辺機器は置き換えが可能です。周辺機器の事業者は、利益を得るために、
価格が安いものや高いもの、デザイン性や追加機能で購入者の多様な要望にあわせた商品群を作り、また宣伝広告をしてブランド力を高めて、他社との差別化をおこないます。

そもそもBluetooth low energyがなくても成り立っていた製品を Bluetooth Smart機器にすることがあります。

1つは、液晶パネルや操作ボタンなどが部品費用がかかるため付けられなかった製品を、Bluetooth Smart機器にしてアプリケーションを通じて、豊かな設定機能や操作性を与えるものです。もう1つは、スマートフォン連携機能を理由にして、従来よりさらに1つ上の価格帯の製品群を作り出すことです。これらの機能は、もともとあった製品への追加機能ですから、使ってもよいし使わなくてもよい機能になります。

体重計であれば、液晶パネルの部品費用の兼ね合いで体重計に乗った時の値だけを表示しているものでも、アプリケーションにデータを送り美しい折れ線グラフで表示できます。また、自社で開発したアプリケーションを製品カタログに掲載して、スマートフォン連携という新しい追加機能を理由に、今まで最も価格が高かったハイエンドな製品群の、さらにもう1つ上の価格帯の製品群を作ることができます。いずれの場合でも、体重計は体重計ですから、スマートフォンと連携させなくても、従来通りの体重計として使い続けられます。

それまでにもあったハードウェアを、サービスから利用するためにBluetooth Smart機器にすることもあります。

例えば、健康管理やダイエット指導などのサービス提供に、毎日の体重の測定と記録が必要だとします。通常の体重計でも、表示値を人間が都度手入力すればよいのですが、一手間かかります。そこにスマートフォンとハードウェアの間にある最後の1メートルを埋めるBluetooth low energyを活用して、体重計に乗るだけでよいサービスが作れます。

これまでの話は体重計という1つのハードウェアだけに注目してきたので、それだけならば手入力でよいのではと思えますが、おそらくサービスは、体重だけではなく、毎日の歩行数や階段の昇り降りの回数やその速度、あるいは睡眠時間とその質など、いくつもの項目のデータを収集し続けます。これらをいちいち手入力するのは大変な手間ですから、データはすべて自動的に収集されるように設計します。

これは、サービスを利用するためにハードウェアが必要になるアプセサリの体験になります。アプリケーションは自社製品とだけつながるようにして、自社製品の売上だけから利益を得ることもできます。また、どの会社の製品ともつながるようにして、月額利用料金から利益を得ることもできるでしょう。いずれにしても、サービスを利用するために体重計を利用するので、必ずアプリケーションが利用されます。

### 事業化と周囲環境

事業、つまり大きく社会に貢献する仕事は、その時代の社会が求めるものを提供する仕事でもあります。アプセサリの事業は、産業革命以来続いてきた大量生産がもたらした高度で高品質な工業製品を使い、また今はまだない社会が求める次の価値をもたらす事業とも言えます。

アプセサリは、情報から価値を産み出せる分野に需要があります。アプセサリの事業化の周囲環境には、需要、顧客、そして配備と運用のの3つの項目があります。

利用場面が社会や会社であれば、情報があるかどうかで、組織の動き方は大きく違ってきます。刻一刻と変化する情報を実時間で収集できなければ、また各部署に刻一刻と変化する状況に合わせた指示を出せないならば、全体を連携させるためには、事前に計画を決めておいて、それぞれの部署が計画通りに動くしかありません。

例えば、かつての流通業はA地点からB地点に物資を運搬することが付加価値でした。しかし、通信技術が普及した現在では、物資運搬は生産と在庫管理そして販売状況と常に連動していて、全体から見た価値を最大化します。

個人利用であれば、データがユーザの行動を変化させます。人の購買活動を変化させる広告は、ネットワーク・サービスの大きな収益源です。例えば、ビーコンとアプリケーションを組み合わせて、その場にいるユーザにクーポンを通知することで、購買活動に影響を与えられます。またフィットネスであれば、これまでの運動実績と体重の記録から、現在の運動状態がもたらす結果を予測したり、その予測をもとに現在の運動内容を変更するなどするでしょう。

そして、アプセサリには、潜在的に多くの顧客がいます。多くの利用者がいるBluetooth Smart Readyなスマートフォンは、アプリケーションをインストールするだけで、Bluetooth Smart機器と連携します。またアプセサリは、一般消費者だけではなく、業務向けあるいは社内で閉じた利用もできます。

配備には、ハードウェアの開発と製造、そしてアプリケーションとネットワーク・サービスの開発と運用が必要です。

アプセサリが使うハードウェアが、従来からある一般的な製品をBluetoth Smart機器にしたものであれば、設計から製造開発までを受託している企業が見つかります。すでにある開発資源を利用すれば、ゼロから開発しなくてもよいので、開発費用を省けます。もしも一般的な機器ではない独自機器であれば、量産能力のある受託開発先を探すか、あるいは製造委託先を探してから、そこと取引がある開発受託会社に問い合わせていくなどします。

機能することを目標に開発する試作と、製造に適した開発では、開発内容が異なることがあります。量産に適するように変更するか、ときにはいちから再開発します。ハードウェアとアプリケーションの境界、そしてハードウェアと無線通信あるいは無線通信とアプリケーションの境界では、ありとあらゆるトラブルが生じます。それぞれの担当者が常に雑談ができるような連携できる環境を整えることが重要です。

アプリケーションやネットワーク・サービスは、開発環境が無償で公開されているものが多く、また開発情報も一般に広く公開されています。またアプリケーションやソーシャル・ゲームなどで開発需要があるので、開発者の育成も行われています。実績のある個人事業主や受託開発会社は、見つけやすいでしょう。

### 事業化とその失敗

事業化は、売り上げがあり、そこから事業を継続発展させる資本を確保できれば成功といえます。しかし、発売するまでは、売り上げが得られるかすらわかりません。アプリせサリの事業化は、利用者に何を届けるかを決めて、その価値を届けられるチームを作り、そしてその価値が利用者に届いているかを確認しつづけなければなりません。

家庭用のエアコンを例にして、利用者に届ける価値が一貫していない場合を見てみます。

製品企画で、使ってもよいし使わなくてもよい追加機能として、スマートフォンのアプリケーションから設定温度や運転状態を設定するリモコン機能を追加することにしたとします。しかし、エアコンの開発に関わる部署が集まり会議をしているうちに、スマートフォンのアプリケーションから操作できれば十分だから、これまであった専用リモコンをなくして製造費用を削減しようという意見が出て、それが採用されたとします。

これは最初に決めた届けるべき価値が、損なわれた例です。ここには2つの過ちがあります。1つは、あってもなくてもよい機能を、必ず使わなくてはならない機能にしたことです。もう1つは、たまたま提案された機能を見て、ユーザの体験からではなく製造費用という事業者の都合だけで解釈して、専用リモコンをなくしたことです。

もしも、このエアコンが一般販売されたとします。利用者は、エアコンをオンにするためだけに、スマートフォンを取り出して、アプリケーションを起動しなければなりません。それまでの専用リモコンであれば、目の前にあるリモコンのボタンを押すだけでよかったものが、不便で不快な体験を常に強いられることになります。

次に、価値を届けられるチームが作れない場合を見てみます。

追加機能としてのリモコン・アプリケーションを会社内の開発チームに任せたとします。優秀な技術者であれば、一般に公開されている開発情報をもとに、スマートフォンのアプリケーションを作れます。しかし、普段私達が目にしているアプリケーションは、グラフィック・デザインやユーザ・インタフェースなど様々な専門分野のメンバーからなる専業チームが作っているものです。開発チームの内部評価では、素晴らしいアプリケーションであっても、専業チームのアプリケーションがあふれているなかでは、使いよいアプリケーションであるかはわかりません。

また、製品を発売してもよいかを判断するために、会社役員に見せたとします。このときに役員が、アプリケーションを自社の他の製品も操作できるようにすればよいのではないかと、意見を言ったとします。もしもこの意見をそのまま取り込むと、エアコン専用であったときには不要であった、機器の選択画面が新規に設置されて、そこに洗濯機や食器洗浄機はては空気洗浄機といった雑多な機器の一覧が並ぶことになります。

これらの失敗例は、事業者の都合でしかありません。価値を届けるチームとは、企画、経営、開発、製造そして広報や営業販売まで、会社組織のすべての部署を横断して連携して、初めて作ることができます。

























## アプセサリとデータの流れ

Bluetooth low energyには機能と振る舞いを分離する性質があります。機能が同じハードウェアでも、利用場面との組み合わせで違うものになり、そういった新しい概念をアプセサリという造語で表現しました。またアプセサリの事業化は、複製や配布費用がほぼ無視できるアプリケーションやネットワーク・サービスとは異なり、ハードウェアの普及が必要になるため、その事業化ではハードウェアのライフサイクルや収益構造の設計が必要になることを見てきました。

ハードウェアそしてアプリケーションやサービスという3つの要素の組み合わせは、無数にあります。その無数の可能性を目の前にすると、利用者に価値を届けるといっても何が価値なのかと、自信が持てなくなります。そして事業化に使える資本は有限ですから、無数の可能性を1つ1つ検証することもできません。

ここで要素ではなく、目には見えない要素のつながりに注目します。そうするとアプリケーションとBluetooth Smart機器との間に流れるデータが見えてきます。また現実世界からデータが分離されてアプリケーションに送られたり、アプリケーションから送られたデータが人間の行動を変化させたりと、そのつながりはBluetooth Smart機器のその先にある現実世界にまで広がっていることが見えてきます。

要素の組み合わせの数は無数にありますが、つながりの種類は限られています。ですから、まずつながりの形を考えてから、そこにハードウェアなどの要素をあてはめていくことで、可能性をさぐることができます。ここでは、要素のつながり、そして要素を含めた世界全体に広がるつながりを、データの流れという視点で見ていきます。

### 入力と出力

アプセサリのデータの流れを [#fig_ch01_data_flow] に示します。図のクラウドは、1つのネットワーク・サービスを提供するためのサーバー群を示します。アプリケーションはスマートフォンあるいはWiFiルータで稼働するアプリケーションを、デバイス群は複数のBlutooth Smart機器を示します。

![ #fig_ch01_data_flow アプセサリとそのデータの流れ](fig/ch01_fig060_data_flow.png)

アプセサリを構成する3つの要素、Bluetooth Smart機器、アプリケーションそしてネットワーク・サービスは、双方向通信でつながります。ですから、一方から見た出力は他方から見た入力になります。そしてBluetooth Smart機器は物理世界との入出力を持ちます ( [#fig_ch01_data_flow] (a))。

要素と要素とのつながりを階層化すると [#fig_ch01_data_flow] (b) になります。たいていのアプセサリは、1つのクラウドと複数のアプリケーションが、また1つのアプリケーションと複数のデバイスが通信します。階層化は、それぞれの要素の役割とそれぞれの要素の関係を図示しているにすぎません。階層図を見ると人は、人間社会の会社組織の命令や権限の上下関係、また群れの動物が持つ本能的な上下関係を連想しがちです。そのような思い込みや勘違いは、アプセサリの設計を間違わせるので、注意します。

また、アプセサリでは階層の要素間の通信は、常にバイトデータが流れ続けるストリーミングではないことに注意します。Bluetooth low energyがやりとりするデータには構造、つまりプロファイルは、ジェネリック・アトリビュート・プロファイル(GATT)をベースにしたモデルがあります。要素はお互いに、そのモデルとモデルの意味を知っています。そしてモデルに変化が起きた時など、イベント発生時にそのデータをやりとりします。

要素はそれぞれ、内部に処理とメモリの機能を持っています ( [#fig_ch01_data_flow] (c) )。処理の速さとメモリの大きさは要素ごとに違います。クラウドでは電力の制限もなく数多くのサーバーが使えますが、Bluetooth Smart機器には、コイン形電池で動く規模の小さなマイクロ・コントローラしかありません。

アプセサリという全体視点からみて、要素ごとの処理とメモリ内容とを決めていきます。例えば、運動量を記録するネットワーク・サービスであれば、デバイスには加速度から歩数を求める処理や、体重などのユーザ設定と歩数から消費カロリーを求める数表などをもたせます。アプリケーションは、ギガバイト単位の記憶容量があるので、何十年分ものユーザーの運動量のデータを蓄積できます。ネットワーク・サービスは、データに基づくユーザ同士の交流など、複数のアプリケーション同士の連携から生み出せる価値を提供します。

### 物理量とセンサー

入力系の機器を考えるときは、どのような量が必要か、その量を検出する性能や価格や大きさが適切なセンサー・デバイスはあるのかを調べます。ここでの量は、現象や物体物質の属性で、計測して定量できるものを言います。

例えば、運動量つまり消費カロリーを求めたいとします。原理的には人間が体外に排出するすべての熱量を計測すればよいのですが、それでは人体を覆う大掛かりな装置が必要ですから、現実的ではありません。そこで直接その量を計測するのではなく、他の量から計算したり推定できないかと考えます。

人体で最も大きな筋肉は太ももの筋肉ですから、その筋肉の運動量つまり歩数から消費カロリーを推定できるでしょう。また歩数は腰や手首の加速度から、ある程度の正確さで算出できます。半導体技術の進歩で、低消費電力で安価な加速度センサーが入手できるので、したがって、運動量を求めるデバイスは製造できます。

世の中には様々なセンサー・デバイスがあります。例えば、iPhoneに搭載されているセンサーとその用途は、以下のようになります。

- 電磁波 (電波の送信と受信回路)
	- 無線通信 (携帯網, Wi-Fi, Bluetooth)
	- 位置検出 (GPS)
	- 近接と位置検出 (iBeaon)
- 磁気
	- コンパス
- 光
	- 画面の明るさ調整(照度センサー)
	- 顔と画面の相対位置検出 (光学式近接センサー)
	- 写真撮影 (イメージセンサー)
- 音
	- マイク 
- 静電容量分布
	- タッチ検出
- 加速度、角速度、気圧
	- デバイスの向き検出
	- 歩数や運動量の検出

リストの最後に気圧センサーがあります。山登りなどの百メートル単位で高度が変化するならば、気圧の変化から高度変化を読み取り、運動量も算出できそうです。しかし、スマートフォンに搭載されるのは、山登りのためではありません。現在の気圧センサーはとても小さな気圧の変化が検出できるようになっていて、階段を昇り降りしているときに、階段1段づつの高さの変化を気圧の変化として検出ができます。この気圧センサーを活用すると、重力に逆らう活動量が大きな運動を精度よく検出できるようになります。

スマートフォンというデバイスは、より高い性能や新しい利用場面を提案するために、より高精度であったり低消費電力あるいは便利な付加機能があるセンサー・デバイスを求めています。またセンサー・デバイスの製造会社も、大量に製造されるスマートフォンへの採用は、大きな売り上げに結びつくので研究開発に投資をします。したがって、センサー・デバイスは、すざましい勢いで性能が向上しているので、常に最新の情報を取り入れるようにします。

### 人体との入出力

フィットネスのように、もともと運動量や心拍の計測装置を身につける習慣がある分野では、スマートフォンと連携するさらに高機能なアクセサリとして、Blutooth Smart機器が急速に普及しています。また、人が常に身につける、スマート・ウォッチなどのいわゆるウエアラブル機器は新しい利用場面を切り開くデバイスとして注目されています。

人が常に身につける習慣があるものは、さほどありません。人体が装着するものと、その装着位置で取得できる生体情報を [#table-body-accs-input] に示します。装着者の活動量のように、どの装着位置でも取得できる情報は省いています。

Table: #table-body-accs-input 装着箇所と取得できる生体情報

 装着箇所 | 種類                  | 生体情報
:--------|:---------------------|:----------------------
頭       | 帽子、イヤホン、メガネ  | 脳波、まばたき、視線、頭の傾き、咀嚼
口       | マスク                | 咀嚼、呼吸数、呼吸深さ、呼気の二酸化炭素濃度
胴体     | シャツ、上着、ベルト     | 呼吸、心拍、体温、腹囲、背筋の姿勢
手、手首  | 腕時計、指輪           | 心拍、血圧、血中酸素飽和度
足、足首  | ズボン、靴下、靴       |  歩数、体重や重心位置

またデバイスから装着者に情報を出力できる装着位置は、頭部と手首の2つだけです。これ以外の装着場所では、ブザー音の出力や、あるいは皮膚に接触しているならば、機械的な振動や電気刺激による触感での出力は可能です。

頭部は目や耳に近いので、周囲にきづかれにくい通知ができます。2次元画像を表示する小型ディスプレイもありますが、常に視界に画面がある体験は今は一般的ではありません。手首はよく視野に入るうえ、ある程度の大きさの画面が置けるので、テキストやアイコンによる通知ができます。しかし常に手首を見ているわけではないので、利用者が何かを見たいと思った時に情報を提示する利用場面に適しています。

ここまでの人体との入出力は、一人の人間と1つのデバイスとの関係でした。装着するデバイスには、データ収集や通知などユーザとの入出力機能に加えて、iBeaconのような近接検出や存在を伝える機能も持たせられます。

生身の人間は電波の送受信ができないので、デバイスやスマートフォンからは直接その存在は検出できません。ですが、無線通信機能があるデバイスがタグとなることで人間の存在を示すことができますし、またデバイスを通じて人間は直接知覚できない電波からの情報を知ることができます。

### デバイスがもたらす排他性

ネットワーク・サービスは、スマートフォンにアプリケーションをダウンロードしたり、あるいはウェブ・ブラウザからアカウントを作れば、すぐに利用ができます。いくつものソーシャル・ネットワーキング・サービスを平行して利用することは、ありふれたことです。

しかし、腕時計を2つ身につける習慣がないように、装着するデバイスには、1つ装着していれば2つ以上は装着しない排他性があります。アプセサリのサービスは、デバイスを通じて取得したデータが必要です。つまり、デバイスが情報取得の排他性をもたらします。ある1社の製品を使いはじめると、デバイス排他性とさらに利用するほど蓄積するデータが生み出す価値とが、利用者をサービスにより強く結びつけます。













## アプセサリとプロトタイピング

Bluetooth low energyの登場と普及したスマートフォンから生み出されたアプセサリという造語について、その特徴や事業化そしてデータの流れについて見てきました。従来からあるハードウェアであっても、それがアプセサリとして活用されると、いままでになかった新しい価値を生み出す要素になります。

なにが価値なのかは、実際に体験をしてみなければ本当にはわかりません。ソフトウェア開発方法では、最初の団塊で大まかな仮の物を作り、それにユーザの要求うを繁栄させて完成される試作開発のことを、プロトタイピングと呼びます。

ここでは、アプセサリのプロトタイピングを見ていきます。


### プロトタイピングとハードウェア

プロトタイピング(Prototyping)は、プロトタイプ(Prototype)を作り、早期に設計などを検証する手法です。とくに、参加者の分野が様々なブレインストーミングでは、お互いの認識のすり合わせにプロトタイプが使えます。

これは著者個人の体験ですが、粘土をこねて外形を作った、あるいはiPhoneで機能するプロトタイプを作り、それを手で触れていると、そこから驚くような発見や広がりそして展開が、急速に出ます。アプセサリの魅力は、アクセサリとアプリケーションの連携が生み出す体験です。形あるプロトタイプに触れる体験を通して、その背後にある形のないアプセサリの体験を、肌で感じられます。

形があると、つい目を奪われますが、、しかしアクセサリはアプセサリの要素にすぎません。アプセサリの体験という大きな絵を見るための、ジグソーパズルの1つのピースとして、役立ちます。

プロトタイピングにかける期間は、できればブレインストーミング中に作製、時間がかかるならば、前回のブレインストーミングの内容を覚えていて、過熱した頭が冷える程度の期間、例えば2〜3日程度、が望ましいでしょう。体験ができればいいので、実際に実装する必要はありません。その期間でできることを、工夫します。ネットワーク・サービスが必要ならば、決め打ちの画面や、紙に書いた画面をカメラで取り込んだものでも、十分でしょう。Bluetooth LEデバイスは、iPhoneのセンサで間に合うことがほとんどで、また市販されている試作用のBluetooth LEデバイスもあります。

ブレインストーミングでアイディアを出しつくしたならば、そのなかから、面白さや楽しいさ、事業として継続できるかなどの尺度で、ふるいにかけます。アイディアのなかには、必要とするセンサが販売されていない、非常に高価な部品を必要とする、電池や回路の工夫ではどうにもできない形状や大きさを求めている、ものがあります。プロトタイプにはいる前に、そのような明らかに実現不可能なものは、実装についての知識がある担当者が、メンバーにその理由を説明して、変更を加える、もしくは不採用にします。

### ブレインストーミング

アプセサリは、何が正解か誰も知らない、新しいものです。そのため、アプセサリの企画では、ブレインストーミングという会議方法をとることがあります。ブレインストーミングは、参加メンバーがアイディアを出しあい、そのアイディアを批判せず前向きに展開し続けることで、アイディアの連鎖反応や発想の誘発を期待する会議手法です。

しかし、Bluetooth LEに限りませんが、会議方法に工夫をこらして長い時間を費やしても、成果が出ないことがあります。多くの素晴らしいアイディア、それらの検討結果、そして膨大な議事録は残ります。しかし、その結果が事業として実行されず、何もユーザの手に渡らないならば、それは成果が出せなかったことになります。

新規事業を立ち上げる目的は、新たな利益の源泉を得ることです。そのために、これまでにない製品もしくはサービスを考えます。この、考える、がくせものです。企画会議の参加者は、営業、技術開発、製造、ときには経営など、背景知識や立場が様々です。メンバー間で、メンバーの考え方、背景知識、着目している領域を、お互いに確認を取り合える、高い議論の能力が、参加者全員に求められます。

分野をまたぐ協業には、技術でできること/できないことを判別する知識、あるいはBluetooth LEの規格を作る過程ですでに考え尽くされている、利用分野や利用場面の知識の、共有が必要です。技術でできることそれ自体は、誰が考えても、同じものに行き着きます。そのようなものは、自分で考えなくても、知識を持てばよいだけです。

ブレインストーミングは、突飛なアイディアも否定せず前向きに議論を展開していくのが、肝心です。それが会議にならないように、また、議論の焦点だけはあわせることが、主催者の手腕の見せ所です。例えば、ハードウェアの機能を話していて、その大きさに影響する議論がでてきたとします。このとき、大きさは外形デザインに影響するからと、いきなりデザインの話を切り出す人がいたとします。デザインの話に切り替わるのはよいのですが、しかしデザインの話だと節目をつけてメンバー全員の頭を切り替えないと、終わることのない楽しい雑談会の始まりになります。

### アクセサリと会社設立

OEMおよびODM会社も登場して、アプセサリでの市場参入障壁は、ますます低くなってきています。しかし、ハードウェアを扱うと、たちまち個人では扱いきれない何千万円ものお金や物を扱わねばならなくなります。

ヒト・モノ・カネが、事業の3要素と呼ばれます。現在はこれに、情報や時間を付け加えることもあります。会社は事業要素を扱うための器です。アプセサリを始めるために、会社の中で独立した組織を立ち上げたり、あるいは新しく会社を作ったりします。

会社内で事業を始める場合は、かならず代表取締役社長直属の組織にします。また外部からアプセサリを売り込む場合は、かならず代表取締役社長に売り込みます。

社内で組織を立ち上げた時に、もしも命令権限が他人にあると、なにかやりたいことがあるたびに、内容報告や相談と命令発行のお願いが発生します。命令権限が自分自身になければ、アプセサリは必ず失敗します。

新規に会社を作るならば、会社の継続条件である、お金の支払い能力に注意します。

どのような会社であっても、どのような失敗をしても、お金の支払い能力があるかぎりは失敗にはなりません。また、世の中には名前を出すだけで銀行から多額の融資が受けられる一族の方もいます。成功された方が若年であることは、若年であれば成功することを意味しません。

アプセサリの分野では、クラウドファンディング ( Crowdfunding ) がよく利用されます。群衆 (crowd) と資金調達 (funding) を組み合わせた造語で、インターネットで不特定多数の人から資金や協力を集めることを指します。ソーシャル・ファンディングとも呼ばれます。アプセサリには、ハードウェアという形あるものがあるので、投資への見返りに最初に製造した製品が使われます。

### アクセサリとOEMとODM

世の中には多種多様な製品がありますが、すべての会社が自社で製品しているわけではありません。

様々な分野の製品に、生産に特化した OEM ( Original Equipment Manufacturer ) と呼ばれる会社があります。ブランドを持つ会社は、OEMに製造を委託し、OEM会社はいくつもの会社の受注をまとめて大規模な生産をすることで、低価格での生産を実現します。また、OEMをもう1歩進めて、設計まで担う ODM ( Original Design Manufacturer ) もあります。

OEM会社またはODM会社は積極的に利用すべきです。アプセサリで、ハードウェア部分をゼロから開発すると、設計や検証そして製造方法の確立に莫大な費用と時間がかかります。既存製品がある分野であれば、OEMやODMを利用することで、その費用と時間を省略できます。

どのような製品にどのようなOEM会社があるかは、半導体を扱う商社に聞くか、あるいは製品分野ごとにある展示会の出展者を調べていけば、わかります。例えば、フィットネスで使われる胸に巻く心拍計は、各社の製品を並べてみても、製品仕様や外観がよく似ています。これは各社がOEM会社を利用しているからです。

また、スマートフォン連携に向けたODM会社も登場してきています。例えば、心拍計は、フィットネス分野ではスマートフォン登場以前から広く使われてきました。心拍計のOEM会社にとっては、フィットネス分野で急速に広まるスマートフォン連携に対応すれば、自社販売量を急激に伸ばすことができます。逆に対応が遅れれば、スマートフォン連携を強みにした他社が、シェアを取ります。

フィットネス分野は Bluetooth low energy が普及する市場として最初から注目されていました。ですから、はやくから心拍計のプロファイルが採択されていました。ODM会社は、規格に定義されたプロファイルを実装した心拍計と、そのプロファイルに対応するアプリケーションを開発するライブラリをセットにして提供します。これらは規格で決められていますから、従来の心拍計と同じく、同じものを複数の会社に販売することができます。

アプセサリの分野では、ゼロからの製品開発を支援するODM会社が登場してきています。これは、将来の製造需要を取り込む目的で、できたばかりの会社に設計まで支援するものです。試作と製造は求められる設計要素がまったく違います。これらのODM会社は、蓄積した製造経験に基づく製造可能な設計まで提供できることが強みになります。

またアプセサリ分野での、OEM会社またはODM会社になる考え方もあります。これはハードウェアを製造せず形のない知的財産を提供しているものもODM会社といえます。

例えば、歩数計や活動量計は、加速度の値から歩数や消費カロリーを算出します。この信号処理はこれ自体が知的財産であり、また算出結果が妥当なものかを検証するなど、開発には大きな費用かかるものです。ですから、歩数や活動量の算出機能をいれた無線通信モジュール、あるいはソフトウェアそのものが販売できます。

また、アクセサリというハードウェアを販売してきた会社は、サーバーの設置や運用、そしてアプリケーション開発を、経験がないからと避けようとします。サーバーを運営まで含めて提供するODMも可能です。

また、OEMあるいはODM会社になるほうがよい分野もあります。

例えば、メガネの機能はそのままで、フレームに機能を追加したアプセサリがあるとします。メガネですから、利用者にあったレンズをフレームにはめる必要があります。このため、通常の眼鏡と同じように店頭で販売する必要があります。

販売店舗を全国に展開するには巨額の資本が必要です。ですから、そのようなアプセサリであれば、メガネのフレームのODM会社になるべきでしょう。

### ハードウェアとソフトウェアの開発体制

アプセサリのiOSアプリケーションは、ハードウェアと密接につながります。そのため、通信部分とドライバ相当は、両方をよく理解して協調して設計することが大切です。Objective-Cもできるハードウェア開発者が担当することが最適です。

iOSアプリケーションからみて、ハードウェアが期待した振る舞いをしないときは、問題がどこにあるのかを切り分けることが困難です。原因は、iOSアプリケーションのドライバ層の使い方の間違い、Bluetooth LEの通信、ハードウェアの設計、これら4つのどれかにあります。しかし、iOSアプリケーション開発者からは、通信以降を調べる手立てがありません。それらを調べられるのはハードウェア担当者です。

なにかおかしいことが起きた時に、原因箇所の特定には時間がかかります。このときに、ハードウェアの振る舞いを確認できるデモンストレーション・アプリケーションを作製しておけば、iOSアプリケーションとドライバ相当部分が原因かそうでないかが、すぐに切り分けできます。iOSアプリケーション以外に原因があるときは、通信プロトコルを見たり、ハードウェアの設計内容を確認していきます。それはハードウェア設計の担当領域です。

### ハードウェア設計

- Made for iPhoneプログラムは不要
- 部品代は5ドル、モジュールは10ドル前後
- モジュールを利用した場合、電波法の認証及びBluetoothの認証費用はかからない

 Bluetooth low energy は、[Made for iPhone (MFi) プログラム](https://developer.apple.com/jp/programs/mfi/) の締結が必須ではありません。クラシックBluetoothでは、特定のiOSアプリケーションと接続するデバイスの開発には、Apple社とMFiプログラムの締結が必須でした。MFiプログラムを締結して初めて、ハードウェアやソフトウェアの開発情報が提供されます。

MFiプログラムが必須ではなくなったことで、ベンチャーの参入ハードルが極端に下がりました。 Bluetooth low energy デバイスと接続するiOSアプリケーションは、AppStoreの承認を得られます。ただし、デバイスにMFiロゴを掲載する場合は、ロゴの使用権を得るためにMFiプログラムの締結が必要です。

 Bluetooth low energy の電子回路を独自に設計した場合の製造コストは5ドル程度です。これらの電子回路を小さな基板にまとめて部品化したものを、モジュールと呼びます。モジュールの価格は10ドル前後です。

モジュールを使うことで、電波法の基準認定とBluetoothの規格認定および製品登録にかかる初期費用が省けます。

電波を出す回路は、外部に電波がもれ出ない試験環境で動作させるか、あるいは、それぞれの国ごとの電波法に基づく基準認証をうけなくてはいけません。認証を取得しているモジュールを利用すれば、製品ごとに認証をとる必要はありません。

また、 Bluetooth low energy ロゴを表示して販売するには、Bluetooth SIGへの製品登録が必要です。製品登録には、Bluetoooth SIGへの、最低でも年間5000ドルのメンバー登録費用と、設計ごとの認証費用が必要です。

各社のモジュールは、それ単体でのBluetoothの製品登録が完了しています。無償のBluetooth SIGのメンバー登録をおこない、 Bluetooth low energy のモジュールを利用した派生製品として登録すれば(この登録は無償)、製品登録が完了します。

### アクセサリの実例

アプリケーションやネットワークそして事業までを統合したアプセサリは、まだ少なくこれから登場するでしょう。アクセサリ自体は、2012年の夏あたりから次々登場しています。いくつかを紹介します。

1つは、プロトタイピングのための開発キットやアクセサリです。これらは、早い時期から登場しています。まずBluetooth LEの半導体やモジュール会社が、組み込み機器開発者向けキットの提供を開始しました。iOSアプリケーション開発者のなかにも、Bluetooth LEデバイスの開発をしてみたい要望があります。次に登場してきたのが、その要望にあわせて、組み込み機器開発者でなくても使いやすい、より安価な開発キットです。

日本の技術基準適合証明を取得しているプロトタイピングに向いたものに:

* SBBLE(サブレー) [http://sbble.micutil.com](http://sbble.micutil.com)
* Konashi [http://konashi.ux-xu.com](http://konashi.ux-xu.com)
* センサータグ [http://www.tij.co.jp/tool/jp/cc2541dk-sensor](http://www.tij.co.jp/tool/jp/cc2541dk-sensor)

があります。

SBLBLE(サブレー)はマイクロチップ・テクノロジー・ジャパン株式会社のPICマイコンを採用した開発キットです。市販のUSB Bluetooth4アダプタを挿して使います。Konashiは、iOSアプリケーション側の開発がObjective-Cに加えてJavaScriptでも開発できます。ウェブ・サービスの開発者が、フィジカル・コンピューティングをiOSでおこなう場合の唯一の選択肢です。センサータグは、テキサス・インスツルメンツ社の半導体の評価キットで、25ドルと低価格です。次のセンサを搭載しています:

* 放射温度センサ、温度センサ
* 湿度センサ
* 圧力センサ
* 加速度計
* ジャイロスコープ
* 磁力計

必要なセンサが上記にあるプロトタイピングであればセンサータグを、LEDの点灯など低速の外部装置制御をiPhoneから行うならKonashiまたはSBBLEを、任意のファームウェアを開発したいときはSBBLEを選択するとよいでしょう。

キーホルダーまたはタグは、よくあるアクセサリです:

* キーホルダー、
[iPhone用探せるキーホルダー](http://buffalo.jp/products/catalog/supply/bluetooth/bluetooth/security/bshsbtpt01/)
* StickNFind [https://www.sticknfind.com](https://www.sticknfind.com)

キーホルダーは、iPhoneと接続して使うものです。iPhoneを置き忘れしそうになった時にキーホルダーから警告音を出したり、キーホルダーのボタンを押すとiPhoneから音が出る機能でiPhoneを探すのに利用します。タグは、代表的なものにStickNFindがありますが、ものに取り付けておいて、ものを探すのに使うものです。その機能は、キーホルダーのボタンを省略したもので、おおよその距離をiPhoneで確認すること、iPhoneから操作してタグから音や光を出すこと、ができます。

たいていのキーホルダーやタグは、仕様が公開されていたり、ソフトウェア開発キットが提供されていて、アプリケーション開発に利用ができます。近接検出または光や音の出力を必要とするプロトタイピングに利用できます。

この他にも:

* 心拍センサ、 [Alpha](http://www.alphaheartrate.com)
* 活動量計、[Fitbit](https://www.fitbit.com)
* 睡眠記録、[オムロン ねむり時間計](http://www.healthcare.omron.co.jp/corp/news/detail/223)
* 姿勢検出、 [Lumoback](http://www.lumoback.com)
* 腕時計、[Pebble](http://getpebble.com)
* 顔検出、[HVC-C1B](http://plus-sensing.omron.co.jp/egg-project/)

などが市販されています。

アクセサリに直接アクセスできるSDKを提供するもの、アクセサリに直接アクセスするAPIはなく、ウェブ側に蓄積されたデータにアクセスするAPIを提供するものなど、APIやSDKの公開は、製品ごとにまちまちです。










## まとめ

2000年までの無線通信技術は、ほとんどがストリーム通信での定義された制御コードのやりとりでした。Bluetooth low energy は、ものが持つデータを表現するためにデータベースの仕組みを備えたことで、多種多様なものに無線通信を付加する強力な技術となりました。

また、無線通信には必ず通信相手がいます。iOS が開発環境を一般開発者に開放したことで、世界に広く普及したiOSデバイスが通信相手となりました。さらに、ハードウェアの設計および製造支援サービスや、クラウドファンディングの盛り上がりも後押しとなり、いまも様々なアプセサリが生み出されています。

Bluetooth low energy は、スマートフォン連携機能や、アプセサリを作る上での重要な技術として、いままで実現できなかったことを実現できるようにする鍵となる、使える技術です。

道具は手段です。高度に発達した技術が、たとえ魔術のように見えたとしても、それは術であるかぎり学び理解すれば、誰にでも使える手段です。しかし、どのような術であれ、その術を普及させて日常生活に溶けこませことができれば、それは魔法に見えるのかもしれません。その手に魔法を。









































































