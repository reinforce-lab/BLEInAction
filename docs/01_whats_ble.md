# Bluetooth Low Energy ってなに?

Bluetooth Low Energy とは、なんでしょうか。

名称に Bluetooth を冠してますが、これは Bluetooth 4.0 で統合された超低消費電力無線通信技術です。1秒にせいぜい数十回、1回にせいぜい数十バイトの通信ができれば十分だが、電池消費量は小さくしたいといった、Bluetooth 3.0までの無線通信技術ではカバーできなかった分野にむけて開発された技術です。

技術の説明だけであれば、これだけです。ですが、技術は使われる場面もあわせて見ていかなければ、その価値がわかりません。また逆に、使われる場面を生み出そうとしているのに、その技術の理解があやふやで中途半端では、実現可能で価値ある場面を生み出せないでしょう。

この章は、Bluetooth Low Energy を技術とその使われ方の2つの視点から見ていきます。技術とユーザ体験は時代により変化していきます。今ある利用場面のその先を考える材料として、ここ3年間の Bluetooth Low Energy を使った周辺デバイスやサービスの変遷も述べていきます。

## 身近な Bluetooth Low Energy 

Bluetooth Low Energy という超低消費電力無線通信技術を使えば、低コストで使い捨ての電池(1次電池)で長期間動作するハードウェアが実現できること、そして、iOSが多種多様な周辺デバイスとアプリケーションをつなぐ開発環境を提供していることで、多種多様な周辺デバイスが生み出されてきています。ですが、まだ身近な存在というほどではありません。

最初に Bluetooth Low Energy を利用した周辺デバイスが登場したのは、フィットネスやサイクリングといった分野です。これらの分野では、Bluetooth Low Energy 登場以前から、運動強度を計測するための心拍センサやパワーメータといった無線接続の計測デバイスが普及していました。iOSデバイスと接続できる新たな付加価値として、これらの商品群から Bluetooth Low Energy に対応してきました。

これらの分野を除くと、Bluetooth Low Energy を使った周辺デバイスは、まだそれほど身近にはありません。新しい周辺デバイスは新しい利用場面をもたらしますが、その新しさゆえに普及には時間がかかります。電車で利用している人を見かけるほど一般に普及するには、話題になり急速に普及したとしても2~3年はかかるでしょう。

まずは、通信販売で手軽に購入ができる Bluetooth Low Energy 対応の周辺デバイスとして、フィットネスに使われる心拍計を取り上げ、そのユーザ体験と、その体験を支えている無線通信通信とアプリケーションの概要を見ていきます。

### Bluetooth Low Energy の心拍計体験

Bluetooth Low Energy が体験できる最も身近な分野は、フィットネスです。この分野では、Bluetooth Low Energy が登場する以前から、適切なトレーニング効果を得るために、ランニングや屋内トレーニングでの運動強度や心拍数の計測がおこなわれています。

体を動かしていても安定して脈拍が取れる心拍計には、胸ベルト型と腕時計型の2種類があります。

胸ベルト型は、胸に巻き付けたベルトに電極と本体がとりつけてあるもので、心臓の筋肉が動くときに生じる微小な電気信号から心拍を検出します。各社から製品が出ていますが、例えば、米国 [Wahoo Fitness L.L.C.](http://www.wahoofitness.com/)[^1010] の Blue HR および TICKR RUN などの製品があります。

[^1010]: [Wahoo Fitness L.L.C.](http://www.wahoofitness.com/) 

腕時計型は、時計の文字盤部分の裏面に発光素子と光検出センサーが取り付けてあるもので、皮膚の散乱光の強さから脈拍による血流量変化、つまり心拍を検出します。これも数社から製品が出ていますが、例えば、米国 Physical Enterprises Inc. の [Mio ALPHA Heart Rate Watches](http://www.mioglobal.com/) [^1020] があります。

[^1020]: [Mio ALPHA Heart Rate Watches](http://www.mioglobal.com/) 

これらのデバイスは各社のサイトあるいはアマゾンなどから通信販売で購入できます。入手した心拍計をiOSデバイスと接続して使う手順は、次の3つです。

1. アプリケーションのインストール
2. iOSデバイスと心拍計との接続
3. 心拍数の計測

まずiOSデバイスにアプリケーションをインストールします。AppStoreで検索すると Bluetooth Low Energy の心拍計に対応したiOSアプリケーションが数多く見つかります。心拍計を販売する会社が自社製品を使うために提供しているものや、トレーニング専用アプリケーションが心拍計測にも対応しているものなど、アプリケーションの開発元も提供目的も様々です。

ここでは Bluetooth Low Energy の半導体を開発販売しているノルウェーの [Nordic Semiconductor ASA](http://www.nordicsemi.com) [^1030] が出している [nRF Toolbox](https://itunes.apple.com/jp/app/nrf-toolbox/id820906058) [^1040] を使います。

[^1030]: [Nordic Semiconductor ASA](http://www.nordicsemi.com)
[^1040]: [nRF Toolbox](https://itunes.apple.com/jp/app/nrf-toolbox/id820906058)

<!-- 図を入れること、a)アプリケーション画面、b)BT設定ダイアログがでているところ、 c)心拍の画面 -->

実際に心拍計に接続してアプリケーションから利用してみます。

まず、アプリケーションをインストールします。次に、iOSデバイスと心拍計を接続して、心拍値を見てみます。アプリケーションを立ち上げると、デバイスの種類を選択するアイコン一覧画面が表示されます<!-- a)アプリ画面 -->。この画面中央にある下にHRMと書かれたハートマークのアイコンをタッチして選択します。このHRMは、heart rate monitor 心拍計の略称です。


ここで心拍計を装着します。Bluetooth Low Energy は超低消費電力無線通信技術ですが、周辺デバイスが常に電波を送信するように作られているかどうかは、設計次第です。心拍計のような利用している間だけ無線接続ができればよいものは、装着して心拍計測している間だけ無線通信するように設計されてるものが多いです。

胸ベルト型の心拍計であれば、たいていは、装着されて皮膚に接触したことを検出した心拍計が、自動的に計測と無線通信を開始します。腕時計型のMIO ALPHAであれば、本体右側のボタンを長押して心拍計測を開始することで、計測と無線通信が開始されます。

心拍計の計測を開始したなら、心拍計のモニタ画面<!-- c)心拍の画面-->の下にある"Connect"ボタンを押します。これでiOSデバイスと心拍計との無線接続が確立されます。

このとき、iOSデバイスの Bluetooth がオフだと、Bluetoothをオンにしてくださいというダイアログが表示されます<!-- b)-->。このダイアログの"設定"ボタンを押すか、あるいは自分で設定アプリを立ち上げて、Bluetoothの電源をオンにします。

心拍計が無線通信を開始していて、iOSデバイスのBluetoothがオンになっていれば、デバイスの一覧リストに心拍計があるはずです。デバイスを選択すれば、iOSデバイスと心拍計の無線接続が完了して、一定時間ごと更新される測定値が数値とグラフで表示されます<!--c-->。

従来のBluetooth3.0までの周辺デバイスと違い、Bluetooth Low Energy の周辺デバイスの発見および接続と切断は、すべてiOSアプリケーションから操作ができます。

また、アプリケーションがバックグラウンド状態になっても無線通信を継続できます。ですから、別のアプリケーションに移動したり、あるいはロック画面が表示されても、nRF Toolbox のアプリケーションはデータを受信し続けられます。

画面下の"Disconnect"ボタンを押すと、iOSデバイス側から心拍計との無線通信を切断します。あるいはiOSデバイスから遠くに離れて電波が届かなくなると、無線通信は切断します。

無線通信が切断すると、心拍計は再接続ができるように再接続のための電波を送信し続けます。ですから、iOSデバイスに電波が届く範囲にはいれば、心拍計を再発見して自動的に再度接続するiOSアプリケーションが作れます。

残念ながら、この nRF Toolbox のアプリケーションは、自動で再接続するようには作られていません。そのため、ユーザが画面下の"Connect"ボタンを押して再接続させます。

### クラシックBluetoothでの体験

本書は、Blutooth Low Energy を統合した Bluetooth4.0 と、それ以前の Blutooth Low Energy を含まないBluetooth3.0までのBluetoothとを区別するために、Bluetooth3.0 までの Bluetooth を、クラシックBluetooth と呼ぶことにします。

もしも心拍計をBluetooth3.0 までの技術、クラシックBluetooth の技術で作ると、どんな体験になるかを見てみます。

アプリのインスト、無線接続、利用、一緒。
ただし設定画面のみから、ユーザが、
無線接続と切断はユーザが行う。

アプリの開発、特定の製品に対して。開発。"心拍計"というジャンルは、クラシックBluetoothには、ない。iPhoneの開発になるから。

信頼できる機器だと、4桁もしくは6桁の数値(PINコード、ピンコード)を入力して接続。(ペアリング)

2年程度は通常の使い方で、電池は1日は持たない。充電式。
アプリケーションの対応が必要。ちょっと特別。

細かいところ、製品にMFiのロゴマークが掲載されている。


























Bluetooth Low Energy を採用した心拍計の体験を支える技術を見る前に、これまであった 
































#### クラシックBluetooth の無線通信技術

まず、クラシックBluetooth の無線通信技術を見ていきます。

当然のことですが、無線通信は電波で情報をやりとりするので、電波でデータを送受信する2つの何かがあって初めて通信が成り立ちます。そしてユーザには、2つのデバイスが無線で通信をして期待する動作や機能をすることが、当然だと思われます。

この当然を実現するには、2つのそれぞれのデバイスに:

1. お互いを発見する仕組み
2. 無線通信をする仕組み
3. データをやりとりするタイミングおよびデータの意味と機器の振る舞いの定義

の3つの仕組みが必要です。

このうち1と2は、Bluetoothに限らず無線LANなど、一般的な無線通信が必ず備えている仕組みです。3は、無線で接続した2つのデバイスが相互に機能するために不可欠な要素です。

パソコンであれば、インストールするアプリケーションで、様々な機能に対応できます。ですが、Bluetoothを採用する周辺デバイスは、設計時点で機能に合わせてハードウェアとソフトウェアが作り込まれる装置です。ですから、あとからソフトウェアを入れ替えて機能を変更することが、できません。ですから、この3が相互接続のために重要なのです。

<!-- TBD Bluetoothのロゴマークを掲載 -->

クラシックBluetooth は、より早い通信速度でより低消費電力で、隣り合うデバイスを無線で接続する技術として発展してきました。イメージとしては、電気配線のための電線を文字通りワイヤレスにするための技術、と思えばわかりやすいでしょう。

クラシックBluetoothでは、ヘッドセットやキーボードといった応用機器の種類や用途ごとに、通信と機器の振る舞いを決めていて、それをプロファイル(Profile)と呼びます。

そして、所定のプロファイルに適合していると認定をうけたデバイスに、 Bluetooth の青色のロゴマークの表示が許されます。これらがあるおかげで、ユーザはBluetoothのロゴを見るだけで、それが何年も前に開発されたデバイスであっても、開発販売している会社が聞いたこともない会社であっても、それらのデバイスを無線で相互接続して使えるのです。

#### クラシックBluetooth のプロファイル

クラシックBluetoothは、通信と機器の振る舞いをあわせて1つのプロファイルとして定義して、規格としているところが、ポイントになります。

通信には必ず、通信速度と遅延時間、2つの要素、


使ったiOSデバイスの周辺デバイスの仕組みを見ていきます。
これが クラシックBluetooth の無線通信技術の概要です。





月まで往復、
パケット(データの小さい塊)やりとりするタイミング、
実質の通信速度



Hands-Free Profile(HFP)
Advanced Audio Distribution Profile (A2DP)

通信はかならず

つなぐ技術

無線通信は必ず相手。
機器の振る舞い。
通信の性質。電話するときのヘッドセット、データが欠損しても、再送しない。相手の話が遅れてはしかたない、リアルタイム。音質はそれなり。音楽を聞くときのヘッドフォンでは。遅れる時間があってもいいけど、ぶっつっときれてはしかたない。

#### クラシックBluetoothとiOSの周辺デバイス

アプリとハードの構造。
SPP。
デバイス間、どのアプリ? 判定。正しいハードウェアなのか?
ただの通信路。

クラシックBluetooth を使うiOSデバイスの周辺デバイスは、Apple社とMade for iPhone Program (MFi Program、エムエフアイ・プログラム)という秘密保持契約を締結することで、初めて開発ができます。

通信を維持するだけで ~10ミリアンペア (mA)。
1500ミリアンペア時 (mAh)。電圧変換とかあるから、正しくないですが、目安として 150時間程度。

12 x 28 x 5.7 mm 110mAh 
12 x 16 x 5   mm 40mAh


通信規格が違う。

ハードウェアが違ってくる。機能と振る舞い。

アプリケーションの作り方が違う。
MFi、外部アクセサリのフレームワークとCoreBluetoothのフレームワーク。
通信制御の振る舞いが違う。アプリが完全にもっていける。PIN入力がない、接続と切断がアプリ管理。バックグラウンドで通信しつづけられる&発見、接続切断も。

Bluetooth3.0までの、
クラシックBluetoothで作ったらどうなるか。

作りやすさ。
MFiが不要。電波法とか電磁放射、その他規制やら認定やら。
多種多様なデバイス、
アプリケーションが全てを牛耳っているから、
電池消費量、使い捨てとか、半年程度。

ハードウェア、
心拍を検出、電位で、信号処理とか。増幅とかアナログの。

無線通信、
せいぜい1秒に50回。その時に、変更があれば。通信は、スループットとレイテンシ(遅延時間)。
無線通信する時間を極小。

サービスとキャラクタリスティクス。
ATT/GATT。モジュール化。値の変更。機能と振る舞いを分離している。
キャラクタリスティクスは、センサ値、機器の制御目標値と内部状態。

プロファイル、
標準プロファイル。かってなカスタムプロファイル。

アプセサリ
売ってからが大事。体験。














### アプセサリと心拍計

ここまでの心拍計の体験では、心拍値がiOSデバイスでみられるだけなのかと思うでしょう。そのとおりです。それは、nRF Toolbox が心拍計測のデモンストレーション用アプリケーションで、これは周辺デバイスの体験だからです。アプセサリの体験ではないからです。

Bluetooth Low Energy の周辺デバイスとアプリケーションとが連携して、はじめてアプセサリになります。例えば、ランニングのアプリケーションであれば、心拍値をもとにユーザにトレーニング内容の音声ガイダンスが流せます。また、心拍数をずっと計測しつづけることで、ストレスや心理状態まで推定するアプリケーションが作れるかもしれません。

このように、心拍計というデバイスが1つ登場するだけでも、iOSデバイスの活用場面が無数に生まれます。

ですが、iPhone自体に心拍計測機能が搭載されることは、ありえないでしょう。というのは、安定して心拍を計測し続けるには、腕時計型にしろ胸ベルト型にしろ、デバイスがユーザの皮膚と接触していなくてはなりません。ですが、肌にiPhoneが触れ続ける利用場面は、ランニングのように限られた場面ではあるかもしれませんが、一般的ではありません。

利用場面が限られて一般的ではなかったり、あるいは物理的に設置できないためiOSデバイスには搭載されない機能でも、無線でiOSデバイスにつながる周辺デバイスがそれらを提供することで、iOSデバイスだけでは生まれない可能性が生まれるのです。

また、心拍計というデバイスがiOSアプリケーションと連携することで、これまでなかった心拍計の活用場面が生まれます。

トレーニングでの活用はもちろんですが、iOSアプリケーションがあることで、心拍計というハードウェア単体では実現ができなかった、計測値の記録保存や解析、またネットワーク・サービスとの連携が可能になります。例えば、何百万人ものユーザの年単位での計測データがネットワーク・サービスに蓄積していれば、それらを統計的に解析することで、ユーザそれぞれの疲労度やストレスを数値化して、ストレッチング運動などでそれらを低減していく、新しいサービスが生まれるかもしれません。

周辺デバイスは、購入しやすい価格で製造するために、メモリや処理能力はなるべく小さく設計されます。また、そのデバイスが破棄されれば、内部に保存されたデータも失われます。しかしiOSアプリケーションと連携することで、単なるデバイスでは実現できない膨大な記録容量や処理能力が使えます。さらに、データがネットワーク側に保存することで、デバイスの寿命を超えてたユーザ・データの蓄積が可能となります。

そして、アプセサリとなった周辺デバイスは、もはや単なるハードウェアではなく、提供サービスの重要な1要素になります。

例えば、トレーニングのネットワーク・サービスを考えてみます。iOSアプリケーションそしてネットワーク・サービスに、心拍や走行距離などのユーザ・データが記録蓄積されます。これらのデータがあると、同じサービスを利用するユーザ間での競争や、あるいはFacebookやTwitterなどのソーシャル・メディアで達成度を共有するユーザ体験が提供できます。

蓄積されたユーザ・データは、そのサービスを使い続ける大きな理由になります。例えば、ユーザのトレーニング・データは、サービスそれぞれが独自形式で蓄積していますから、あるサービスから別のサービスにデータを移し替えることは困難です。ですから、蓄積したデータを捨て去りゼロからデータを蓄積してまで使いたくなる魅力でもないかぎり、ユーザがサービスを変更することはないでしょう。

周辺デバイスはネットワーク・サービスの収益構造を変化させます。ユーザはサービスを利用するために周辺デバイスを購入するので、周辺デバイスの売上がネットワーク・サービスも含むサービス全体の売上となります。そして周辺デバイスは、適度な周期で買い替えられます。

例えば、心拍計や活動量計などの身につける周辺デバイスは、洗濯したり落としたりして破損したり置き忘れて紛失します。ユーザは自分に責があると納得して再購入します。また、使用するうち自然と汗で汚れたり塗装がはげ外観が劣化します。1年ごとに外観デザインを変更した新モデルが出れば、外装の劣化は新モデルに買い換える理由になります。

周辺デバイスはアプセサリですから、新しく周辺デバイスを購入してデバイスを変更しても、それまでの蓄積データはそのまま利用でき、体験が引き継がれます。





## iOSの Bluetooth Low Energy 体験

#### キーワード、多様性、普及インフラ、アプリケーション、エコ・システム
#### ユーザ所有、公共物。接近、個人所有。サービスとの連携。HomeKit、HealthKit。ドライバ。

Bluetooth Low Energy の活用には必ず3つの要素、周辺デバイスというハードウェア、Bluetooth Low Energyという無線通信技術、そしてiOSアプリケーションとネットワーク・サービスが登場します。ハードウェアとソフトウェア、そして通信と3つの分野をまたぐので、そのすべてを詳細まで理解するのは大変です。

ですが、アプセサリの魅力は、これら3つの要素のかけ算で生まれます。ですから、アプセサリの素晴らしいユーザ体験を生み出すには、どれか1つの分野の専門家であるだけでは不十分です。お互いの領域の概要をも知ることが、必要です。

前節で心拍計を例にして、周辺デバイスとアプセサリの違い、そしてアプセサリのユーザ体験とサービスの収益構造の1例を述べました。この例から分かるように、技術に関わる領域であっても、エンジニアに限定せずチーム・メンバー全員で概要を共有することが、プロジェクトの成功に必要です。

アプセサリを支える技術の概要を見ていきます。

### 無線通信と相互接続

前節で心拍計をiOSデバイスに接続して、心拍を計測しました。このときに、2つのデバイスがどのような通信をしているのかを、デバイスの立場になってみます。

まず、ユーザの目には2つのデバイスが見えています。ですが、デバイスには目はありませんから、お互いが近くにあることが分かりません。2つのデバイスの間で電波を送受信しあって、はじめてお互いに存在がわかります。ところが、人間の目や耳では、この電波を知覚できません。この違いがあるために、目の前にデバイスが見えているのに無線接続ができなくてイライラすることが起きます。

#### デバイスになりきった通信体験

2人の人間がデバイスになりきって無線通信をシミュレーションしている場面を想像してみます。1人をA、もう一方をBと名づけましょう。AもBも、目をつむり耳と口だけで会話しようとしている状況です。耳で聞くことが電波の受信、口で話すことが電波の送信にあたります。

通信には必ず通信相手がいます。ですから通信は、まず相手を見つけることから始まります。まずAが、自分はここにいるよと話してから、Bからの返答がないかを聞きます。いっぽうBは、Aの声が聞こえないからをじっと聞きつづけていて、Aの声が聞こえたら、適切なタイミングで、私もここにいるよと返答します。

これで、AとBがお互いの存在を発見できました。じつは、AもBも、自分が話している間は自分の声が邪魔をして、相手の声を聞き取れません。そのため、相手を発見してから通信しつづけるために、お互いが話を始めたり聞いたりするタイミングを示し合わせます。

Bluetooth Low Energy では、一定時間ごとにBが、おーいA、と呼びかけます。AはBの呼びかけを聞いてから、聞いているよとか、新しいデータがあるよとか、返答をします。

ここまでの、AとBがやりとりを続けられている状態が、無線接続している状態です。

このAとBしかいない状況は、実際にはありえません。

2.4GHz、80MHz、2MHz、40個のチャンネル、同時に
チャンネルを次々と切り替えていく(ホッピング)、
使えないと分かっているチャンネルを、最初に示し合わせておいて使わない(アダプティブ・ホッピング)

#### Bluetoothの相互接続

Bluetooth は近くにあるデバイスとの無線通信と相互接続の技術です。無線通信を通して、接続したデバイスの機能が使えなければなりません。

例えば、Aが心拍計の機能をもっているとします。Bは通信を通じて、Aに心拍計の機能があることを知り、そしてAの使い方にしたがって通信のやりとりを行い、Aから一定時間毎に心拍値を受け取ってはじめて、BはAの機能を使えたと言えます。

パソコンであれば、アプリケーションを選んでインストールできるので、電子メールの送受信であれば電子メールのアプリケーションを、音楽や動画を視聴したければストリーミング再生のアプリケーションをインストールすれば、通信を介してサービスを利用できます。もしも将来に新しい技術が普及しても、その新しい技術が使えるアプリケーションをインストールすればいいのです。

<!-- 後方互換性 と未来-->
ですが、Bluetoothを採用する周辺デバイスは、その機能とハードウェアが、パソコンでいうアプリケーションに相当するプログラム部分といっしょになって機能するよううに設計されます。ですから新しい技術が登場しても、ハードウェアは製造後に変更できませんから、対応はできません。



ハードウェアは変更できないので、パソコンのようにアプリケーションをインストールした対応


新技術が出たからといってもハードウェアは変更できませんし、またハードウェアといっしょになって動くように設計されているアプリケーション相当部分の更新は、

ハードウェアは変更することはできませんから、

ハードウェアの機能と

がいっしょに設計されるので、新技術が出たからといって製造後に新技術変更することはできません。

#### サービスとキャラクタリスティクス

用途に応じてアプリケーションをインストールすれば、
通信を介したメールや音楽や動画の視聴をします。


ですが Bluetooth を採用する周辺デバイスは、
そのアプリケーションに相当する部分
設計時、組み込み機器なので
そのアプリケーションに相当する部分、つまり機器の
その使われ方
組み込み機器







無線接続だけでは

相互に接続するためには、そのデータがどんな意味を持っているのか、そのデータが来たらデバイスはどう振る舞うのかまで

パソコンであれば、アプリケーションをインストールして、どんな機能でもあとから追加できます。ですから、パソコンの無線LANは通信さえできればよい技術です。

Bluetooth は近くにある周辺デバイスと、無線通信をして相互接続するための技術です。

パソコンの無線LANであれば、通信さえできれば、あとはパソコンにインストールするアプリケーションで

パソコンの無線LANであれば、通信





どんな機能があるのかを知ったり、

お互いに意味があるやりとりをするためには、データの意味



無線LANと違い
無線通信
Bluetooth はすぐ近くにあるデバイスとの無線通信技術です。
無線通信技術

<!-- 無線通信は過酷 -->

相手がいついなくなるか、わからない。
省電力、聞くだけでも電力をくう。むしろ聞くほうが、電力をくう。テンプレの電波を出せばいいだけじゃないから。信号レベルもわからない。桁違い。実際に無線の受信信号の電力は8桁。

他の方式、自分たち。

<!-- 通信規格は -->


お互いがいなくなるかもしれない、Cの話し声で、AとBの会話が途切れるかもしれない。
省電力
次はAとBが通信をし続けます。
AもBも、自分が話している
次はAとBがお互いに通信をし続けるために、タイミングをどうするかを示し合わせます。


次は、お互いが話したり聞いたりするタイミングを示し合わせます。

聞くのと話すのは同時にはできません。

ですから、Aは話したあとに、Bの返答がないかを聞きます。

どちらかが、自分はここにいるよ、と話します。自分の声が聞こえる範囲に相手がいれば、私もここにいるよ、と返答してくるはずです。ですから


自分の意味、話すタイミング、聞くタイミング、聞き役、話し役、ルール。
Bluetooth Low Energy 通信規格

相手を見つけるには、どちらかが、自分はここにいるよ、としゃべり続けます。
聴き続けます。

それぞれの人は、
、周りにあるだろう他のデバイスと会話しようとしている状況です。




お互いに会話するためには、1. 耳で聞くことと話すことができる、2. お互いに話すのと聞くタイミングがわかっている、3. 言語が同じこと、が必要です。

耳で聞くことと話すことができる、

お互いに話すのと聞くタイミングがわかっている

言語が同じこと

1. 同じ言語を話せる


発見。

あいうえおの50音、
0と1のデジタルデータ、
変調。
単語、文章。



Bluetooth Low Energy は2.4GHz(ギガヘルツ、1ギガヘルツは1秒間に$10^{9}$の振動を表す)の電磁波で通信する技術です。

という

電波の送受信でお互い
の目の前には
意思や情報を伝達すること。

目の前に、Bluetooth Low Energy で接続する周辺デバイスとiOSデバイスが2つがある。

外国語を理解するがごとく。
会話を成り立たせているのは、タイミング。同じタイミングで同時に話したら、お互い聞き取れない。

Bluetooth Low Energy の開発に用いられる受信機があれば、空中を飛び交う Bluetooth Low Energy のパケットを読み取ることもできますが、そのパケットの内容を理解するには、通信規格の知識が必要です。

ですから、目の前にある2つのデバイスが無線接続できないとき、ユーザは繋がらないことに強い不満を感じます。

電波は、人間の目には見えず、また
iOSデバイスと無線接続した周辺デバイス

Bluetooth Low Energyを採用した周辺デバイスを買ってきて、iOSデバイスに接続しようと
ユーザ
無線通信で2つのデバイス

無線で通信する技術、

 でiOSデバイスと周辺デバイスが接続する様子。
無線通信。目の前に見えている。

見つけること、伝えること、やりとりすること、

あ/い

え/お

人間の声、

同じ言語、

交互に、

喋ると、


の3つの要素を組み合わせて
初めて活用できます。

多種多様な周辺デバイスが作れる


本書を手に取られた方は、自分たちのサービスと周辺デバイスを作るために 

知識を求めている


技術の組み合わせ。


心拍計、自分のオリジナル。ハードウェア、

Bluetooth Low Energy がなにかを知るには、要素ごとの知識だけではなく、それぞれの要素がどうユーザ体験につながっていくかの、全体の俯瞰が重要です。

無線通信、ハードウェア、かなり違う。

アトリビュート・プロトコル(Attribute Protocol、ATT)
ジェネリック・アトリビュート・プロファイル

(Generic Attribute Profile、GATT

### 電波で通信する
0/1を伝える

2.4GHzと言う過酷なバンド。自分たち、他の方式。

低消費電力にする工夫。

### プライバシー、セキュリティ
電波、
暗号化。

### ATT/GATT

### iOS
バックグラウンド、
ドライバ相当部分

### 柔軟性

### 開発
ドライバ、ハード。
どっちがやるねん。
定義付け、デモンストレーション。ハードとアプリケーション。
一緒に。

### 認証
各国の電波法。FCCであれば、ECMも。部分的な認証のモジュールもあるので。
組み込みしたら、本体も。電気製品としての。
設計の性能がちゃんとしていること、製造で確認していること。
Direct modeという、電波を出すためだけの規格。

Bluetoothの認証。製造方法。
会員は有料と無償の2つ。
80万円。モジュールを利用してても。40万円。
1億円以下2年以内25万円。

### この体験を電波から見てみましょう

電波、目に見えない。人間からは目に見える。
2.4GHzっていうのは激戦区。人間には感知できない。電子レンジとかあれこれ。
発見と接続
データの読み出し、コマンド、どれを読み出すか指定して、あれこれ

発見、接続、通信、切断。



電波を出すっていうのは、それだけで電力を食う。特に受信、信号レベルが電力値で8桁も変化する。増幅率を変えて、検出する。
プロセッサの2.4GHzと同じで、電力がいるん。でも、パソコンのプロセッサみたいに、あっちっちにならないのは、回路の規模が小さいのもあるけど、常時動き続けるわけではないから。

電波を如何に出さないか、電波を如何に受信しないか。無駄に。
超低消費電力、といっても、

周りに広がるもの、電波。傍受、アタック。セキュリティ、プライバシー。



アプリケーションがないとどうしょうもない。
使い方次第、
ハードウェアの形ではなくて、機能。複合できる。


### 無線通信と相互接続




電池、12ヶ月、
3日間程度、充電必要。

無線通信が微弱だとはいえ、センサー、とかが電力を消費すれば、避けようがない。

無線通信、あれこれ。完全にタイミングを合わせて通信することで。
レイテンシ、


電波の飛び方、

近接具合
レイテンシとスループット

マスター(Master)とスレイブ(Slave)
ピコネット(Piconet )
アドバタイズメント・パケット(Advertisement packet)

無線通信の超低消費電力っぷり
	タイミングを合わせて通信することで。
	1パケットは最大37xビット。1ビットが1マイクロ秒で送られる。
	1つのパケットで読み書きできる量は、20バイト。
	もちろん、複数のパケットに分割する仕組みはある。最大(512 - 3 TBD)バイト。

コマンドライクなの。

セキュリティ、プライバシー。


アプリケーションの作り、
ペアリング、ボンディング。セキュリティ・モード。必須ではない。
発見、接続と切断、通信。
バックグラウンドでも。
バックグラウンド、繋がりっぱなし。

Bluetoothのリストに一覧が出ていない。
ペアリングがなかった。PINコード、4桁の数値入力。


複数、
サービス、

ハードウェアの作り方。



### BLEの体験


### 無線通信,コマンドで通信,アプリケーション







### 使ってみる
アプリでつなぐあれこれ。

心拍計って、
どんなもの、
方式とかいろいろ
Bluetooth Low Energy の心拍計は、ハートレートプロファイルという仕様。
だから、これに準拠していれば、どのアプリケーションでもいい。
フィットネスのアプリケーションはどんどん使っているでしょう。
専用アプリケーション、ダウンロード。

心電図、心臓の筋肉の微弱な電気信号。胸に直接貼り付ける。
手首、動脈。光の反射、血流量の変動。

心拍計測を開始。
BLEのデバイス、装着、腕時計型であれば計測ボタンを押す。

計測、専用アプリ、データがリアルタイムに表示されて、保存されて、
一定心拍になるように、音声ガイダンスあるいは、ピッピという音を出したり。もちろんデバイスも出すけど、
フィットネス。

サービスをキャラクタリスティクス。

これは専用アプリ以外、
はい、おしまい。

### 何が違うねん
無線通信と消費電力
タイミングを合わせる。

ペアリングとボンディング
小さくても、プライバシー、セキュリティ。

プロファイルとサービス。
設定画面。自由さ。



### 仕様書絡みてみましょう。


2013年7月の時点で、Bluetooth SIGが承認しているプロファイルは、つぎの14つです。

[Profiles | Bluetooth Development Portal](http://developer.bluetooth.org/gatt/profiles/Pages/ProfilesHome.aspx)

- アラート通知 (Alert Notification)。
- 血圧計 (Blood Pressure)。
- 自転車のパワーメータ (Cycling Power)。
- 自転車の速度とペダル回転数 (Cycling Speed and Cadence)。
- デバイスの発見 (Find Me)
- 血糖値 (Glucose)
- 体温計 (Health Thermometer)
- 心拍 (Heart Rate)
- 入力装置 (HID OVER GATT)
- 位置と経路誘導 (Location and Navigation)
- 電話の警告(Phone Alert Status)
- 近接 (Proximity)
- ランナーの速度とペース (Running Speed and Cadence)
- 時刻 (Time)

### カスタムなプロファイルの製品群を見てみましょう


