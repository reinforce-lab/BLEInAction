# プロトタイピングとユーザ体験

## アプセサリとプロトタイピング

Bluetooth low energyの登場と普及したスマートフォンから生み出されたアプセサリという造語について、その特徴や事業化そしてデータの流れについて見てきました。従来からあるハードウェアであっても、それがアプセサリとして活用されると、いままでになかった新しい価値を生み出す要素になります。

なにが価値なのかは、実際に体験をしてみなければ本当にはわかりません。ソフトウェア開発方法では、最初の団塊で大まかな仮の物を作り、それにユーザの要求うを繁栄させて完成される試作開発のことを、プロトタイピングと呼びます。

ここでは、アプセサリのプロトタイピングを見ていきます。

### プロトタイピングとハードウェア

プロトタイピング(Prototyping)は、プロトタイプ(Prototype)を作り、早期に設計などを検証する手法です。とくに、参加者の分野が様々なブレインストーミングでは、お互いの認識のすり合わせにプロトタイプが使えます。

これは著者個人の体験ですが、粘土をこねて外形を作った、あるいはiPhoneで機能するプロトタイプを作り、それを手で触れていると、そこから驚くような発見や広がりそして展開が、急速に出ます。アプセサリの魅力は、アクセサリとアプリケーションの連携が生み出す体験です。形あるプロトタイプに触れる体験を通して、その背後にある形のないアプセサリの体験を、肌で感じられます。

形があると、つい目を奪われますが、、しかしアクセサリはアプセサリの要素にすぎません。アプセサリの体験という大きな絵を見るための、ジグソーパズルの1つのピースとして、役立ちます。

プロトタイピングにかける期間は、できればブレインストーミング中に作製、時間がかかるならば、前回のブレインストーミングの内容を覚えていて、過熱した頭が冷える程度の期間、例えば2〜3日程度、が望ましいでしょう。体験ができればいいので、実際に実装する必要はありません。その期間でできることを、工夫します。ネットワーク・サービスが必要ならば、決め打ちの画面や、紙に書いた画面をカメラで取り込んだものでも、十分でしょう。Bluetooth LEデバイスは、iPhoneのセンサで間に合うことがほとんどで、また市販されている試作用のBluetooth LEデバイスもあります。

ブレインストーミングでアイディアを出しつくしたならば、そのなかから、面白さや楽しいさ、事業として継続できるかなどの尺度で、ふるいにかけます。アイディアのなかには、必要とするセンサが販売されていない、非常に高価な部品を必要とする、電池や回路の工夫ではどうにもできない形状や大きさを求めている、ものがあります。プロトタイプにはいる前に、そのような明らかに実現不可能なものは、実装についての知識がある担当者が、メンバーにその理由を説明して、変更を加える、もしくは不採用にします。

### ブレインストーミング

アプセサリは、何が正解か誰も知らない、新しいものです。そのため、アプセサリの企画では、ブレインストーミングという会議方法をとることがあります。ブレインストーミングは、参加メンバーがアイディアを出しあい、そのアイディアを批判せず前向きに展開し続けることで、アイディアの連鎖反応や発想の誘発を期待する会議手法です。

しかし、Bluetooth LEに限りませんが、会議方法に工夫をこらして長い時間を費やしても、成果が出ないことがあります。多くの素晴らしいアイディア、それらの検討結果、そして膨大な議事録は残ります。しかし、その結果が事業として実行されず、何もユーザの手に渡らないならば、それは成果が出せなかったことになります。

新規事業を立ち上げる目的は、新たな利益の源泉を得ることです。そのために、これまでにない製品もしくはサービスを考えます。この、考える、がくせものです。企画会議の参加者は、営業、技術開発、製造、ときには経営など、背景知識や立場が様々です。メンバー間で、メンバーの考え方、背景知識、着目している領域を、お互いに確認を取り合える、高い議論の能力が、参加者全員に求められます。

分野をまたぐ協業には、技術でできること/できないことを判別する知識、あるいはBluetooth LEの規格を作る過程ですでに考え尽くされている、利用分野や利用場面の知識の、共有が必要です。技術でできることそれ自体は、誰が考えても、同じものに行き着きます。そのようなものは、自分で考えなくても、知識を持てばよいだけです。

ブレインストーミングは、突飛なアイディアも否定せず前向きに議論を展開していくのが、肝心です。それが会議にならないように、また、議論の焦点だけはあわせることが、主催者の手腕の見せ所です。例えば、ハードウェアの機能を話していて、その大きさに影響する議論がでてきたとします。このとき、大きさは外形デザインに影響するからと、いきなりデザインの話を切り出す人がいたとします。デザインの話に切り替わるのはよいのですが、しかしデザインの話だと節目をつけてメンバー全員の頭を切り替えないと、終わることのない楽しい雑談会の始まりになります。





## プロトタイピング
(試作を通じて様々な観点から検証をおこなう手法やその過程を、プロトタイピングと呼びます。)

(細かい技術、じゃなくて、最後になにか形をなす。スキル。部分としての技術。)
(第3者の視点、都合と立場のお互いの確認)
(グラフィックファシリテーション、全体を見渡して共有する)

### プロトタイピングの目的と効果
(Appleの動画。この中では、ソフトウェアは作らずに黒子さんが操作することで体験を模擬している。素早い。動画撮影をして、それから学ぶなど。)

工程:
概念、
概念実証、Proof of Concept、
関わり合いになるのが誰か。チーム。出資者。
ある程度動くもので体験。
販売可能なものとしての、作りこみ。
運営、破棄。

取り逃すのが、長期間継続して使った場合の体験、単発であればわかるけれども、
ハードウェアでできること、と、使い続けてできること、

(体験の確認、ユーザからのフィードバックを得るなど。すでに発売するものがあれば、販売実績、改良。ゼロからならば、まるで実験、正解がまるでわからず)

(いくつかの、3Dプリンターの筐体、ハードウェア、アプリケーション。それ以前)
(Appleの動画。ダンボール、プリンタ。あるいは演劇。あらゆる手法で、素早く手軽な方法で、工夫して、見立てて)


それぞれ前の工程が後ろに影響を与える。
前の計画でうまくやれば。やり直しは後ろに行くほど、費用がかかる。やり直したほうが、いいのかもしれない。

成果物:
売り場
有形
 説明書、パッケージ、製品
無形
 問い合わせ対応(代理店とか)
 製造者責任保険、
 輸出対応、各国の認証
 商標登録、パッケージデザイン


### アクセサリと会社設立

OEMおよびODM会社も登場して、アプセサリでの市場参入障壁は、ますます低くなってきています。しかし、ハードウェアを扱うと、たちまち個人では扱いきれない何千万円ものお金や物を扱わねばならなくなります。

ヒト・モノ・カネが、事業の3要素と呼ばれます。現在はこれに、情報や時間を付け加えることもあります。会社は事業要素を扱うための器です。アプセサリを始めるために、会社の中で独立した組織を立ち上げたり、あるいは新しく会社を作ったりします。

会社内で事業を始める場合は、かならず代表取締役社長直属の組織にします。また外部からアプセサリを売り込む場合は、かならず代表取締役社長に売り込みます。

社内で組織を立ち上げた時に、もしも命令権限が他人にあると、なにかやりたいことがあるたびに、内容報告や相談と命令発行のお願いが発生します。命令権限が自分自身になければ、アプセサリは必ず失敗します。

新規に会社を作るならば、会社の継続条件である、お金の支払い能力に注意します。

どのような会社であっても、どのような失敗をしても、お金の支払い能力があるかぎりは失敗にはなりません。また、世の中には名前を出すだけで銀行から多額の融資が受けられる一族の方もいます。成功された方が若年であることは、若年であれば成功することを意味しません。

アプセサリの分野では、クラウドファンディング ( Crowdfunding ) がよく利用されます。群衆 (crowd) と資金調達 (funding) を組み合わせた造語で、インターネットで不特定多数の人から資金や協力を集めることを指します。ソーシャル・ファンディングとも呼ばれます。アプセサリには、ハードウェアという形あるものがあるので、投資への見返りに最初に製造した製品が使われます。

### アクセサリとOEMとODM

世の中には多種多様な製品がありますが、すべての会社が自社で製品しているわけではありません。

様々な分野の製品に、生産に特化した OEM ( Original Equipment Manufacturer ) と呼ばれる会社があります。ブランドを持つ会社は、OEMに製造を委託し、OEM会社はいくつもの会社の受注をまとめて大規模な生産をすることで、低価格での生産を実現します。また、OEMをもう1歩進めて、設計まで担う ODM ( Original Design Manufacturer ) もあります。

OEM会社またはODM会社は積極的に利用すべきです。アプセサリで、ハードウェア部分をゼロから開発すると、設計や検証そして製造方法の確立に莫大な費用と時間がかかります。既存製品がある分野であれば、OEMやODMを利用することで、その費用と時間を省略できます。

どのような製品にどのようなOEM会社があるかは、半導体を扱う商社に聞くか、あるいは製品分野ごとにある展示会の出展者を調べていけば、わかります。例えば、フィットネスで使われる胸に巻く心拍計は、各社の製品を並べてみても、製品仕様や外観がよく似ています。これは各社がOEM会社を利用しているからです。

また、スマートフォン連携に向けたODM会社も登場してきています。例えば、心拍計は、フィットネス分野ではスマートフォン登場以前から広く使われてきました。心拍計のOEM会社にとっては、フィットネス分野で急速に広まるスマートフォン連携に対応すれば、自社販売量を急激に伸ばすことができます。逆に対応が遅れれば、スマートフォン連携を強みにした他社が、シェアを取ります。

フィットネス分野は Bluetooth low energy が普及する市場として最初から注目されていました。ですから、はやくから心拍計のプロファイルが採択されていました。ODM会社は、規格に定義されたプロファイルを実装した心拍計と、そのプロファイルに対応するアプリケーションを開発するライブラリをセットにして提供します。これらは規格で決められていますから、従来の心拍計と同じく、同じものを複数の会社に販売することができます。

アプセサリの分野では、ゼロからの製品開発を支援するODM会社が登場してきています。これは、将来の製造需要を取り込む目的で、できたばかりの会社に設計まで支援するものです。試作と製造は求められる設計要素がまったく違います。これらのODM会社は、蓄積した製造経験に基づく製造可能な設計まで提供できることが強みになります。

またアプセサリ分野での、OEM会社またはODM会社になる考え方もあります。これはハードウェアを製造せず形のない知的財産を提供しているものもODM会社といえます。

例えば、歩数計や活動量計は、加速度の値から歩数や消費カロリーを算出します。この信号処理はこれ自体が知的財産であり、また算出結果が妥当なものかを検証するなど、開発には大きな費用かかるものです。ですから、歩数や活動量の算出機能をいれた無線通信モジュール、あるいはソフトウェアそのものが販売できます。

また、アクセサリというハードウェアを販売してきた会社は、サーバーの設置や運用、そしてアプリケーション開発を、経験がないからと避けようとします。サーバーを運営まで含めて提供するODMも可能です。

また、OEMあるいはODM会社になるほうがよい分野もあります。

例えば、メガネの機能はそのままで、フレームに機能を追加したアプセサリがあるとします。メガネですから、利用者にあったレンズをフレームにはめる必要があります。このため、通常の眼鏡と同じように店頭で販売する必要があります。

販売店舗を全国に展開するには巨額の資本が必要です。ですから、そのようなアプセサリであれば、メガネのフレームのODM会社になるべきでしょう。

### ハードウェアとソフトウェアの開発体制

アプセサリのiOSアプリケーションは、ハードウェアと密接につながります。そのため、通信部分とドライバ相当は、両方をよく理解して協調して設計することが大切です。Objective-Cもできるハードウェア開発者が担当することが最適です。

iOSアプリケーションからみて、ハードウェアが期待した振る舞いをしないときは、問題がどこにあるのかを切り分けることが困難です。原因は、iOSアプリケーションのドライバ層の使い方の間違い、Bluetooth LEの通信、ハードウェアの設計、これら4つのどれかにあります。しかし、iOSアプリケーション開発者からは、通信以降を調べる手立てがありません。それらを調べられるのはハードウェア担当者です。

なにかおかしいことが起きた時に、原因箇所の特定には時間がかかります。このときに、ハードウェアの振る舞いを確認できるデモンストレーション・アプリケーションを作製しておけば、iOSアプリケーションとドライバ相当部分が原因かそうでないかが、すぐに切り分けできます。iOSアプリケーション以外に原因があるときは、通信プロトコルを見たり、ハードウェアの設計内容を確認していきます。それはハードウェア設計の担当領域です。

### ハードウェア設計

- Made for iPhoneプログラムは不要
- 部品代は5ドル、モジュールは10ドル前後
- モジュールを利用した場合、電波法の認証及びBluetoothの認証費用はかからない

 Bluetooth low energy は、[Made for iPhone (MFi) プログラム](https://developer.apple.com/jp/programs/mfi/) の締結が必須ではありません。クラシックBluetoothでは、特定のiOSアプリケーションと接続するデバイスの開発には、Apple社とMFiプログラムの締結が必須でした。MFiプログラムを締結して初めて、ハードウェアやソフトウェアの開発情報が提供されます。

MFiプログラムが必須ではなくなったことで、ベンチャーの参入ハードルが極端に下がりました。 Bluetooth low energy デバイスと接続するiOSアプリケーションは、AppStoreの承認を得られます。ただし、デバイスにMFiロゴを掲載する場合は、ロゴの使用権を得るためにMFiプログラムの締結が必要です。

 Bluetooth low energy の電子回路を独自に設計した場合の製造コストは5ドル程度です。これらの電子回路を小さな基板にまとめて部品化したものを、モジュールと呼びます。モジュールの価格は10ドル前後です。

モジュールを使うことで、電波法の基準認定とBluetoothの規格認定および製品登録にかかる初期費用が省けます。

電波を出す回路は、外部に電波がもれ出ない試験環境で動作させるか、あるいは、それぞれの国ごとの電波法に基づく基準認証をうけなくてはいけません。認証を取得しているモジュールを利用すれば、製品ごとに認証をとる必要はありません。

また、 Bluetooth low energy ロゴを表示して販売するには、Bluetooth SIGへの製品登録が必要です。製品登録には、Bluetoooth SIGへの、最低でも年間5000ドルのメンバー登録費用と、設計ごとの認証費用が必要です。

各社のモジュールは、それ単体でのBluetoothの製品登録が完了しています。無償のBluetooth SIGのメンバー登録をおこない、 Bluetooth low energy のモジュールを利用した派生製品として登録すれば(この登録は無償)、製品登録が完了します。

### アクセサリの実例

アプリケーションやネットワークそして事業までを統合したアプセサリは、まだ少なくこれから登場するでしょう。アクセサリ自体は、2012年の夏あたりから次々登場しています。いくつかを紹介します。

1つは、プロトタイピングのための開発キットやアクセサリです。これらは、早い時期から登場しています。まずBluetooth LEの半導体やモジュール会社が、組み込み機器開発者向けキットの提供を開始しました。iOSアプリケーション開発者のなかにも、Bluetooth LEデバイスの開発をしてみたい要望があります。次に登場してきたのが、その要望にあわせて、組み込み機器開発者でなくても使いやすい、より安価な開発キットです。

日本の技術基準適合証明を取得しているプロトタイピングに向いたものに:

* SBBLE(サブレー) [http://sbble.micutil.com](http://sbble.micutil.com)
* Konashi [http://konashi.ux-xu.com](http://konashi.ux-xu.com)
* センサータグ [http://www.tij.co.jp/tool/jp/cc2541dk-sensor](http://www.tij.co.jp/tool/jp/cc2541dk-sensor)

があります。

SBLBLE(サブレー)はマイクロチップ・テクノロジー・ジャパン株式会社のPICマイコンを採用した開発キットです。市販のUSB Bluetooth4アダプタを挿して使います。Konashiは、iOSアプリケーション側の開発がObjective-Cに加えてJavaScriptでも開発できます。ウェブ・サービスの開発者が、フィジカル・コンピューティングをiOSでおこなう場合の唯一の選択肢です。センサータグは、テキサス・インスツルメンツ社の半導体の評価キットで、25ドルと低価格です。次のセンサを搭載しています:

* 放射温度センサ、温度センサ
* 湿度センサ
* 圧力センサ
* 加速度計
* ジャイロスコープ
* 磁力計

必要なセンサが上記にあるプロトタイピングであればセンサータグを、LEDの点灯など低速の外部装置制御をiPhoneから行うならKonashiまたはSBBLEを、任意のファームウェアを開発したいときはSBBLEを選択するとよいでしょう。

キーホルダーまたはタグは、よくあるアクセサリです:

* キーホルダー、
[iPhone用探せるキーホルダー](http://buffalo.jp/products/catalog/supply/bluetooth/bluetooth/security/bshsbtpt01/)
* StickNFind [https://www.sticknfind.com](https://www.sticknfind.com)

キーホルダーは、iPhoneと接続して使うものです。iPhoneを置き忘れしそうになった時にキーホルダーから警告音を出したり、キーホルダーのボタンを押すとiPhoneから音が出る機能でiPhoneを探すのに利用します。タグは、代表的なものにStickNFindがありますが、ものに取り付けておいて、ものを探すのに使うものです。その機能は、キーホルダーのボタンを省略したもので、おおよその距離をiPhoneで確認すること、iPhoneから操作してタグから音や光を出すこと、ができます。

たいていのキーホルダーやタグは、仕様が公開されていたり、ソフトウェア開発キットが提供されていて、アプリケーション開発に利用ができます。近接検出または光や音の出力を必要とするプロトタイピングに利用できます。

この他にも:

* 心拍センサ、 [Alpha](http://www.alphaheartrate.com)
* 活動量計、[Fitbit](https://www.fitbit.com)
* 睡眠記録、[オムロン ねむり時間計](http://www.healthcare.omron.co.jp/corp/news/detail/223)
* 姿勢検出、 [Lumoback](http://www.lumoback.com)
* 腕時計、[Pebble](http://getpebble.com)
* 顔検出、[HVC-C1B](http://plus-sensing.omron.co.jp/egg-project/)

などが市販されています。

アクセサリに直接アクセスできるSDKを提供するもの、アクセサリに直接アクセスするAPIはなく、ウェブ側に蓄積されたデータにアクセスするAPIを提供するものなど、APIやSDKの公開は、製品ごとにまちまちです。


# Bluetooth Low Energyの体験づくりとその試作

体験づくり、
ハードウェアそれ自体の魅力、
スマートフォン、連携、サービスであったり、可能性が広がる。だからアプセサリ。
魅力的なユーザ体験、
連携、
ハードウェアの制約、プロトタイプ、試行錯誤。
正解がわかってしまえば、








Bluetooth Low Energyは、アプリケーションやネットワーク・サービスとハードウェアとの連携で、鍵となる無線通信技術です。


魅力的なユーザ体験は、



魅力的なユーザ体験を生み出す
は、いろいろな試行錯誤のなかで
仕様書を出して
魅力的なユーザ体験を生み出す連携は
その連携ユーザ体験

ハードウェア、
わかってしまえば、正解とわかる。


バックグラウンドの反応、アプリの制約、
ハードウェアの制約、電池交換、充電、本体の大きさ、価格。

要求仕様、個別の分野に分けて、作って生み出される。
新しい、実際に体験してみて。作るにもコストがかかる、時間。一緒の場所でとか、あるいは専門家でなくても、ある程度の見積もり、可能性。ハードウェアは可能性でもあり、制約でもある。

ハードウェアの側から、基礎知識の話。

無線通信には必ず通信相手がいます。
Bluetooth Low Energyを活用して新しいユーザ体験を生み出そうとするならば、

ハードウェアが通信ネットワークに組み込まれていくことで新しい価値や未来的な生活が生まれるだろうと、何十年も研究や議論がなされてきました。しかし、それらの技術が実際に身の回りに普及するためには、電池交換の手間などのハードウェアの問題と、それらのハードウェアを通信ネットワークに組み込む仕組みづくりの2つが必要です。

ハードウェアとネットワーク・サービスなどの連携から生み出される新しい価値や未来的な生活スタイルは、何十年にもわたり研究や議論の対象となってきました。
Bluetooth Low Energy それらを実際に実施するうえでは
Bluetooth Low Energyは、
それらを実施するうえで問題

いま電池交換の手間や電気回路の価格そして通信相手となるスマートフォンの爆発的な

幾つかの問題や環境。
2011年のiPhone 4S依頼
無線であること
電池交換や費用
またスマートフォン

Bluetooth Low Energyは、
これまで電池交換の手間や電気回路の価格など

アプリケーションやネットワーク・サービス
ハードウェアが

することで、今までなかった新しい価値を生み出せます。

して生み出される価値を得るために、その連携

Bluetooth Low Energyは
あるハードウェアにBluetooth Low Energyを搭載するということは、

通信にはかならず通信相手がいます。


Bluetooth Low Energy を搭載するハードウェアは、ハードウェアそれ自体だけではなく、アプリケーションあるいはネットワーク・サービスとの連携から価値が生まれます。

バックグラウンドの反応、アプリの制約、
ハードウェアの制約、電池交換、充電、本体の大きさ、価格。

要求仕様、個別の分野に分けて、作って生み出される。
新しい、実際に体験してみて。作るにもコストがかかる、時間。一緒の場所でとか、あるいは専門家でなくても、ある程度の見積もり、可能性。ハードウェアは可能性でもあり、制約でもある。

ハードウェアの側から、基礎知識の話。

無線通信には必ず通信相手がいます。
Bluetooth Low Energyを活用して新しいユーザ体験を生み出そうとするならば、

プロトタイピング、
一般的なハードウェアやファームウェア開発では、仕様書を渡されてそれを形にすることも多いでしょう。

しかし、Bluetooth Low Energyを活用する開発では、ハードウェアとアプリケーションそしてサービスそれぞれの開発も最初から連携

仕様書を渡されてそれを形にする仕

したがって開発も、
ハードウェアはハードウェア
Bluetooth Low Energyを活用するハードウェアの開発も、アプリケーションやサービスと連携

ユーザの体験
Bluetooth Low Energyを活用する開発では、サービスからみて
新しい体験を生み出していかなくてはなりません。

事が多いでしょう。


要求機能のリストや仕様書を

ですから、Bluetooth Low Energyを活用する開発では、

利用者の体験、
制約、実現可能性、
逆に、思いつかない使い方、可能性。
無線通信、電気回路、ハードウェアの可能性と制約、実装できるか、製造販売できるか。

Bluetooth Low Energyを搭載したハードウェア
形のあるハードウェアに

電気回路やファームウェアなどのハードウェアの側から、Bluetooth Low Energyを活用した体験づくりとその試作を見ていきます。


ハードウェア単体では完結できない、連携。また、アプリケーションやサービスにあわせる必要があるかも。独自のハードウェア設計では。
仕様書が出てきて、指示通り。その指示が出せない。プロトタイピング、分業がしづらいし。

前提、

何を示すか、


<!--## ハードウェア・エンジニアの役割-->

ハードウェアの知識を最初から練り込むこと、その根拠:
正解がわからない、試しておく、最初から正解を握れない、探りつつ確認していくこと。
不明なものに形を与えること:

プロトタイピング、
不可能と可能、
ハードウェア、通信規格、
コスト、製造販売流通、

アプリケーションやネットワーク・サービスとの連携。

技適など、ハードウェアだけの話。

無線通信には必ず通信相手があります。しかし、その通信相手は、どのような体験を作るかによって、スマートフォンであったり、あるいはネットワーク・サービスであったりします。




全く新しいもの、
従来からあるものが、サービスの一部に。繋がる先、
Bluetooth Low Energy
Bluetooth Low Energyは、様々なもの、
体験、試作。

全体像、通信規格、アプリケーション
無線通信には必ず通信相手が必要です。

その通信相手は、直接電波が届く範囲にある機器であったり、あるいは、その先にあるネットワーク・サービスであったりと様々です。

にある2つの機器であったり、あるいは
通信の


ハードウェア側から、
体験を作る。

仕様、アプリ側から見てきた。
技適みたいな。仕事的には、ハードウェアだけで完結する話。








無線通信には必ず通信相手がいます。そして通信は、電波で信号をやり取りできるだけではなく、やりとりするデータの意味や、データを受け取った時にどう振る舞うべきかを事前にお互いが知っていなければ、成り立ちません。

Bluetooth 無線通信技術は、ヘッドセットやキーボードなどの周辺機器のために、その機能や振る舞いをプロファイルとして定義してきました。その認証で確保された高い相互接続性ゆえに、Bluetooth 無線通信技術には、いまやほとんどのパソコンやスマートフォンに搭載されるほど、高いブランド力があります。

そして、Bluetooth Low Energyは、
それまでのBluetooth無線通信技術では対応しきれていなかったウェアラブル・デバイスなどの領域に向けて新しく開発された技術です。
身の回りにある様々な物や物事に活用できる無線通信規格だと言っていいでしょう。

体験づくり、試作。

従来のBluetooth無線通信技術のように、規格で定義されたプロファイルに従い心拍計やキーボードなどの周辺機器を開発することもできます。また、規格にない独自のプロファイルを実装することもできます。

Bluetooth Low Energy は、


身の回りにある様々な物や物事の、通信相手は、スマートフォンのアプリケーション、ネットワーク・サービス。
連携、

この技術は、製品だけではなく、製品とアプリケーションやサービスが連携して初めて生み出されるユーザ体験

、そして連携たもたらすユーザ体験が価値を生み出すため、

形のある製品だけではなく、その

開発開始時点では何が正解なのかすらわかりません。


Bluetooth Low Energyは、クラシックBluetoothと同じように、キーボードや心拍計などの製品ごとに、プロファイルを定義しています。また同時に、身の回りにある多種多様な物や物事に活用できるように、



このような柔軟なプロファイルの仕組み







Bluetooth Low Energyは、超低消費無線通信技術と
GATTベース・アーキテクチャなどの新技術で、身の回りにある多種多様の物や物事の連携動作を可能にしています。



しかし、Bluetooth Low Energyでは、形のある製品だけではなく、その製品と連携するアプリケーションやサービス、そして連携たもたらすユーザ体験が価値を生み出すため、開発開始時点では何が正解なのかすらわかりません。






(ハードウェアやファームウェアに重点をおいた解説をしていく。)

(専門分野だけど、個別に分離できるものではない、連携のなかで、なのでお互いに視点としてすりあわせておくこと、基礎知識として持つことは大事。その一方で実務としての詳細情報。)



身の回りにある多種多様の物や物事が無線通信を通じて連携するには、2つの大きな課題がありました。1つは、電力を必要とする無線通信を搭載すると、電池交換の手間やコストが発生すること。もう1つは、多種多様な物や物事の機能や振る舞いを、どうすれば表現できるかです。

この2つの課題を、Bluetooth Low Energyは、超低消費無線通信技術とGATTベース・アーキテクチャで解決します。

Bluetooth3.0までの、いわゆるクラシックBluetoothは、ヘッドセットやキーボードなどの製品分野ごとにプロファイルを定義して、広く周辺機器に使われてきました。

一方で、Bluetooth Low Energyは、多種多様な物や物事を扱うために、GATTベース・アーキテクチャによるカスタム・プロファイルが使えるように生っています。


それぞれの製品群を形作ってきました。

Bluetooth Low Energy の活用場面は、
されたプロファイルに

クラシックBluetoothは、


しかし、Bluetooth Low Energyを活用する製品は、
形のある製品だけでは成り立ちえません。ハードウェアがスマートフォンのアプリケーションやネットワーク・サービスと連携して初めてもたらされる利用者の体験が、1つの製品となります。

体験を作るためには、
ハードウェアで閉じることがない、
アプリケーション、サービス開発、そのチームのなかで、
体験という価値を提供するつながりの1つを担う。

多種多様なものをデータとして表現する


また、Bluetooth Low EnergyのGATTベース・アーキテクチャが、多種多様な製品
スマートフォンと連携するアプセサリ、

は、多種多様な製品に実装できる技術です。
また、高度な半導体技術のおかげで、製品の振る舞いは、ほぼソフトウェアで実現できるようになっています。


アクセサリとアプリケーション
自由度が高い、

そして、その製品の振る舞いは、大部分が

ですから、利用者の体験

また、セキュリティやプライバシーの扱いや、

ヘッドフォンやキーボードといった
製品ごとにプロファイルがしっかり決められていた

Bluetooth3.0までのクラシックBluetoothでは、
かつての


多種多様な製品を
GATTベース
カスタムプロファイル
製品ごとにプロファイルが定義されてるクラシックBluetooth

単品で閉じない、大きく違う。ハードだけで閉じれない。体験から逆算。
ソフトウェアの力が大きい。
クラシックBTとも違って、用途が決まっているわけでもない。技術で閉じれない。おまけ。

Bluetooth Low Energyでの
通信には必ず相手、
無線通信技術 Bluetooth Low Energy は


物や物事がネットワークと関わる
、

同じようなハードウェア
スマートフォンを使う場合、使わない場合。
Bluetooth Low Energy
ハードウェア
体験づくり
試作。形にする。サービスとして、ハードウェアとして。

実働するモデル（プロトタイプ）を早期に製作する手法およびその過程を意味する。その目的は、設計を様々な観点から検証する、機能やアイデアを形にすることでユーザーから早めにフィードバックを得るなど、

形あるもの、
形あるもの、可能性、外れないこと。


(ハードウェアやファームウェアに重点をおいた解説をしていく。)

(専門分野だけど、個別に分離できるものではない、連携のなかで、なのでお互いに視点としてすりあわせておくこと、基礎知識として持つことは大事。その一方で実務としての詳細情報。)

## プロトタイピング
(プロトタイピングの全般の話は1章でまとめている。)
(全体から見た部分、ここでは、そのうちのハードウェア、ファームウェア部分。)

1章では、モック、出資者、形にする、仕上げる、の3段階、それぞれでの役割。
段階ごとに、かかる手間が1:10:100、大雑把だけど。それだけ時間もお金もかかる。予想外も出てきやすい。何が正解かわからない仕事、類似性があってプロの仕事に落とし込めるものと。宣伝広告とかはプロの仕事だから。

素早い実験と確認
過程から得られるもの

### 節目で説明。それぞれ、細かく
説明のために、節目に分けたけれども、
例えば戦略の時に、最後の運用破棄のシミュレーションをしてもいい、ライフサイクル、
その経験をもとに、また戦略に戻すとか。
無限のお金と時間があればいいけど、底をつかないうちに、拡大再生産。

### 戦略の話
絞込み。やれることが多い。やらないことを決める、削ぎ落とす。

目的: 立場をしっかり認識すること。
哲学、考え方、方針。

顧客、相手は誰か?

家電、HomeKitなどいろいろなあれこれ。IoT系とか、
技術、サービス、ネット側クラウド(プラットホーム)。流れ。サービス。

技術、サービス、ネット側クラウド(プラットホーム)。流れ。サービス。
形ある、土台を例に。

最先端技術。ロボット掃除機。今頃出しても。市場が出来上がってきて、ブランド。
なにもない、黎明期のつらさ。黎明期のなかで、ブランドがあるところへの参加。
資本力、立場。

ニュアンス、既存の製品、スマートフォン連携。
リモコンになるのか、遠隔操作になるのか。

### モックの話
(前提、目的、環境、手段、何が得られるか)
(見せる相手、使う人達、目的、かかるコスト)
(それぞれの段階での、ドボン)

目的: 可能性を探りだす、実感すること。
範囲: 数人、出資者。極めて狭い。
形: 動く必要すらないが、実現可能であることは大切。電池にからむもの。荒くていい、せいぜい1日動けばいい。テープで固定、複数の者、配線がわさわさ出て
チェック: 電波法は守りましょう。キットなど流用、テープで貼り付けでもOK。
ドボン: やたらお金と時間をかける。意思の疎通。紙と鉛筆でもいい。人月で仕事するのではないので。

(朧気な段階: モックだけ、機能する必要もなくて、でも電子部品をテープで貼り付ける程度の容積程度は。消費電流とかは机上の計算、モジュールや部品は一度購入するなり図面から、紙を切ったり、3Dプリンタ、粘土で)

目鼻立ちをつける。コスト。外形デザイン。明らかな不可能とトライアル度。
目に見える部分、大きさと表示器。
液晶、電子ペーパー、有機EL。
明らかな不可能 - 容積。電池。
困難度 - ワイヤレス充電。ELで1ヶ月。

(いろいろな段階で、行う。前提にそぐうように。そぐわないなら、戻す。)
(作るもの、製造するもの、仕事の内容が決まったら、その製品ではなくても共通して使えるスキルまで仕事が降りてくれば。それ以前。そこでも、担当分野ごとのプロの仕事が必要)


()## 時間軸での話、体験を作る話として

構成。体験。

正解が見えているだろうもの:
趣味であれば、モータ、検出とかは不要、人間がみて、スマフォがリモコン。安全装置なども不要。
制御装置的な高度なものは、おそらくすでにある。
であれば、モータをONする、リレーとか既存の制御装置、スイッチを押すだけ的な。

BLEのものは非常にシンプル。

おそらくセンサー+BLE。体験として、近づいたらうんたら、出力、LED。ボタン。
非常にシンプル。使い捨てでもOK的な。
電池の制約で常時モータが動き続けるとかなら、ACコンセント。固定物ならWiFiでとか。住み分け。

正解が見えにくいもの:
自社で閉じこもるもの、何かしらのエコシステム的なもの、体験。作れる部分と味付けてきな。

売れれば成功、結果論。なのでイテレーションで。
後ろに行くほど、大変だし、前に戻る段数が多いほど、お金と時間がさらにかかる。当初計画予算の3倍くらいを見ておく必要。

作らないプロトタイピング。適切に。難しいことに拘る必要はなくて。外装、デザイン、神と鉛筆と糊。

### プロトタイピングとしての形にする

アップデート? できるわけがない。戦略。独自?。プラットホーム。
対応機種。技術だけど、実験? 決めておいたほうがいい。
特に、アンビエントな接続とかは、トラブル。iOSのちAndroid、WP。据え付け型とか。
機種を絞るとか。開発者、資源。日本ではiOSファーストでOK?

構成、分割。すり合わせ。部門ごと。パーツとして。チーム作り。細目までは、具体的な。

解決すべき課題や、提供する価値はわかる。でも実際に不特定多数い販売するとかだと、底に至るまでの問題がわからない状態。直感、ある程度の期間を使ってみて、防水とか、UIとか、気をつければいい場合

目的: 製造可能設計に入る前、実際に形にして体験する
範囲: 社内、限定した管理されたユーザテスト
ユーザテスト、管理した環境での、手渡し。不具合があっても、すぐに戻してもらえる。
相手がわかっている状態。

形: 販売するもの同等、でもなく。フェーズに分けて、何度か。耐久性や運営、あるいは問い合わせ対応などは、考慮は必要、実装はいらない。実際に動いて使えることが大切。
チェック:意外と、泥臭いところが出てくる。通信速度の調整とか、ユーザの体験としての確認。あと、バグの踏み出し。
開発チームを構成することになる。お互いの意思疎通、時間感覚のすりあわせ。成果物をどの段階で出すか、荒くていいけど。近くにいて雑談するとかね。
ドボン: 動向把握。開発期間が1年だと、その後で出したら、よりよい半導体がでるかもしれない。とか。
知的財産のチェック。
技術的な細かいドボンがたくさん出てくる。
最後になってわかってくるトラブル。なんとか回避可能だったり、不可能だったり。
術なので、iOSだと新機能とかも出てくる。動向の把握。
消費電力、ドボン。外観、電池。小さいウェアラブル系は。

消費電流が1mA増えても、据え置きならば、問題ないけど。細かいけど、けっこうハマ

電池の消費量のところ。
BLEでは、つながりっぱなしであれば、コネクション・インターバルを可変にする。
センサー系とか、ハードで決まる。

つながる、つながらないのところ。
電波ものなので、とぎれたりするとか、通信速度、気づいたりすることがいいのか。
iBeaconテクノロジーを組み合わせる。

成果物を明らかにする:
量産前提、出荷されるファームウェアとハードウェア、
テストコード、生産時、出荷後のチェック用、
ファームウェアの更新

(### プロトとガチの開発)
センサータグ系。もしもそれで良ければ? ライセンス。
プロトタイピングのキット。お手軽さ。
通信の細かいところに手が入る。DFUとか。プロトのだと、ここが防げない。

(### センサーの塊のもの、プロトタイピングのもの)

IO周りが便利な従来Arduino系+BLE。(スマフォ側は知らない系)
回路+SDK系。
スマフォ側の試作を簡便化。BASICで。


SensorTag, Broadcomの何か、端子は出ているから増設もできるが。

通信に特化したもの、
シリアル通信

プロトタイピングようのもの
I2CやGPIOを叩きたいとかなら、
Koshian, Konashi

()### 試作のあとのあれこれ。

ある機能が実装されているもの

A. 手軽さ、センサータグ+アプリ
B. 売り物、段階、時間軸。プロト、実証、製品検討の設計、製造向きの設計、製造、販売。

A.手軽さ
コードベース、スタート地点
koshian、konashi、
RFduino ,Redbeer、

すぐに使えるキットがあればよし。なければ、センサー増設ができるもの。通信だから両端のコード、ベースはあるか? 作例があるといい。
BASIC

B.売りもの
UX
データ取り、解析、
現実的か、電池、外観、価格
売り物、EMC、BLE、アプリ、ネットサービス

B.売り物系
自社で閉じこもるもの、
何かしらのエコシステム的なもの
一般周辺装置的なもの。

### 製造/販売可能
(## 製造から破棄までの道筋、直接費)

目的: 製造可能なもの、体験を商売として提供するための完成品。
製造可能。部品の管理、ライセンシング、出荷時の検査。、入手性。組立会社。部品。開発者。これ、出したあと、シリーズ展開するならば。技術が分かる人を、社内?
販売可能、単体で安全であること。ラジコンの例。認証を受けていること。知財。ライセンス。

気をつけるポイント。出て行くもの、必要なもの。あとの工程で必要。
ボタンを押せば、反応する。電池切れ。
細かいところ。でも、説明書を読まないから、何も知らない人。

不特定多数に手渡されること。不具合ががあると返送送料代品など、対応。コスト。
機能すること。アップデート。
運用、問い合わせ。エラーコード。Androidとか、iOSとか対応機種。
アプリ。見て分かる感じ。

ウェブサイト、販売促進のちらし。アプリの画面デザイン、やり直しじゃなくて。
日程。パッケージ。

レビューによる可視化。よく見ること。わかりやすさ。特に使えない場合、既存の商品。
ファームウェア、更新。エコシステム、SDKの提供。サポート。あとは、勝手には広がらない、イベントと開催とか。なので、使いやすいか、API、理解しやすさ、魅力。

(流れの中での役割をここで抑えたことに)

<!--
## アクセサリと会社設立

OEMおよびODM会社も登場して、アプセサリでの市場参入障壁は、ますます低くなってきています。しかし、ハードウェアを扱うと、たちまち個人では扱いきれない何千万円ものお金や物を扱わねばならなくなります。

ヒト・モノ・カネが、事業の3要素と呼ばれます。現在はこれに、情報や時間を付け加えることもあります。会社は事業要素を扱うための器です。アプセサリを始めるために、会社の中で独立した組織を立ち上げたり、あるいは新しく会社を作ったりします。

会社内で事業を始める場合は、かならず代表取締役社長直属の組織にします。また外部からアプセサリを売り込む場合は、かならず代表取締役社長に売り込みます。

社内で組織を立ち上げた時に、もしも命令権限が他人にあると、なにかやりたいことがあるたびに、内容報告や相談と命令発行のお願いが発生します。命令権限が自分自身になければ、アプセサリは必ず失敗します。

新規に会社を作るならば、会社の継続条件である、お金の支払い能力に注意します。

どのような会社であっても、どのような失敗をしても、お金の支払い能力があるかぎりは失敗にはなりません。また、世の中には名前を出すだけで銀行から多額の融資が受けられる一族の方もいます。成功された方が若年であることは、若年であれば成功することを意味しません。

アプセサリの分野では、クラウドファンディング ( Crowdfunding ) がよく利用されます。群衆 (crowd) と資金調達 (funding) を組み合わせた造語で、インターネットで不特定多数の人から資金や協力を集めることを指します。ソーシャル・ファンディングとも呼ばれます。アプセサリには、ハードウェアという形あるものがあるので、投資への見返りに最初に製造した製品が使われます。

### アクセサリとOEMとODM

世の中には多種多様な製品がありますが、すべての会社が自社で製品しているわけではありません。

様々な分野の製品に、生産に特化した OEM ( Original Equipment Manufacturer ) と呼ばれる会社があります。ブランドを持つ会社は、OEMに製造を委託し、OEM会社はいくつもの会社の受注をまとめて大規模な生産をすることで、低価格での生産を実現します。また、OEMをもう1歩進めて、設計まで担う ODM ( Original Design Manufacturer ) もあります。

OEM会社またはODM会社は積極的に利用すべきです。アプセサリで、ハードウェア部分をゼロから開発すると、設計や検証そして製造方法の確立に莫大な費用と時間がかかります。既存製品がある分野であれば、OEMやODMを利用することで、その費用と時間を省略できます。

どのような製品にどのようなOEM会社があるかは、半導体を扱う商社に聞くか、あるいは製品分野ごとにある展示会の出展者を調べていけば、わかります。例えば、フィットネスで使われる胸に巻く心拍計は、各社の製品を並べてみても、製品仕様や外観がよく似ています。これは各社がOEM会社を利用しているからです。

また、スマートフォン連携に向けたODM会社も登場してきています。例えば、心拍計は、フィットネス分野ではスマートフォン登場以前から広く使われてきました。心拍計のOEM会社にとっては、フィットネス分野で急速に広まるスマートフォン連携に対応すれば、自社販売量を急激に伸ばすことができます。逆に対応が遅れれば、スマートフォン連携を強みにした他社が、シェアを取ります。

フィットネス分野は Bluetooth low energy が普及する市場として最初から注目されていました。ですから、はやくから心拍計のプロファイルが採択されていました。ODM会社は、規格に定義されたプロファイルを実装した心拍計と、そのプロファイルに対応するアプリケーションを開発するライブラリをセットにして提供します。これらは規格で決められていますから、従来の心拍計と同じく、同じものを複数の会社に販売することができます。

アプセサリの分野では、ゼロからの製品開発を支援するODM会社が登場してきています。これは、将来の製造需要を取り込む目的で、できたばかりの会社に設計まで支援するものです。試作と製造は求められる設計要素がまったく違います。これらのODM会社は、蓄積した製造経験に基づく製造可能な設計まで提供できることが強みになります。

またアプセサリ分野での、OEM会社またはODM会社になる考え方もあります。これはハードウェアを製造せず形のない知的財産を提供しているものもODM会社といえます。

例えば、歩数計や活動量計は、加速度の値から歩数や消費カロリーを算出します。この信号処理はこれ自体が知的財産であり、また算出結果が妥当なものかを検証するなど、開発には大きな費用かかるものです。ですから、歩数や活動量の算出機能をいれた無線通信モジュール、あるいはソフトウェアそのものが販売できます。

また、アクセサリというハードウェアを販売してきた会社は、サーバーの設置や運用、そしてアプリケーション開発を、経験がないからと避けようとします。サーバーを運営まで含めて提供するODMも可能です。

また、OEMあるいはODM会社になるほうがよい分野もあります。

例えば、メガネの機能はそのままで、フレームに機能を追加したアプセサリがあるとします。メガネですから、利用者にあったレンズをフレームにはめる必要があります。このため、通常の眼鏡と同じように店頭で販売する必要があります。

販売店舗を全国に展開するには巨額の資本が必要です。ですから、そのようなアプセサリであれば、メガネのフレームのODM会社になるべきでしょう。

### ハードウェアとソフトウェアの開発体制

アプセサリのiOSアプリケーションは、ハードウェアと密接につながります。そのため、通信部分とドライバ相当は、両方をよく理解して協調して設計することが大切です。Objective-Cもできるハードウェア開発者が担当することが最適です。

iOSアプリケーションからみて、ハードウェアが期待した振る舞いをしないときは、問題がどこにあるのかを切り分けることが困難です。原因は、iOSアプリケーションのドライバ層の使い方の間違い、Bluetooth LEの通信、ハードウェアの設計、これら4つのどれかにあります。しかし、iOSアプリケーション開発者からは、通信以降を調べる手立てがありません。それらを調べられるのはハードウェア担当者です。

なにかおかしいことが起きた時に、原因箇所の特定には時間がかかります。このときに、ハードウェアの振る舞いを確認できるデモンストレーション・アプリケーションを作製しておけば、iOSアプリケーションとドライバ相当部分が原因かそうでないかが、すぐに切り分けできます。iOSアプリケーション以外に原因があるときは、通信プロトコルを見たり、ハードウェアの設計内容を確認していきます。それはハードウェア設計の担当領域です。

### ハードウェア設計

- Made for iPhoneプログラムは不要
- 部品代は5ドル、モジュールは10ドル前後
- モジュールを利用した場合、電波法の認証及びBluetoothの認証費用はかからない

 Bluetooth low energy は、[Made for iPhone (MFi) プログラム](https://developer.apple.com/jp/programs/mfi/) の締結が必須ではありません。クラシックBluetoothでは、特定のiOSアプリケーションと接続するデバイスの開発には、Apple社とMFiプログラムの締結が必須でした。MFiプログラムを締結して初めて、ハードウェアやソフトウェアの開発情報が提供されます。

MFiプログラムが必須ではなくなったことで、ベンチャーの参入ハードルが極端に下がりました。 Bluetooth low energy デバイスと接続するiOSアプリケーションは、AppStoreの承認を得られます。ただし、デバイスにMFiロゴを掲載する場合は、ロゴの使用権を得るためにMFiプログラムの締結が必要です。

 Bluetooth low energy の電子回路を独自に設計した場合の製造コストは5ドル程度です。これらの電子回路を小さな基板にまとめて部品化したものを、モジュールと呼びます。モジュールの価格は10ドル前後です。

モジュールを使うことで、電波法の基準認定とBluetoothの規格認定および製品登録にかかる初期費用が省けます。

電波を出す回路は、外部に電波がもれ出ない試験環境で動作させるか、あるいは、それぞれの国ごとの電波法に基づく基準認証をうけなくてはいけません。認証を取得しているモジュールを利用すれば、製品ごとに認証をとる必要はありません。

また、 Bluetooth low energy ロゴを表示して販売するには、Bluetooth SIGへの製品登録が必要です。製品登録には、Bluetoooth SIGへの、最低でも年間5000ドルのメンバー登録費用と、設計ごとの認証費用が必要です。

各社のモジュールは、それ単体でのBluetoothの製品登録が完了しています。無償のBluetooth SIGのメンバー登録をおこない、 Bluetooth low energy のモジュールを利用した派生製品として登録すれば(この登録は無償)、製品登録が完了します。

### アクセサリの実例

アプリケーションやネットワークそして事業までを統合したアプセサリは、まだ少なくこれから登場するでしょう。アクセサリ自体は、2012年の夏あたりから次々登場しています。いくつかを紹介します。

1つは、プロトタイピングのための開発キットやアクセサリです。これらは、早い時期から登場しています。まずBluetooth LEの半導体やモジュール会社が、組み込み機器開発者向けキットの提供を開始しました。iOSアプリケーション開発者のなかにも、Bluetooth LEデバイスの開発をしてみたい要望があります。次に登場してきたのが、その要望にあわせて、組み込み機器開発者でなくても使いやすい、より安価な開発キットです。

日本の技術基準適合証明を取得しているプロトタイピングに向いたものに:

* SBBLE(サブレー) [http://sbble.micutil.com](http://sbble.micutil.com)
* Konashi [http://konashi.ux-xu.com](http://konashi.ux-xu.com)
* センサータグ [http://www.tij.co.jp/tool/jp/cc2541dk-sensor](http://www.tij.co.jp/tool/jp/cc2541dk-sensor)

があります。

SBLBLE(サブレー)はマイクロチップ・テクノロジー・ジャパン株式会社のPICマイコンを採用した開発キットです。市販のUSB Bluetooth4アダプタを挿して使います。Konashiは、iOSアプリケーション側の開発がObjective-Cに加えてJavaScriptでも開発できます。ウェブ・サービスの開発者が、フィジカル・コンピューティングをiOSでおこなう場合の唯一の選択肢です。センサータグは、テキサス・インスツルメンツ社の半導体の評価キットで、25ドルと低価格です。次のセンサを搭載しています:

* 放射温度センサ、温度センサ
* 湿度センサ
* 圧力センサ
* 加速度計
* ジャイロスコープ
* 磁力計

必要なセンサが上記にあるプロトタイピングであればセンサータグを、LEDの点灯など低速の外部装置制御をiPhoneから行うならKonashiまたはSBBLEを、任意のファームウェアを開発したいときはSBBLEを選択するとよいでしょう。

キーホルダーまたはタグは、よくあるアクセサリです:

* キーホルダー、
[iPhone用探せるキーホルダー](http://buffalo.jp/products/catalog/supply/bluetooth/bluetooth/security/bshsbtpt01/)
* StickNFind [https://www.sticknfind.com](https://www.sticknfind.com)

キーホルダーは、iPhoneと接続して使うものです。iPhoneを置き忘れしそうになった時にキーホルダーから警告音を出したり、キーホルダーのボタンを押すとiPhoneから音が出る機能でiPhoneを探すのに利用します。タグは、代表的なものにStickNFindがありますが、ものに取り付けておいて、ものを探すのに使うものです。その機能は、キーホルダーのボタンを省略したもので、おおよその距離をiPhoneで確認すること、iPhoneから操作してタグから音や光を出すこと、ができます。

たいていのキーホルダーやタグは、仕様が公開されていたり、ソフトウェア開発キットが提供されていて、アプリケーション開発に利用ができます。近接検出または光や音の出力を必要とするプロトタイピングに利用できます。

この他にも:

* 心拍センサ、 [Alpha](http://www.alphaheartrate.com)
* 活動量計、[Fitbit](https://www.fitbit.com)
* 睡眠記録、[オムロン ねむり時間計](http://www.healthcare.omron.co.jp/corp/news/detail/223)
* 姿勢検出、 [Lumoback](http://www.lumoback.com)
* 腕時計、[Pebble](http://getpebble.com)
* 顔検出、[HVC-C1B](http://plus-sensing.omron.co.jp/egg-project/)

などが市販されています。

アクセサリに直接アクセスできるSDKを提供するもの、アクセサリに直接アクセスするAPIはなく、ウェブ側に蓄積されたデータにアクセスするAPIを提供するものなど、APIやSDKの公開は、製品ごとにまちまちです。-->

### 運用/破棄のシミュレーション
他人も入れて。
技術、設計も関わる。
トラブル、発生時。問い合わせ、解決、検索。技術的にも、設計。
表示、LED。現象。トラブルの原因が複数、わけがわからない。
出荷管理、財務の。増資。
トラブル、回収、連絡、アップデート。自動? 通知?
どういう気分で捨てるのだろうか?
次はどう考えるか。2つ目は、買わない。同業他社? その時の切り替えコスト。気分。



## ハードウェアとファームウェア
目的:体験を作ること、
成果物:構成、トポロジ、認証、電力と速度のバランス。
チームそれ自体も。連携。作ればいいものを作ればいいのか、何が成果かを探すのか。

戦略、戦術、実働。
外注、内部に入って、常駐で。いずれにしても成果物。なにかしら。


フルスクラッチ
無線モジュール
ODM、OEMの活用

### アプセサリの種類と構成
取りうる構成は、案外決まっている。
ハードウェア要素、使える技術、ソフトウェア的なものとハードウェア的なもの。
技術書、センサ工学、読んでおけばOK。半導体の会社、世の中にある製品。いろいろ。
表示装置: 点、面。LED、液晶、電子ペーパ、有機EL。LED。面に並べた。
入力と出力
最低でもボタン1つとLED。電源ONと動作状態表示。単体で最低限。
センサー、モータ。音。

前提: スマフォとの連携、将来的にはWiFi? スマートウォッチ的なもの、中継。

立場: スマートフォンで、ネットに繋がって、警告。
接続: 繋がりっぱなし、どこで繋がるのか、接続数、必要性。反応

価格、デザイン。
口コミ、売り込み?
制約条件: 取り付け位置、習慣化されるか?、消費電力、充電の手間、運用
第1章で分類した、取り付け設置位置でデータの意味とか採れるとか。
電池制約で、消費できる電力量。実用範囲。実験なら、毎日使うでは、間欠?

要素
- トポロジー
- ペアリング、ボンディング
- 消費電力、レスポンス
- 接続のタイミング

### ネットワークのトポロジ
半導体やSDKを選ぶ。ペリフェラルのみのもの、ペリフェラルとセントラルになれるもの(4.1以降)、同時接続数。

使い勝手的なところ。
セントラルとペリフェラル。スター型。ただし4.1から同時になれるので、中継、スキャッタネット。

所有権と、ユーザがどこを見るかというので:

一番簡単なのは、自分が持っている1台のデバイスと連携する。通知系デバイスとかは、それでいいだろう。健康系とか。いまのは、そういうのが多いんだろうね。所有者が自分一人っていうもの。

画面が2つあるもの、スマフォではきついものとか。中間に取りまとめ役がつく。:自転車のセンサー。これ統合して表示、でスマフォにも。この場合はセントラル2つに繋がるペリフェラルっていうのいいんだけど、自社製品なら、統合しちゃって、サイコン、スマフォに統合する。データ蓄積とかそういうの。こういうの炎天下とか、厳しい環境、スマフォでもいいんだけど、スマフォではきつい。温度とか。

複数でシェア、同時利用するもの。リモコンであれば、同時接続必要。共有の概念。エアコンのほうがセントラル、スマートフォンがペリフェラル。昔のだとできなかったけど、いまならできるか。あるいは、スマートフォン同士が連携してて、実は1台がつながっているだけ、ほかはネットで同期とか。WiFiにBLE入っていれば、ネット側からという、大きく迂回した構成もとれる。見た目同じなら同じだろう。
独自の仕様、後にアップデート。GATTベースなら共存可能。DFU。

範囲が広いもの:メッシュとか、パケットを中継するっていう。部屋伝いに。でもインターネット側にでるのは、1つのところだろうから、自宅ならね。だからスター型のおおきいやつ、でも物理的に1対1で電波が届かないなら、中継しましょうと。
自社で閉じる?

スマートフォンを使わない構成: IPv6系とか、そういう系統。
農業のセンサーとか、M2M的な。収容数とか、同時接続の数とか、
メッシュの構築、無線+プロトコルで総合でみた消費電力、管理のしやすさ。スマフォが入らないのなら、なんでもいい。たまたま使える。

今後は、ペリフェラルのまとめ役。サイクルコンピュータ的な。
IoT系、スマフォではなくてWiFiも含めた。
ホップ、メッシュ。規格的には。しかしWiFiを見てもわかるように。AppleID統合とか振る舞い。技術的に繋がるが、自社製品であればより簡単に。工夫。エコシステム。技術をユーザに見せない。

### 接続のタイミング
故障、イベント。突発的。近くを行き過ぎたら反応する。
所有権限。データは見られる。解析できる? 反応すべき?
あることがわかる、一方通行。OSとハード統合されていないときつい。

iBeacon的な。ブロードキャスト、アドバタイジング。

ユーザが画面を見ていること。バックグラウンド。たまたま。

据え置き。WiFi統合。大容量、電池。電源。1秒スキャン、10秒待機。かなり持たせられる。でも単体だと、表示? 検出?専用設計

読み書き。たまに反応。消費電力、スマートフォンが受け側。接地側なら。
アプリ、反応タイミング。バックグラウンド。10分に1回程度。たまたま。
ANCSに反応するものは?

### ペアリングとボンディング
接続するならば、
必要なのは、勝手につながったら困る。所有権。
勝手に知られるのは困る。データの所有権。操作の所有権。

セントラルをいくつまでボンディングできるかとか、管理、問題。
UIとか表示とか次第で振るまいが違う。要は、確認。りょうh

最初の接続の体験。ユーザが目で見て確認する。
キーがあるのか、パスコード入力か。機種ごとに。
アプリと完全統合するのもいいだろう。独自SMを設計するみたいな。

接続までの時間:
アドバタイジング・インターバル。発見して、接続をかける。初回は、アプリは2段階。なので、インターバルは短く。なにもなければ、長く。
ユーザの操作をした時にアドバタイジングとか、勝手に繋がるものなら、そう設計するとか。無駄な接続要求、電車の中でいたずら的なとか。

初期設定の体験:
コネクション・インターバル。最初の設定時、転送時間。リクエストで。

デバイス間の技術だから、複数の所有するデバイスで接続させたいときは、個別にボンディングさせるくらいしか、やりようがないと思うけど。独自にSMを実装してもいいか。接続は弾けないけど、接続はされないという。

アプリで、いつペアリング画面がでるのか。(実際には、ペアリングとボンディングだけど、iOSでは画面が1つになっているから。)

(ボンディングしてたら、勝手に繋がる? ANCSだと、いつの間にかつながっているっぽいか?)

必要になった時にiOSはダイアログを出す。セキュリティオプションが付いているキャラクタリスティクスにアクセスしたとか、アクセスされたとか。

### 消費電力とレスポンス
アドバタイジング、接続時。




## 認証周り
電波法とBluetooth SIG。
フルカスタム、モジュールを使う場合、
国ごと、
電波のものだから、電気を使う製品ごと。
説明書、本体、明記。
必要性: 電波という公共の財産を使う。輸入輸出、

### 電波法
各国で違う。実験する時から必要。モックアップ、モジュールとか。
大きさと電池のバランス、外形。

### Bluetooth SIG
販売するときに必要。
それぞれのレイヤーごとに提供されている。
相互通信、運用のため。認証、お互いに通信しあえる、無数の組み合わせ。第3者が認定することで。任意の組み合わせ。
無線レイヤー、電波、タイミング、プロトコル。電波法と同じく、検査機関。
モジュールを利用している時。カスタムプロファイルかどうか。
検査ツール、自己申告。
カスタムプロファイル。登録のみ。

費用の話。


## Bluetooth Low Energyの半導体
モジュールを使うとしても、カスタム設計としても、ファームウェア開発から見たら同じこと。
基本構成、専用プロセッサ+BLE専用、1チップ化。
特殊機能、ANTとか
WiFiとか、デュアル/シングルモードとか。多品種、他の機種。
開発環境や経験。

### 評価項目
(試作時と量産時の入手性、価格、モジュール、開発者。製造費用と開発期間)
(ODM/OEM?)

### 半導体の種類
(半導体会社はどんな会社があるのか)
(モジュール会社はどんな会社があるのか)
立ち位置、特徴、付加価値。

### 構成の全体像

処理と通信が別チップか1チップか:
BLEチップ + マイコン
SoCチップ(BLE+マイコン)
浮動小数点演算、専用回路。マイコン Cortex-M4F Cortex-M0

電池:コイン型リチウム電池、充電式。
半導体が違ってくる。充電管理および電源制御の半導体。

センサー系:

### 開発環境
IDE, 縛られているもの。MDK-ARM、IAR。Eclipse。フロント。
コンパイラ gcc, arm-cc
RTOS、ライブラリそのもの。
mbed?

### 他の無線通信技術との統合
マウス、既存。プロプライエタリ。製品間の通信。
WiFi統合。デュアル、シングルBT。

構成: SoCか、外部半導体か。
無線プラスアルファ: WiFi, デュアル、IoT系。ANT+。

- 性能
-- 消費電力、無線と処理
-- 処理能力
- 開発環境
-- 独自ライブラリの学習コスト
-- 今後のメンテナンス
-- ファームウェアの更新機能
- 特徴
-- ANT+, デュアル、WiFiなど

- Nordic
- TI
- Broadcom
- CSR
- ルネサス、東芝、ラピス
- Dialog

電池周り。Li-Po
充電管理、かつDC/DC変換

半導体。
SoC、各社。仕組みや構造。HCIベース、ワンチップ。
プロセッサ、ライブラリ、開発環境。
環境的なもの:
ANT+とか、既存の無線通信とか。マウス的な。
WiFiも同時であれば? そういうモジュールがいいかもしれない。
HomeKitとかならば? そういうのに対応している会社のがいい。契約などで。

モジュール
製造価格、大きさ(ピン)、SiP(アンテナ内蔵)、スクリプト。

マイコンの構成。BLE+マイコン、1チップ、か2構成。
アップデート。それぞれが認証範囲だから。チェック、確認。

### BT4.0/4.1/4.2
物理層はあるので、その上のスタック次第。けっこう、更新で行ける感じ。先を見越して。
メッシュネットワーク
音声通話

### 電気的な特性
ピンコンパチブル。
ベア台、WCSP。小ささ。
フォーラムの充実度。

## アプセサリでのファームウェア開発

### チーム構成
3の構成。ハードウェア、ファームウェア。1対1。仕事を投げると、動かないなどトラブル。対処。気分的な。常に、なにか仕事があるわけではないが中性中立の、3人目。

### 回路設計が先か、ファームが先か
回路設計、のちファーム。
機械部品があると、やっかいかもな。テスト用ファーム? BLEとか機能じゃなくて、テスト信号入力で機能確認。マイコンすら別のもの。回路開発の人が使うジグ。

マイルストーンをお互い決めて。回路が先。でも本番までの設計、時間がかかる。
開発用のボード。信号を当たれる。

モジュール、電波法的な。機能が同等品を使ってもOK。
32kHzの推奨のあるなし、LDOかDCDCか。GPIOの本数、アンテナの利得。

判別つかないところがある。大抵はI2CかSPI。
それほど高速バスでもないから、配線だけした開発用ボード。開発時はprintfデバッグ。ファームウェアの書き込みと、デバッグメッセージの出力用ポート。(開発版でも出荷時にファーム書き込みでポートはあるか)

本番の基板となると、ちょっと時間がかかる。
機能設計ならOK。後で電池とかと統合して困ったことがあるけど。


### はまりどころ
service changed。
ペアリング、ボンディングまわり。
ANCSのCCCDまわり。(iOS9ではどうなんだろう?)

### トラブルの原因切り分けと対応
振る舞いで。
再現。
パケットレベル
iOSのロギング。iOS自体。ハンドラ、service changedとか。
### スニファの準備と使い方
Windows/Mac


通信サンプル
開発環境的なところを解説。
発見と接続
ホワイトリスト
認証、ボンディングとペアリング
マスタースレーブ/サーバとクライアント
データベースの構築
サービス変更あたり、GAP
通信速度、MTUの変更とか

libUSB btstack
設定、ドングル、USBさして

# 開発のポイントとプロトタイピング

アプリケーションのサンプル、ハードウェアの試作あれこれ。
プロトタイピング、iOSアプリケーション単体、ハードウェア。
ペリフェラルも作れるから、そっちで試作。
わざわざプロトタイピングするのは、
センサとかIOとか大きさとか電池の稼働時間とか、iPhoneではハードウェアの要件を満たせない。
たくさんばらまく必要がある(費用)

## ハードウェア・プロトタイピング

### ファームウェアの位置づけ

ならば周辺機器側にファームウェア
単体で動かせす、通信？応用例ごとに違うもの。ユーザのアプリケーション。
センサーとかIO拡張系、入力のみ、出力が一般的なもの。
本当はサービスで、IOの先につながるセンサーとか機能を抽象化する、そうするとファームウェア。

オリジナルのファームが必要な場面:

応答時間が問題(100ミリ秒とかの)
サービスとキャラクタリスティクスを定義したい
非接続時に単体で機能させたい
切断時の振る舞いとかを定義したい

要は、ユーザのアプリケーションが度のタイミングで動作するか、とういこと。

通信でつながっている時は、機能をどこに持たせるか。レイテンシ、どうしょうもない。
サービスとキャラクタリスティクス、定義はファームウェア。汎用IOじゃなくて、機能を定義したもの。
例えばI2Cの先に温度センサーがあるなら、温度のサービスを。
汎用に使えるし。

非接続のとき、ファームウェア、単体。
切れているところの振る舞い。プロトタイピングならば、"切れたつもり"で模倣すればOK。でも、けっこう致命的かも。例えば、ラジコンに使っていたら、モータの出力設定そのままになるかもしれない。おとすなら落とすで、いいんだけど。結構、こういう切れた時の振る舞いは、デモンストレーションではもないにならないかもだけど。

###BLEのハードウェア開発

BLEのデバイス開発は、組み込み装置の開発そのものです。ARM Cortex-M0のようなマイコンに、BLEのプロトコルスタックとユーザのアプリケーションを入れて、周辺のスイッチやLED、そしてセンサーを動かすハードウェアを開発していきます。

マイコンを利用する開発の難易度は、何を作りたいか、どう作るかの構想により、大きく違います。構想をたてる時点から、組み込み会社と協業していくことを、おすすめします。マイコン用の開発環境(IDE)があり、C言語で開発していきます。

ここでは、BLEのデバイス開発について、見ていきます。試作では、むき出しの基板に組み上げた回路でもよいでしょうが、実際には、筐体や商品パッケージ、取扱説明書など付随するものも必要です。ここでは、それらは考えません。

###フルカスタム開発

半導体チップを購入して、ゼロから設計と開発をすることを、フルカスタム開発と呼びます。フルカスタム開発の設計の流れは:

1. 半導体チップメーカからBLEの半導体を購入
2. 半導体チップメーカの推奨設計例をもとにして、基板回路などを設計
3. 電波法の認証 (試作では1台単位、製造では製造設備単位で認証が必要)

となります。製造まで考慮すると、製造時試験の手順決定と技術文書の作成など、多くの項目がありますが、ここでは省略しています。

BLEの半導体には、BLEの通信機能だけがあるものと、BLEの通信機能に加えてマイコンまで内蔵した、いわゆるSoC(システム・オン・チップ)の2種類があります。いずれを採用する場合でも、通信の制御にマイコンは必須です。

BLEの通信機能だけがあるものを使う場合は、その半導体とマイコンの間は、ホストコントロールインタフェースというBluetoothの規格に従ったプロトコルでやりとりをします。既存の製品にBLEを追加する場合で、すでに製品の中にあるマイコンで通信制御まで実現する場合には、この形を取ります。

SoCは、BLEのプロトコルスタックとユーザのアプリケーションが、BLEの半導体に内蔵された1つのマイコンで実行されます。回路面積を小さく、かつ消費電力を最小にできる利点があります。BLEデバイスをゼロから企画する場合で、大きさや電池の持ちに注目するときには、こちらを採用します。

CC2540を使ったファームウェア開発で、TI社のファーム焼きソフトを使っている場合、"データフラッシュの消去"をすると、CC2540のユーザ書き込みMACが0に初期化される。ドキュメントには、ユーザ指定のMACが0なら、メーカ書き込みのMACを使うとあるが、実際には、使っていない。ユーザのMACが0もしくは0xffいずれの場合も、その値を使ってしまう。すべてのデバイスのUUIDがおなじになり、個別識別ができない。ロット単位のエラッタなのかどうかは知らない。なので、フラッシュをクリアしてしまったときは、メーカ指定のMACをコピペで書き込んでおく。

###モジュール

BLEの通信部分を入出力端子が外部に出ている小さな基板に収めたモジュールという部品があります。いろいろな会社からモジュールが出ています。

モジュールを採用する利点は、Bluetoothや電波法の認証を自社で取得する必要がないことです。一方で、モジュールの基板(大変小さくて、1cm角ですが)の形と大きさに製品が制約される場合があります。小型あるいは細長いようなBLEデバイスを開発するときには、モジュールの外形確認が必要になります。

モジュールは、Bluetoothの相互接続認証と電波法が求める工事認証を取得しているため、これを採用すればフルカスタム開発のファームウェア開発を除く手順が省けます。

2012年8月までは、モジュールの工事認証の条件に、モジュールが用意に着脱できること、という条件がありました。これを満たすため、モジュールには“コネクタ”がありました。しかし、2012年8月に、この条件が撤廃されたことで、直接ハンダ付けで固定する表面実装タイプの工事認証が通るようになっています。

###BluetoothとMFiのロゴを掲載するには

Bluetooth対応のロゴ、およびMade for iPhoneのロゴを商品に掲載するには、それぞれBluetoothの相互接続認証の取得とMFiプログラムの参加が必要です。

Bluetoothは、認証費用自体は実費で5万円程度ですが、Bluetoothのメンバーに登録するための年会費が1万ドル必要です。自社で設計開発する場合は、自社でBluetoothの相互接続認証を取る必要があります。たいがいのモジュールは、Bluetoothの相互接続認証を取得しています。この場合は、そのモジュールを利用した派生製品であるとBluetooth対応製品のリストに無償で登録ができます。

Bluetoothのロゴを掲載しなくても、正体不明のRF装置として販売はできますが、iPhoneのようなBluetooth SMART READYな装置に接続することを表示するためには、Bluetoothのロゴは必要です。

iPhoneはBluetooth SMART READYなので、BLEデバイスはiPhoneに接続できます。このBLEデバイスの販売およびアプリのストア認証にMFiプログラムは必須ではありません。しかし、MFiのロゴを製品に掲載したいならば、MFiプログラムへの参加が必要です。

###半導体チップについて

Bluetooth4対応デバイスは、従来の3までのBluetoothとLow Enery両方と接続できるデュアルモードと、 Low Energyだけに対応するシングルモードの2つにわけられる。iPhoneとBLEで接続するデバイスは、BLEのみに対応する、シングルモードデバイスになる。
シングルモードデバイスは、無線および制御回路を1つにした集積回路として、テキサス・インスツルメンツ、CSR、およびノルディック社の3社から販売されている。
TI社はCC2540およびCC2541の2つのシングルモード集積回路を販売している。価格は2ドル。8051マイコンを内臓しており、BTLEプロトコルスタックをIAR Embedded Workbench IDEのライブラリとして提供している。GPIOおよびADCなどの豊富なIOもあり、BLE接続センサーがワンチップで実現ができる。 CC2541は、BLEに加えてTI社およびノルディック社の独自2.4GHzデータ通信方式も対応している。この独自の無線通信は、例えばマウスやキーボードで独自の2.4GHzの通信仕様を利用している製品をBLEに移行するときに、従来の独自通信技術に対応させつつ、かつBLE対応が求められる場合に使われる。チップサイズは6mm角。

CC2540/2541の開発は、IAR Embedded Workbench 8051を使う。モバイルライセンス、フルセットで 35万円ほど、機能限定版で 25万ほど。また、保守(更新)は、最初3ヶ月は無料、年間更新料として購入価格の20%がかかる。
CSR社は、ウェブサイトで概略しか情報を公開していない。TI社のCC2540同じようなマイコンを内臓したものを販売している。BLEの開発部門はサムスンの出資をうけている。このため、純粋な半導体メーカとして続くのかは、不安に感じるところがある。
ノルディック社は、nRF8001およびnRF8002を販売している。nRF8001は、TI社のものと違い、BLEの プロトコルスタックまでを提供しており、制御はACIインタフェースをとおして別のマイコンで実現する。 nRF8002はnRF8001に、キーレスエントリーのようなキーホルダーに使われる近接等のプロファイルを実 装したもので、BLEで最もよく使われるキーホルダー的な機能が実現できる。チップの価格は3ドル程度 (Mouserで274円、80円/ドルより)。チップサイズは5mm角。
またCortex-M0+を搭載したSoC、nRF51シリーズを発表している。ノルディック社が提供してきた独自規格の2.4GHz通信とBLEに対応したものが出荷されている。この開発環境はKeil MDK-ARMを使います。このライセンス料金は、30万円程度です。このSoCのファームウェア開発方法は、ARM Cortex-M0+の手順そのままです。

### モジュール

この他に、BlueGiga社はTI社のCC2540を採用したモジュールを販売しています。このモジュールは、IAR WorkbenchのようなC言語開発環境の代わりに、BASICのようなスクリプト開発環境を独自に提供している特徴があります。また、FCCとCEを取得しており、Bluetoothの相互接続認証を取得しています。ですからBluetooth対応の製品リストに無償で登録ができるので、Bluetoothのロゴを表示して販売ができます。

### 許認可の取得

Bluetooth4 Low Energy機器を販売するためには、販売国での認証取得が必須です。この認証は、電波を 放出する機器が他の機器の動作を阻害しないことを承認することで、無線局免許がなくても電波を発する無 線装置を運用してよいという制度が求めるものです。この認証なく電波を発した場合は、日本では使用者が 電波法違反を問われます。
Bluetoothのロゴを掲載するには、Bluetoothの団体に加入して、機器相互接続試験をクリアしなければな りません。ロゴを掲載せずBluetooth機器だといわないならば、これを取得していなくても、販売は可能で す。プロファイルによりますが、150~250万円程度がかかります。
この認証は、米国ではFCC、日本ではTELEC、欧州ではCE、と呼ばれます。FCCおよびCEは、一般的な 電気機器にもとめられるEMC(電磁両立性、電気機器などが備える、電磁的な不干渉性および耐性)も必要になります。

EMC試験および無線機器の認証取得代理を提供している会社がいくつかあります。試験および書類申請までを一貫してサービスとして提供しています。回路や電波の技術と法律の両面の知識が必要で専門職でなければ対応は難しいので、設計段階から、相談をしておくことが大切です。

電波を出す製品を米国、日本、欧米で販売するための許認可は、それぞれFCC、工事認証、CEになります。設計したものが基準を満たせず再試験になった場合には、その追加費用など、付随する費用発生がありますが、最低限必要な費用なの目安は:

- FCC 165万円くらい
	- EMC(9kHzを超える) 40~50万円
	- 無線に関わるもの(Part15 sub C、電磁障害なきこと) 80万円
	- 米国への書類提出など 25万円
- 日本 48万円くらい(書類作成、申請代行費用は含まず)
	- 工事認証(工場生産単位での認証) 48万円
- CE 合計220万円くらい
	- EMC 100万円
	- 無線関連(障害なきこと) 80~90万円
	- 電気機器の安全性確認 30万円
		- 認証に提出するデータは、量産と同じもので計測されたものを提出します。

製造設備および体制に対して、 求められるものは:

- FCC
	- 特に無い
- 日本
	- 製造されたものの特性が同一であること、そのために品質が管理されていることを書類で明らかにする。
	- 具体的にはISOを取得している、出荷時検査の装置や測定手順が決められていてデータが保存されているなどの、体制の整備が審査対象になる。
- CE
	- 特に無い
	- しかし、各国で抜き取り調査をしている。もしも違反している場合は、製品の全数回収の義務が生じる。また罰金が課せられる。

###プロトタイピングのプラットフォーム

KonashiとかサブレーとかRFduino。
nRF8001を使った、BLE112を使ったArduinoシールド。BLEのなんとかBee。Seeedstudioで購入可能なもの。
タイプとして
USBドングル
モジュール
半導体(HCI)

ファームウェアの問題、書き換え。何かをさせるトリガー的なもの。
PICの環境、Arduino側マイコン。
IOに特化
個別開発環境は、やっぱりきっついので、使い慣れたもの、フィジカルコンピューティングで定評がある環境。

##はまりどころ

通常のコネクションする使い方ならば、ハマるところはない。
強いて言えば:

- CBPeripheralは自分でretainしないといけない
	- scanForPeripheralsWithServicesで取得したCBPeripheralはアプリ側でretainしないといけない
- デバイスから強制定期にBluetoothの接続切断をすると、iOS6では、CoreBluetoothが例外を飛ばしてくる
	- try~catchして処理

このほか:

- iPhoneが接続したことがないBLEデバイスのUUIDは、アドバタイズメント・パケット受信時はnull
	- iPhoneが、任意のアプリで一度でも接続したことがあれば、UUIDが取得できる。iPhoneの電源On/Offをしてもクリアされない。どっかにキャッシュをもっているのだろう。
- iOS6では、iPhoneからBLE接続を切断しても、iPhoneは30秒〜1分程、BLE接続をもっている。このためBLEデバイスからアドバタイズメント・パケットが送出されない
	- アドバタイズメント・パケットを利用する場合は、デバイス側から強制的にBLE接続を切断する。

このように、細かい所で、iOS5とiOS6で振る舞いが違うところ、タイミングのパラメータ値が違うような些細だけど、使い方によっては致命的になる、ところがある。しらないと、はまるので、事前の確認をしっかりすること。

##開発方法のおすすめ

BLEのハードウェア開発は、次章で述べるように、組み込み開発が必要になるために、どうしてもiOS単体で閉じた開発に比べて、時間がかかる。

iOS6では、たぶん、ペリフェラル側もiPhoneでプロトタイピングするのが、よいのではと思っている。BLEデバイスの開発には、ハードウェアそれ自体が特別なセンサーを利用しているか、またBLEの開発の中心は、ハードウェアなのかそれともデータ処理のアルゴリズムなのか、で区別してみる。

まずBLEが特殊なハードウェアを使うものであれば、iPhoneにそのハードウェアの機能がないので、プロトタイピングにはならない。しかしダミーデータを流す程度には使える。

BLE開発が、データ処理に価値がある場合がある。例えばフィットネス関連のBLEデバイスは、ほとんどが、加速度を使う。加速度から消費カロリーや歩数、高度の変化などを算出するのは、データ処理になる。このような、iPhoneにもあるハードウェアを利用し、その開発の工数の多くがデータ処理の場合には、iPhoneでのプロトタイピングは絶大であろう。

iPhoneでプロトタイピングしたソースコードをマイコンに移植すればよい。そのソースコードは、当然ながら、マイコンの性能に合わせて書きなおさなければならないかもしれないが。

BLEのデバイス自体は、とても簡単な回路ととても単純なデータ処理をする設計が多い。電力消費量とデバイスの大きさを考えれば、そのほとんどの処理はiPhone側に持たせたほうが、合理的で利点があるから。


## iOSアプリケーションの実際

### シミュレータでBluetooth LEのデバッグ

加速度、向き、モニタリング。
セントラルとペリフェラル。

大量のデータを送るには。
すれちがい通信的な使いかた。

### トラブルの原因切り分けと対応

Appcessoryという単語が示す通り、Bluetooth LEデバイスとiOSアプリケーションそしてネットワークの先にあるサービスが連携して初めて、魅力あるBluetooth LEデバイスという製品になります。しかし、意図せぬ振る舞いが、開発中また販売後に起きるかもしれません。ここでは、iOSアプリケーションとBluetooth LEデバイスが意図しない振る舞いをすることを、トラブルと呼びます。

トラブルが発生した場合は、原因の切り分けが必要です。そのためには、トラブルを再現する方法や発生条件を明らかにすることが必要です。これらのタスクは、ユーザから情報を集めるような対人タスクと、与えられた条件から現象を論理的に分析する純粋な技術タスクに分けられます。具体的なトラブルは予測困難ですが、発生しうるトラブルの種類を列挙して、タスクの割り振り役および分野ごとの担当者などを、開発チームで事前に決めておくことが重要です。

トラブルの原因が設計によるものであれば、それは、iOSアプリケーション単体によるもの、Bluetooth LEデバイス単体によるもの、および両者の振る舞いの組み合わせによるもの、の3通りです。また、それが分析できるのはBluetooth LEデバイスの設計者か、iOSアプリケーション開発者のいずれかです。

ほとんどのトラブルは、iOSアプリケーション開発者の初歩的なミスが原因です。例えば、CBPeripheralのインスタンスをリテインし忘れたために接続が解除された、のようなケアレスミスによるものが多いです。開発過程での、ケアレスミスによるトラブルで発生するやりとりを防止するには、Bluetooth LEデバイス開発側が、iOSアプリケーションのCore Bluetoothフレームワークを使う部分まで含めて、開発を担当することが有効です。

iOSアプリケーションとBluetooth LEデバイスの振る舞いの組み合わせがトラブルの原因の場合は、両者の振る舞いをログを取りながら突き合わせるか、あるいはBluetooth LEの通信パケットをロギングして解析します。いずれの場合も、iOSとファームウェアおよび通信の知識が不可欠になるため、領域ごとの担当者が個別に担当するのではなく、同じ場所と同じ時間を共有して対処にあたるように、事前に決めておくことが重要です。

使用しているBluetooth LEデバイスが、市販品とその付属ライブラリを利用しているのか、または独自に設計しているのかで、対処が異なります。市販品の場合は、ライブラリのソースコードが公開されているならば、ソースコードを読むことが原因を見つける早道です。もしもソースコードが公開されていないならば、Bluetooth LEの通信パケットをロギングして解析するほかありません。独自に設計したデバイスを使用しているならば、ファームウェアのソースコードもつきあわせて、開発者間で振る舞いを1つ1つ確認していくのが、早道です。

## 開発環境とターゲット

4S以降、環境iOS5以降
Xcode


### 参考情報源

https://developer.apple.com/library/ios/documentation/NetworkingInternetWeb/Conceptual/CoreBluetooth_concepts/AboutCoreBluetooth/Introduction.html

https://devforums.apple.com/community/ios/core/cbt

https://lists.apple.com/mailman/listinfo/bluetooth-dev



### Bluetotoh LEに対応するiOSデバイスとOSのバージョン

Bluetooth LEに対応するには、ハードウェアとOSがそれぞれ対応しなければなりません。

Bluetooth LEはBluetooth4の規格の一部です。スマートフォンのハードウェアの仕様に、Bluetooth4対応と書かれていれば、それはBluetooth LEにも対応しています。iOSデバイスは、2011年10月に発売されたiPhone4S以降の全てのデバイスがBluetooth4に対応しています。2013年8月時点で、Bluetooth4に対応するiOSデバイスは、iPhone4S、iPhone5, 第5世代iPod touch、第3および第4世代iPad、そしてiPad miniです。

Bluetooth LEに対応するOSのバージョンは、iOS5およびiOS6です。Core Bluetoothフレームワークは、iOS5以降のSDKに含まれています。初めてBluetooth LEをサポートしたiOS5はセントラルの機能を提供しています。次のiOS6では、セントラルに加えてペリフェラルの機能にも対応しました。セントラルおよびペリフェラルについては次の節で述べます。

iOS5およびiOS6は、iPhone3GSおよびiPhone4などの、ハードウェアがBluetooth4に対応していないiOSデバイスにも対応しています。Core Bluetoothフレームワークは、アプリケーションが実行されたデバイスがBluetooth LEに対応しているかいなかを、デリゲートを通してアプリケーションに知らせます。

Bluetooth LEを使うアプリケーションの振る舞いが、機種により異ならないかは、大きな関心事です。もしも振る舞いが異なるならば、どのiOSデバイスでどのように異なるのか、またその理由を理解して、テスト項目に入れなければなりません。筆者の知る範囲では、iOSデバイスの機種間で振る舞いが異なることはありません。

デバイスごとの差異が生じるうる要素には、アンテナ設計、無線通信の半導体およびその内部で動作するファームウェア、そしてiOS側の通信制御プログラムがあります。

アンテナは機種ごとに異なります。アンテナ自体の利得および指向性が異なるかもしれません。Bluetooth LEで通信をするだけであれば、利得の違いは通信可能距離の大小として見えます。検出される電波強度の絶対値が異なりますから、電波強度を用いる応用例では、その違いが振る舞いを変えるかもしれません。例えば、電波強度による近接検出ならば、近接と判断する距離が機種により異なってくるでしょう。

無線通信の半導体は、Bluetooth規格に従い実装されるので、半導体による機能の違いはないはずです。また[iFixit](http://www.ifixit.com)が報告しているiPhoneの内部構成をみると、無線通信の半導体は、iPhone4SとiPad3はBroadcom社のBCM4330、iPhone5とiPad miniとiPod touch 5th Genは、同じくBroadcom社のBCM4334を採用しています。BCM4330からBCM4334の変更点は、半導体の製造プロセスが65nmから40nm LPに変更され、受信動作時のピーク電流が68mAから36mAに半減したことです。ですから、ただし、受信動作による電池消費量は、機種によって2倍違うでしょうが、ハードウェアの機能の違いはないでしょう。

iOS側の通信制御プログラムは、iOSのメジャー番号が変わると異なることがあります。またマイナーバージョンで、バグの修正や動作をより安定にする変更が入ります。動作保証対象となるiOSのバージョンごとに、動作の確認が必要です。

<!-- iPhoneそれぞれが使っているモデムの半導体の番号を確認する -->
<!-- 機種ごとの振る舞いの違いがあると、いやんなので、半導体型番が同じ=タイミングの振る舞いも同じだろうと、裏付けるための情報 -->

<!-- iPhone4 http://www.ifixit.com/Teardown/iPhone+4+Teardown/3130/3 Broadcom BCM4329FKUBG -->
<!-- iPhone4S http://www.ifixit.com/Teardown/iPhone+4S+Teardown/6610/2 ムラタのモジュール Murata SW SS1830010. 他のサイト http://eetimes.jp/ee/articles/1110/17/news109_5.html ではレイアウトの刻印から  BCM4330 -->

<!-- iPad3 4G http://www.ifixit.com/Teardown/iPad+3+4G+Teardown/8277/2 Broadcom BCM4330 802.11a/b/g/n MAC/baseband/radio with integrated Bluetooth 4.0+HS and FM transceiver-->
<!-- Single-band 2.4 GHz 802.11 b/g/n or dual-band 2.4 GHz and 5Ghz 802.11 a/b/g/n
FM receiver and transmitter
Bluetooth Core Specification Version 4.0 + HS compliant with provisions for supporting future specifications
Full WAPI software and hardware support
An integrated ARM® Cortex™-M3 processor and on-chip memory
The OneDriver™ software architecture for easy migration from existing embedded WLAN and Bluetooth devices as well as future devices
SmartAudio® technology that dramatically improves voice quality in Bluetooth headsets -->

<!-- iPod touch 5th Gen http://www.ifixit.com/Teardown/iPod+Touch+5th+Generation+Teardown/10803/3 Murata 339S0171 Wi-Fi module -->

<!-- iPad mini http://www.ifixit.com/Teardown/iPad+Mini+Wi-Fi+Teardown/11423/1  Murata 339S0171 Wi-Fi module.  BCM4334 http://www.ifixit.com/Teardown/Apple+A6+Teardown/10528/2#s38332 -->

<!-- The Murata Wi-Fi SoC module actually comprises a Broadcom BCM4334 package in addition to an oscillator, capacitors, resistors, etc. You can see all the components in the X-ray (third image).
Murata assembles all of the components together and sends their package to Foxconn, where it eventually ends up on the iPhone's logic board. Chipworks said it best: "Murata makes a house that is full of other people's furniture."
Here are the die images for the Broadcom BCM4334, fabricated in Taiwan at TSMC on a 40 nm CMOS process. Its key features:
Wi-Fi (802.11 a/b/g/n)
Bluetooth 4.0 + HS
FM Receiver -->

<!-- iPhone5 http://www.ifixit.com/Teardown/iPhone+5+Teardown/10525/2#s38299 Murata 339S0171 Wi-Fi module , 上記のiPad  miniと同じもの-->

<!-- http://www.anandtech.com/show/5601/broadcom-announces-new-combo-chips-bcm4334-bcm43241-shows-80211ac-once-more -->
<!--
First is BCM4334 which is the follow-up part to BCM4330 that we've seen in a bunch of devices. BCM4334 changes from a 65nm process to 40nm LP, which itself offers a power profile reduction. The change isn't a simple die shrink either, Broadcom says it has worked on and refined the existing BCM4330 design and reduced power a further 40-50% and dramatically reduced standby power by 3 orders of magnitude. I asked Broadcom to give me a realistic estimate of power consumption - BCM4330 in full Rx mode consumes around 68mA, BCM4334 consumes 36mA at the same voltage, just to give an example of the reduction. Air interfaces don't change between BCM4330 and BCM4334. The second part, BCM43241, is a 2x2MIMO combo chip that's geared at tablets and also is built on a 40nm process. -->


## 周辺機器を使う

### どんな周辺機器があるのか。

Keyfob、
Kickstarterでたくさん。NODE、LUMOBACK、脳波、心拍、感圧ペン。自転車関連。
ライブラリを公開している。Wahooフィットネスとか。
センサー系、IO系。単体で機能をもたせるというのより。

###Keyfob

切断時の振る舞い、
近接の使いかた、

### 心拍センサー

生体情報の基本。
プロファイル、サービス。
機種によって、R-R間隔とか。
使うには、ライブラリ、自分で使う。サンプルコード。

###TI センサータグ

汎用に使える、試作に、小ささと価格。
サンプルコード、認証とか改造するのは、Wikiを参照。
微妙なのよね。

## シミュレータでBLE

iOSのBLE開発で、シミュレータでBLEを使うには、内蔵のBTアダプタは使えない。NVRAMを設定して、本体ではBLEアダプタを掴まないようにして、シミュレータに直接かませる。
使用出来るドングルに制約があるみたい。MLを見ると、BroadcomはNG、CSRはOK。市販のBT4のUSBドングル。
Amazonで購入できるものを試してみる。

- dongle list
- 日本語

## その他

http://developer.apple.com/library/ios/#technotes/tn2295/_index.html

Technical Note TN2295
Testing Core Bluetooth Applications in the iOS Simulator

iOS 5.0 provides the Core Bluetooth framework for creating iOS applications, which can detect, connect, and communicate with Bluetooth 4.0 Low Energy (LE) devices. The standard method for testing Core Bluetooth applications is on a device such as the iPhone 4S, which has Bluetooth LE support. In order to facilitate the development of Core Bluetooth iOS applications when one does not have a Bluetooth LE iOS device, the iOS 5 SDK simulator can be used to test these applications with the help of a third-party Bluetooth LE USB adapter. This Technical Note describes the process to enable and verify simulator support on an OS X system.

iOS5.0はiosアプリケーションを作るのにCore Bluetoothフレームワークを提供しています。
BLTEデバイスの発見、接続と通信をする。
Core Bluetoothアプリケーションの標準のテスト方法はiPhone4SのようなBluetooth LEをサポートする実際のデバイスで実行すること。
Bluetooth LE iOS デバイスを持っていない開発者が開発するために、iOS5 SDKシミュレータは、3rdパーティのBluetooth LE USBアダプタの助けでアプrケーションをテストするのに使うことができる。
このテクニカルノートは、OS X システムで、有効にして確認する。

注意書きとして、iOSシミュレータが実機と異なる振る舞いをしたときは、バグレポートを送れと。
注意書きとして、シミュレータだけで動作確認をおわらさせず、必ず実機で確認しろと。

必要なもの
- Mac system with Mac OS X 10.7.3 or greater
- Xcode 4.2.1 with iOS 5 SDK or greater
- Bluetooth LE USB adapter
ビルトインでBTLEサポート(BT4搭載)していても、必ずUSBアダプタが必要なのが注意点。

### 手順

### NVRAM の設定。

ターミナルを開いて、NVRAMコマンドを次のように入力する。

	user$ sudo nvram bluetoothHostControllerSwitchBehavior="never"
	Password:********

keyと値は、大文字と小文字を区別する。スペルミスに注意。

システムの再起動は、これを実行した直後では、不要。
なぜこのステップが必要なのかは、
see section Understanding the OS X Bluetooth Driver Behavior

### Bluetooth LE USBアダプタを接続する

必ず、NVRAMの設定をしたあとに、Bluetooth LE USBアダプタを接続する。

### NVRAM設定を確認する

システム情報アプリケーションを開いて、システムBluetoothドライバがビルドインBluetooth ホストコントローラインタフェース(host controller interface HCI)とマッチしているか、確かめる。
Hardware->Bluetoothセッティングで、Vender IDが"0x5AC"であることを確認。

<!-- 図を入れる-->

もしもシステムBluetoothコントロラーがBluetoth LE USBアダプタにマッチしていたら、iOSシミュレータは外部Bluetooth コントローラをBluetooth LEサービスに使えない。
この場合は、図2のシステム情報Bluetoothパネルのように。
Bluetoothドライバが、Cambridge Silicon Radio(CSR)Bluetooth LE USB adapterにマッチしている。
この場合、アダプタを外して、ステップ1 NVRAM設定、に戻る。

### Bluetooth をiOSシミュレータで有効にする

XcodeでiOS 5 iPhone/iPadシミュレータでiOSをランチする。
iOSシミュレータが起動したら、アプリケーションを閉じて、設定アプリを選択して、一般タブで、BluetoothをOnにする。

シミュレータのiOSアプリケーションを咲き起動。iOS Core Bluetoothアプリケーションは、Blueooth LEデバイスに接続して通信するはず、
Bluetooth LEサポートが有るiOSデバイスで実行された時のように。

注意書き:もしも知っステムにBluetooth LEアダプタが接続されていないなら、Bluetooth設定をOnにすることはできない。
Bluetooth4.0サポートがないときにシミュレータを実行したら、-[CentralManager state] は  CBCentralManagerStatePoweredOff を返す。
Bluetooth LEサポートがないiOSデバイスで実行したときは、、-[CentralManager state] は  CBCentralManagerStateUnspportedを返すだろう。

### 実際

- OS X 10.8.4
- Xcode
デフォルト設定は、

	nvram -p | grep bluetoothHostControllerSwitchBehavior

何も設定されていない。(空文字列。-d で削除できる。) 刺しても、外部BTに写らないみたい。

設定しないと動かなかった。ハードウェアで見ても、切り替わりがよくわからないのか？
iOSシミュレータをリセットすると、UUIDがNULLになっていた。キャッシュのクリア状態が再現できるんだな。

本体のBT On/Offは関係するか？
わからない。ただ、iOSシミュレータをリセットしたら、Keyfobが繋がらなくなった。アドバタイズはとれているけど。これはなぜ？
実機でアプリを動かすとすぐに接続しているから、この振る舞いはシミュレータ依存であろう。

iOSシミュレータを動かしている時にUSBドングルを抜くと:

	2013-06-26 14:11:54.547 KeyFobSample[12153:1b0b] CoreBluetooth[ERROR] XPC connection interrupted, resetting
	2013-06-26 14:12:03.512 KeyFobSample[12153:c07] CoreBluetooth[WARNING] <CBConcreteCentralManager: 0x8c49c40> is not powered on

ステートがOffに変更される。iOSシミュレータを起動したまま、USBドングルを挿すと。BluetoothがOff状態からOn表示になった。
アプリのほうは、USBの抜き差しで、アドバタイズの受信動作が止まっているみたい。アプリは再起動すれば動く。

### ドングルの動作確認

* プラネックス BT-Micro4 http://www.planex.co.jp/products/bt-micro4/ 価格2000円、実売1100円(Amazon)
 *  CSR8510
* バッファロー BSHSBD08BK http://buffalo.jp/products/catalog/supply/bluetooth/bluetooth/adapter/bshsbd08/  価格2509円 実売1300円
 * CSR8510

### OS X Bluetooth ドライバの振る舞いを理解する

デフォルトのOS X Bluetoothドライバは、外付けのBluetooth HCIがアタッチされたら、
ビルドインのBluetoothインタフェースからドライバが離れて、外部HCIにアタッチする。
もしもHCIがAppleデバイスじゃなければ。
この振る舞いは、
Bluetooth LEアプリケーションを開発する
OS Xアプリケーション開発者にとっては利点。古いMacを持っていて、ビルトインがBluetooth LEをサポートしていないなら。
開発者は、Bluetooth LE USBアダプタを、その新しいHCIにシステムBluetoothドライバがアタッチして、
OS X Core Bluetoothアプリケーションが実行して、そのアダプタを通してBluetoooth LEサービスがアクセスできると。
一方で、ビルトインドライバを通して提供されていた既存のBluetooth接続は失われる(HIDデバイスとか。キーボードやマウスなど)

ところが、iOS Core Bluetooth開発者には、この振る舞いはiOSシミュレータとコンパチブルじゃないの。
iOSデバイスと全く同じようにBluetoothの振る舞いをシミュレータがしようとすれば、Bluetooth LE HCIを直接開かないといけない。
もしも内蔵のドライバが外部Bluetooth LE HCIに自動的にアタッチされたら、シミュレータは外部HCIで接続を開くことはできなくなる。
ドライバのマッチングの振る舞いを制御するのに、ビルトインBluetoothドライバはbluetoothHostControllerSwitchBehavior NVRAMセッティングを認識する。
もしも"never"なら、外部Bluetooth LEアダプタが接続されたとき、システムドライバは外部HCIをサポートするようにスイッチしたりは、しなくなる。
OS XビルトインBluetoothドライバの振る舞い。

* bluetoothHostControllerSwitchBehavior="never"
** あたらしいHCIが接続されたら、ビルトインドライバは、ビルトインHCIにアタッチされたまま。
* bluetoothHostControllerSwitchBehavior="always"
** 新しいHCIが接続されたら、ビルトインドライバはビルドインHCIから切断して外部のHCIに接続される。
* bluetoothHostControllerSwitchBehavior="default"
** 新しいHCIが接続されたら、ビルドインドライバはビルドインHICから切断されて、外部のHCIに接続される。もしも新しいモジュールがAppleモジュールじゃなければ。

### OSX Bluetooth LEアプリケーションをテストする

iOSとOS X、両方でBluetooth LEアプリケーションをテストするなら、
bluetoothHostControllerSwitchBehavior setting を復元しないといけないかも。

2つのケースがあり:
ビルトインBluetooth LEのシステムでiOS / OS X Blueotooth LE アプリケーションをテスト
ビルトインなら、
NVRAMの bluetoothHostControllerSwitchBehavior="never" setting のままにしておく。
iOSシミュレータは外付けHCIを、OS Xアプリケーションは内蔵HCIを使う。

ビルトインがない場合:
OS Xのアプリケーションをテストするなら、bluetoothHostControllerSwitchBehavior setting to the "default"にする。
iOSのアプリをテストするときは、"never"に切り替える。

## スニファの準備と使い方

### 前知識

スニファ？
BTLEでパケットをダンプする。振る舞いの切り分け、通信状態を見る。
アプリから見た振る舞い、アプリ自体、iOSのBluetooth LEの振る舞い、通信自体の振る舞い、接続先のファームウェア、その装置の捜査状況。
切り分け。
通信部分。専用機器、(500ドルから1000ドル程度かな？)。ちょっと見るには、高価。

安価。TI社。

注意:
無線。アドバタイズメントが3チャネルあるから、たまたまモニタしているチャネルで通信が始まれば、追跡できる。
専用のもの。高価。TI開発キットのものを流用。
CC2540MINIDK_Dongle

### 資料

http://processors.wiki.ti.com/index.php/BLE_sniffer_guide

### 手順

- 購入
- ファームウェアをUSBドングルに焼きこむ
- パケットスニファのアプリケーションを起動する

### 環境

Windows xxx

### 買い方。

http://www.ti.com/tool/CC2540DK-MINI
CC2540DK-MINI
99ドル

http://www.ti.com/tool/cc2541dk-mini
CC2541DK-MINI
でもOK。

http://www.ti.com/tool/cc2540emk-usb
CC2540EMK-USB

違いは、KeyfobがCC2540かCC2541か、という違い。
CC2541は、CC2540のUSBをなく、RFの消費電流を削減したもの。
USB接続が不要な場合は、こっちのほうが適している。

BlueGigaのモジュールはUSBのも、ROMが128kBで、スニファには流用出来ませぬ。
ドングルはデフォルトでスニファのファームウェアが書き込まれている。
The CC2540 dongle is delivered pre-programmed with dedicated packet sniffer firmware.

<!-- デフォでファームが書き込まれている。これをやるのは、評価用とかで使っちゃったとか、バージョンが上がって、ファーム更新のときのみ -->

### フラッシュプログラマのDL

http://www.ti.com/tool/flash-programmer
v2じゃない方
”Flash Programmer for 8051-based CCxxxx SoCs and RF Evaluation Boards”とある方をDL。

注意:
Windows VistaまたはWindows7では、インストール開始直後に”User Access Control”ダイアログが表示されるかもしれない。
ユーザが管理者権限を持っているならば、"yes”ボタンを押してインストールを継続する。もしも管理者権限がないなら、管理者権限のあるユーザIDとパスワードを入力する。

### スニファをDL

http://www.ti.com/tool/packet-sniffer
からアプリをDLする。
SmartRF Packet Sniffer runs on Windows 98, Windows 2000, Windows XP (32 bit), Windows Vista (32 and 64 bit) and Windows 7 (32 and 64 bit).

### ファームを焼きこむ

プログラマの起動
デスクトップアイコン、スタートメニューのFlash Programmer
C:\Program Files (x86)\Texas Instruments\SmartRF Tools\Flash Programmer\bin\SmartRFProg

最初に、CC DebuggerをUSBに接続。このDebuggerのファームウェアが古いと、警告画面が表示される。
ファームウェアの更新。上のプルダウンメニュー、”Program CCっっxSoC or MSP430”になっているのを、選択して、”Program Evaluation Board”を選択して、右にある”Update EB Firmware”をクリック。
ファームウェア更新完了。

上のプルダウンメニュー、”Program CCっっxSoC or MSP430”に戻す。
USBドングルを接続。電源さえあればいいので、電池とか他のUSBポートでもOK。接続して、CC Debuggerの本体にあるリセットボタンを押して、リセット。

	\program files\Texas Instruments\SmartRF Tools\Packet Sniffer\bin\general\firmware\sniffer_fw_cc2540_usb.hex

ファームウェアを選択して、"Erase, grogram and veriry"を選択、”Perform actions"を押せば、書き込み開始。プログレスバーがフルになればOK。

USBにドングルをさして、デスクトップアイコンのSmartRF Packet Snifferを起動。

### パケットの見方

### Tips

パケットスニファには、スニフしたパケットを、UDPパケット	で送信する機能がある。
PDFマニュアルの
SWRU187G、
2.4 Packet broadcast.
14ページ。

外部アプリケーション、テストの自動化に使えるかもね。

暗号化している場合は、Long Term Keyをテキストファイルにして置くことで、解析可能らしい。
暗号化は、パケットのタイミング、送受信パケットの順番でやっているから、1つでもパケットの受信をミスすると、デコードできなくなる。

タイムアウト。普通はパケットをスニフしているからタイムアウトがわかるけれども、もしもパケットを受信ミスしてて、タイムアウトしたら、スニファはタイムアウトとわからず、そのまま受信し続ける。
もしも本当に通信がタイムアウトしているなら、手動で止めればいい。


### リソースリスト

USBドングルの写真
med_cc2540emk-usb_cc2540emk-usb_web.jpg
http://www.ti.com/tool/cc2540emk-usb より引用
49ドル。

## Core Bluetooth フレームワークの実際の振る舞い

実際の振る舞い、通信、外部、アプリ単体で完結しない。
振る舞い。Core Bluetoothからは見えない。しかしアプリを作るときには必要な。タイミング。

### 振る舞いの時間

デバイスを見つける
デバイスを見つけられる
	アドバタイズメントのデータ内容
識別する
	サービス、ローカルネーム
非接続で状態を知る
	キャラクタリスティクス、サービス、メーカ独自のアドバタイズメント・データ
接続する
	この一連ので時間はどんだけかかる
普通の読み書きする
長いデータを読み書きする
通知を受ける
暗号化とか権限つき
切断する

### 消費電力?

### 長期安定動作?

## 使いかたの場面によるCore Bluetoothの使いかた

ブロードキャストで周囲に伝搬したい
すれちがい通信をしたい
まとまった量のデータを送信したい
