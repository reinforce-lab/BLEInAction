
























































Bluetooth Low Energy を利用した周辺機器(アクセサリ)は、スマートフォンのアプリケーションと連携することで、これまでのアクセサリにはない魅力が生まれることがわかってきました。この新しい概念を説明するために、アプリケーション(Application)とアクセサリ(Accessory)を組み合わせたアプセサリ(Appcessory = App + cessory) という造語が作られています。




ですが、サンプルにはない独自の機能を実装したい、あるいは想定した動作をしないから原因を調べる場合などには、


超低消費電力無線通信技術 

じつは、アプセサリを構成するアプリケーションそしてアクセサリの設計には、必ずしも Bluetooth Low Energy の無線通信技術の知識は必要ありません。

整備されたソフトウェア開発環境とライブラリがあり、

はそれらが隠蔽してくれます。また豊富なサンプル・コードも整備されていますから、

機能実装はとても容易です。

アプセサリは、かならずアクセサリとアプリケーションとを開発しなくてはなりません。
これら2つは Bluetooth Low Energy という無線通信技術で連携します。

するのですが、ソフトウェア開発環境が整備されていて抽象化されたライブラリを

Bluetooth Low Energyは、2010年に規格が公開された Bluetooth4.0 で統合された、低頻度で少量のデータをやりとりする分野に適した

近接無線通信技術として後方互換性を保ちつつ進歩を続けてきた無線通信技術が、Bluetoothです。2010年に規格が公開された Bluetooth4.0 では、それまでのBluetoothの技術ではカバーできない分野に向けた超低消費電力無線通信技術 Bluetooth Low Energy が統合されました。

世界で初めてBluetooth4.0に対応した機器は、2011年に発売された iPhone4S です。世界に広く普及したiOSデバイスがいち早く Bluetooth 4.0 に対応したことで、iOSデバイスを中心として急速に Bluetooth Low Energy を活用した製品が登場してきています。

スマートフォンのアプリケーション


体験が重要。ブラックボックス化。
体験を作る上で、知っておくと便利。
仕様書は無償で入手できる。2600ページを超える。
Bluetooth全般について書かれているので。
何が大切、何を知るべき。
必要なところだけ。それほど複雑な技術ではない。いや、簡素に設計されている。

## Bluetooth4.0で統合された技術

Bluetooth は、電波が直接届く機器との省電力な近距離無線技術として、進歩を重ねてきました。ヘッドホンやテザリングなど、パソコンなどで周辺機器を無線化する技術としてよく使われています。

しかし、フィットネスなどから、この技術の進歩の方向とはまったく違う方向の技術、低頻度で少量のデータをやりとりする超低消費電力な無線通信技術が求められていました。その領域を埋める技術として Bluetooth4.0 に統合されたのが、 超低消費電力無線通信技術 Bluetooth Low Energy です。

Bluetooth Low Energy は、ウエアラブル・デバイスや、Internet Of Thingsと呼ばれるものに適した技術であること、そしてBluetooth4.0を採用したスマートフォンが急速に普及したことで、注目を集めています。


Bluetooth Low Energy に対応したアプリケーション





ハードウェア、要望。設計、実現、能力。
選択。
アプリケーションの体験、反応速度、消費電力、電池交換、本体設計。
あらゆる項目が関連付け。知らないといけないこと。

ブラックボックス化。

振る舞い、開発、規格。



Bluetooth Low Energy の周辺デバイスを独自に設計するならば、無線通信技術と規格の深い理解が必要です。また、iOSアプリケーション開発に使う CoreBluetooth フレームワーク は、Bluetooth Low Energy を素直に実装しているので、iOSアプリケーション開発の基礎知識としても役立ちます。

Bluetooth の[規格書](https://www.bluetooth.org/en-us/specification/adopted-specifications) [^2010] は、だれでも無償で入手できます。しかし、この規格書は2600ページを超える分量があるため、ここから Bluetooth Low Energy を理解するのは大変です。

[^2010]: [Specification Adopted Documents https://www.bluetooth.org/en-us/specification/adopted-specifications](https://www.bluetooth.org/en-us/specification/adopted-specifications)

この章は、Bluetooth Low Energy の無線通信技術と規格を解説していきます。規格書から Bluetooth Low Energy の部分を取り出しまとめるだけではなく、なぜそういう仕組みになっているのか、それがどんな利点につながるのかを、理由とあわせて述べます。






**書くべき項目**
セキュリティ・モデル、Lv1,2,3
ペアリングとボンディングについての詳細、
暗号化のまとめ、通信路、AuthenticationとAuthorization、書き込み時の認証、読み出しの暗号化
BT4.1との差分、簡潔なまとめ。リンク層、32-bit UUID、IPv6、 LTEとの共存
 後方互換。
BTの仕様書のどこをどう読めばいいか

IPv6とBT。

4.0から4.1
4.1から4.2

規格承認プロセス、費用。
無線通信的なあれこれ。



この章は、組み込み機器開発およびiOSアプリケーション開発に必要な無線通信技術を要点をおさえて解説します。



例えば、ワイヤレス・マウスがパソコンと無線通信する場合を見てみます。マウスが検出した移動量が情報として電波で送信されます。これには、信号を電波にのせて送信する半導体素子が必要です。パソコンのUSBに挿された受信回路がその電波信号を受信して、デバイス・ドライバがマウスの移動量を受信情報から取り出して、オペレーティング・システム (Operating System、OS) に伝えて、はじめてマウス・カーソルが動きます。

例えば、先ほどのワイヤレス・マウスには、プロプライエタリな通信プロトコルがよく使われます。USBの専用受信機がUSBのマウスのデバイス・クラスを実装していれば、パソコン本体からみると有線のUSBマウスと同じに見えます。ですから、オペレーティング・システムに特別なデバイス・ドライバは必要なく、普通のマウスとして使えます。マウス本体とその専用受信機間で無線通信ができればいいのですから、プロプライエタリな規格でよいのです。

例えば、ワイヤレス・マウスであれば、パソコンやモバイル機器などが Bluetooth Low Energy のワイヤレス・マウスに対応していれば、専用受信機を必要とせず、すぐにマウスを接続して使えます。開かれた規格のもとで接続先と周辺デバイスが作られることで、特定の会社の製品群に限定されない相互接続ができるデバイスの市場が生まれます。

複数の企業が団体を作り通信規格を一般に開くことで、半導体メーカ、周辺デバイス・メーカーそしてパソコンやスマートフォンのメーカが、はじめて利益を得られます。その通信規格が普及すればするほど、規格に適合した半導体が売れます。パソコンやスマートフォンは、便利な多種多様な周辺デバイスでより便利さを増し、周辺デバイスと共に本体も、より売れます。

<!--
 相互接続性、多種多様、あるいは数が出るもの
 Bluetooth Low Energy は一般に開かれた通信規格
 半導体メーカ、パソコンメーカ、
 周辺デバイスメーカ、大量な数が出る汎用品、多種多様、多様性。商品として成り立つ
 一般に開かれた通信規格、
 -->



## Bluetooth Low Energy の概要

Bluetooth 商標を所有する非営利事業者団体 [Bluetooth Special Interest Group](https://www.bluetooth.org/) [^3020] ( Bluetooth SIG と略します) が規格の開発を監督しています。Bluetooth SIG に参加して規定の料金を支払えば Bluetooth の知的財産を使う製品の開発販売ができる、一般に開かれた規格です。

[^3020]: [Bluetooth Special Interest Group https://www.bluetooth.org/](https://www.bluetooth.org/)

Bluetooth SIG には、ハードウェアやソフトウェアの幅広い会社が参加しています。通信を成り立たせるには、半導体素子からオペレーティング・システムまで多種の部品が必要です。そして、これらすべてを1つの会社で供給することは不可能です。 Bluetooth という規格と Bluetooth SIG という団体が中心になり、設計に必要な技術情報のすり合わせと、最終製品の相互接続の確認と認証の運営により、様々な企業の多種多様な製品間での相互接続が得られます。

Bluetooth Low Energy はBluetooth4.0 から規格の1部として取り込まれた、超低消費電力無線通信技術です。通信規格をそれぞれ部分に分けて見ていく前に、 Bluetooth Low Energy の全体像と各部分の関係を見ていきます。

Bluetooth Low Energy の特徴は:

1. 超低消費電力
2. ハードウェアの製造コストが低い
3. すぐつながる (すぐ切れる)
4. セキュリティとプライバシーへの配慮
5. 多様性がある

です。

### 超低消費電力

超低消費電力
電波、2.4GHz、高速な演算処理、プロセッサ、電力、
データ通信速度よりもなによりも高周波の信号処理、受信信号の増幅や送信
送信よりも、どのような強さで飛び込んでくるかわからない3桁の受信、信号。

超低消費電力、コイン電池、1つで1年間。万歩計のような製品。電池交換半年に1回程度、
無線通信部分だけ、でもセンサーやら周辺も。

製造コストが安いことも大切。
ウエアラブルの機器、タブ、3000円から1万円程度、デザインがよいとか高機能であれば2万円~3万円。
安いタグであれば、1000円程度。

1. 電波で1ビットのデータを送受信する、ビットの塊をやりとりする。
モジュールでも作らない限り、意識することはないだろう知識。電波工学がちょっと入る。興味あれば。
そんなものか程度。周辺に強烈な電磁場がいきかう環境で使いたいとかなら、このあたりの知識もいるだろうけど。

2. リンク層
お互いに電波が届く範囲で。
デバイスの発見、接続処理、パケットのやりとり。接続確認。
すぐ切れる、すぐつながる。

ビットレートと、レイテンシ。
ボタンを押したら情報が伝わる。1ビット情報。でも、さまざま。データがあるからとわかってから、接続してデータ通信してとか。意味がないでしょ。送るときはミリ秒程度でただちに、でも1秒にせいぜい100ビットも送れたらいい。

省電力
高周波の回路を駆動する電流は、どんだけ頑張っても同じ。無駄に送受信回路をONしない、ぎりぎりまで削り取る。
リンク層、

接続の数と同時に通信しているデバイス。
持っているデバイス、身につけているデバイスだけでも10個とか。
公共の場だと、身の回り50メートルに100人いれば、何百のデバイスが通信しあう。電波が聞こえちゃう。
リンク層、


3. パケットの意味付け
ATT/GATT、キャラクタリスティクス、サービス、構造。モデル化。
プロファイルとサービスという2つの概念。使い方、周辺デバイスの機能。

サービスとキャラクタリスティクスの検索と発見、
キャラクタリスティクスへの、
通信というよりも、あるモデルのあるプロパティ(属性値)が変化した、読み出す、書き込み。
ストリーミングではない。

3. 振る舞い

例えば、周辺デバイスにブザー音を出す機能、ユーザに何かを通知する出力機能。
キーホルダー、失せ物を見つけるときにiPhoneから信号を送ってブザー音を出させる、
腕時計のようなウエアラブルだと、メール着信をユーザに伝えるために、
どちらも機能は同じ、振る舞い。プロファイルはアプリケーション側。様々なサービス(機能)を組み合わせて、多様な振る舞い(プロファイル)が生み出せる。

これはCoreBluetoothも絡んでいる。すぐ切れる、すぐつながる。iOSが管理しない。デバイスの発見と接続はiOSアプリケーション。ユーザの操作を要求しない。

4. 

### ここみとけ

すぐつながる、すぐ切れる
ホワイトリスト、ボンディング、
iOSアプリケーションから接続の制御。ユーザの手が入らない。

プライバシー
通信しあう。相手がわかるはず。物理アドレス。
それを追跡していくだけで、
リンク層、

セキュリティ、
家の鍵、1ビットの開け閉め情報。
電波だから。データがわからなくても、どこかで傍受。それをそっくりそのままコピーして。
規格だから、ビット列はわかる。
困ります。
同じデータを送信していても、通信のたびに、電波でみてるとビット列は異なる。
鍵の方は、たしかに、正しい接続先だと判定する、そんな技術。

リンク層 (ホワイトリスト)、セキュリティ・マネージャー。

多様性
ATT/GATT、サービスとキャラクタリスティクス。
プロファイルとサービス。
機能毎。サービスがモデル。後方互換性をもったままサービスのバージョンを上げることができる。
オブジェクト指向のそれ。クラスの継承。

iOSの柔軟さ、アプリケーションにドライバ相当が入っているからこそ。
規格自体の拡張性。


### 開発とトラブルのトレース

通信の規格は、開発者の間の共通知識。やとりと。

シグナル・トレース

ビット、バイトがやりとりできる。
接続。
データの意味付け。

設計するとき、動かない。信号の流れ。一方通行。見えないけど。

電波であれば、スニファー、
周辺デバイスの内部処理であれば、マイコンのデバッガ(トレースとログ)
iOSアプリケーションであれば、ログ。
入ってくるところ、出て行くところ。出て行かないなら、予想と違う値や振る舞いなら、そこから原因を遡る。

ほとんどは、そのブロック。ただし、前のブロックが影響して、次のブロックに影響がでていることもある。
ここは、知識をベースに、具体的な開発のお仕事の話。


