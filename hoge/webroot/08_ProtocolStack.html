<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="ja">
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" type="text/css" href="style.css" />
<link rel="next" title="利用例" href="09_Application.html"><link rel="prev" title="ものへのBluetooth Low Energy技術の取り込み" href="07_Hardware.html">  <meta name="generator" content="Re:VIEW" />
  <title>スタックを作ってみる | うれしい たのしい びーえるいー</title>
</head>
<body>
  <div class="book">
    <nav class="side-content">
      <h1>うれしい たのしい びーえるいー</h1>
      <ul class="book-toc">
<li><a href="index.html">TOP</a></li>
<li><a href="00_preface.html">はじめに</a></li>
<li><a href="01_LetsBeginBLE.html">1 Bluetooth Low Energy技術 をはじめよう</a></li>
<li><a href="02_BLEOverView.html">2 Bluetooth Low Energy技術を知ろう</a></li>
<li><a href="03_LinkLayer.html">3 リンク層の技術</a></li>
<li><a href="04_HostControllerInterface.html">4 HCI, L2CAP, SMP</a></li>
<li><a href="05_GATT.html">5 ATT, GATT</a></li>
<li><a href="06_CoreBluetooth.html">6 Bluetooth low energyのiOSアプリケーション開発</a></li>
<li><a href="07_Hardware.html">7 ものへのBluetooth Low Energy技術の取り込み</a></li>
<li><a href="08_ProtocolStack.html">8 スタックを作ってみる</a></li>
<li><a href="09_Application.html">9 利用例</a></li>
<li><a href="11_BluetoothDiff.html">10 Bluetooth Core仕様書のバージョンごとの変化</a></li>
<li><a href="10_Appendix.html">Appendix</a></li>
</ul>
      <p class="review-signature">powered by <a href="http://reviewml.org/">Re:VIEW</a></p>
    </nav>
    <div class="book-body">
      <header>
      </header>
      <div class="book-page">
        <h1><a id="h8"></a><span class="secno">第8章　</span>スタックを作ってみる</h1>
<p>実際の通信例、動きを見る、処理を通じて。== USBドングルとの通信usbデバイス、HCI、コマンドのあれこれ。ソースコードの構成。Playground?開発とか動作確認手順== 接続と切断リンク層発見、アドバタイジング接続と切断</p>

<h2><a id="h8-1"></a><span class="secno">8.1　</span>実際の通信例</h2>
<p>手元で動く環境。HCI。&lt;!-- hci で色々叩いて、実例を示す --&gt;HCIで直接接続。HCIの解説。</p>
<p>実例</p>
<p>アドバタイジング接続ATT/GATT、読み出し。ペリフェラル。ペアリング、ボンディング。状態の永続化。JustWork、モデル1/2、セキュリティ1/2/3接続パラメータをいじるのと、通信速度、レイテンシ。</p>
<p>ペリフェラルにしてアドバタイジング。iBeacon互換にしてみる。振る舞い、アプリ側。エンディアン。</p>
<p>ANCSの接続をしてみる。</p>
<p>iOSのHCIのログを見てみる。</p>

<h2><a id="h8-2"></a><span class="secno">8.2　</span>実験メモ</h2>
<p>USBのドングルと接続する</p>

<h3><a id="h8-2-1"></a>ドングルの動作確認</h3>
<p>* プラネックス BT-Micro4 <a href="http://www.planex.co.jp/products/bt-micro4/" class="link">http://www.planex.co.jp/products/bt-micro4/</a> 価格2000円、実売1100円(Amazon)*  CSR8510* バッファロー BSHSBD08BK <a href="http://buffalo.jp/products/catalog/supply/bluetooth/bluetooth/adapter/bshsbd08/" class="link">http://buffalo.jp/products/catalog/supply/bluetooth/bluetooth/adapter/bshsbd08/</a>  価格2509円 実売1300円* CSR8510</p>

<h3><a id="h8-2-2"></a>OS X Bluetooth ドライバの振る舞いを理解する</h3>
<p>デフォルトのOS X Bluetoothドライバは、外付けのBluetooth HCIがアタッチされたら、ビルドインのBluetoothインタフェースからドライバが離れて、外部HCIにアタッチする。もしもHCIがAppleデバイスじゃなければ。この振る舞いは、Bluetooth LEアプリケーションを開発するOS Xアプリケーション開発者にとっては利点。古いMacを持っていて、ビルトインがBluetooth LEをサポートしていないなら。開発者は、Bluetooth LE USBアダプタを、その新しいHCIにシステムBluetoothドライバがアタッチして、OS X Core Bluetoothアプリケーションが実行して、そのアダプタを通してBluetoooth LEサービスがアクセスできると。一方で、ビルトインドライバを通して提供されていた既存のBluetooth接続は失われる(HIDデバイスとか。キーボードやマウスなど)</p>
<p>ところが、iOS Core Bluetooth開発者には、この振る舞いはiOSシミュレータとコンパチブルじゃないの。iOSデバイスと全く同じようにBluetoothの振る舞いをシミュレータがしようとすれば、Bluetooth LE HCIを直接開かないといけない。もしも内蔵のドライバが外部Bluetooth LE HCIに自動的にアタッチされたら、シミュレータは外部HCIで接続を開くことはできなくなる。ドライバのマッチングの振る舞いを制御するのに、ビルトインBluetoothドライバはbluetoothHostControllerSwitchBehavior NVRAMセッティングを認識する。もしも&quot;never&quot;なら、外部Bluetooth LEアダプタが接続されたとき、システムドライバは外部HCIをサポートするようにスイッチしたりは、しなくなる。OS XビルトインBluetoothドライバの振る舞い。</p>
<p>* bluetoothHostControllerSwitchBehavior=&quot;never&quot;** あたらしいHCIが接続されたら、ビルトインドライバは、ビルトインHCIにアタッチされたまま。* bluetoothHostControllerSwitchBehavior=&quot;always&quot;** 新しいHCIが接続されたら、ビルトインドライバはビルドインHCIから切断して外部のHCIに接続される。* bluetoothHostControllerSwitchBehavior=&quot;default&quot;** 新しいHCIが接続されたら、ビルドインドライバはビルドインHICから切断されて、外部のHCIに接続される。もしも新しいモジュールがAppleモジュールじゃなければ。</p>

<h3><a id="h8-2-3"></a>OSX Bluetooth LEアプリケーションをテストする</h3>
<p>iOSとOS X、両方でBluetooth LEアプリケーションをテストするなら、bluetoothHostControllerSwitchBehavior setting を復元しないといけないかも。</p>
<p>2つのケースがあり:ビルトインBluetooth LEのシステムでiOS / OS X Blueotooth LE アプリケーションをテストビルトインなら、NVRAMの bluetoothHostControllerSwitchBehavior=&quot;never&quot; setting のままにしておく。iOSシミュレータは外付けHCIを、OS Xアプリケーションは内蔵HCIを使う。</p>
<p>ビルトインがない場合:OS Xのアプリケーションをテストするなら、bluetoothHostControllerSwitchBehavior setting to the &quot;default&quot;にする。iOSのアプリをテストするときは、&quot;never&quot;に切り替える。</p>
<p>デフォルト設定は、</p>
<p>nvram -p | grep bluetoothHostControllerSwitchBehavior</p>
<p>何も設定されていない。(空文字列。-d で削除できる。) 刺しても、外部BTに写らないみたい。</p>
<p>ターミナルを開いて、NVRAMコマンドを次のように入力する。</p>
<p>user$ sudo nvram bluetoothHostControllerSwitchBehavior=&quot;never&quot;Password:********</p>
<p>keyと値は、大文字と小文字を区別する。スペルミスに注意。</p>
<p>vmwareをインストールしていると、切り替わらない。インストールしていないMBAだと、切り替わる。設定neverにより切り替わらない。システム情報の表示で、USBでのチップセットと、アップル社のチップセットで名前を確認すれば確実。USBドングルが光るとかだと、それで接続が判別できる。システム情報は、フロントパネルを開いた時に、その時の情報を一気に読み込んで表示。表示状態で、抜き差ししても表示内容は自動更新されないので、気をつける。確認したいときに、抜き差しして、表示を開いて確認。TBD: パネルの画像と、手順を入れること</p>
<p>システムの再起動は、これを実行した直後では、不要。なぜこのステップが必要なのかは、see section Understanding the OS X Bluetooth Driver Behavior</p>

<h2><a id="h8-3"></a><span class="secno">8.3　</span>libUSB かなにかでBTドングルに接続する</h2>
<p>kernel extension カーネルのモジュールkextstat83    0 0xffffff7f8162e000 0x9000     0x9000     com.apple.iokit.BroadcomBluetoothHostControllerUSBTransport165    0 0xffffff7f83697000 0x3000     0x3000     com.apple.iokit.CSRBluetoothHostControllerUSBTransport</p>
<p>Macのシステム情報で、USBデバイスから直接製造とProductIDを取得。CSR</p>
      </div>
      <nav class="book-navi book-prev">
                <a href="07_Hardware.html">
          <div class="book-cursor"><span class="cursor-prev">◀</span></div>
        </a>
              </nav>
      <nav class="book-navi book-next">
                <a href="09_Application.html">
          <div class="book-cursor"><span class="cursor-next">▶</span></div>
        </a>
              </nav>
    </div>
  </div>
  <footer>
      </footer>
  </body>
</html>
