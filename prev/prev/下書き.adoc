メモ:サービス視点、90%繋がっていればいい感じの
Bleutooth Low Energy とは何か

  理想な場面
    フィットネス的な。
    家に入れば、電気がON。音声通話で、ポケットの中のスマホからSiri。
    近くに来れば自動反応。
    自動車や部屋のレンタル。アプリを見て近くに来れが使える、ドアが開く。意外とつながらない繋がる。
  使い手から作り手に視点を変えて、実現するには
    無線は高価、オーディオやキーボードみたいにそれぞれのハードウェア端子というわけには
    無線は構成要素がいろいろ、半導体、スタック、アプリケーション、長い間のHW、採用と普及

  所有権や主語を組み替えることで
    ハードウェアとしてではなくて、もっとぼんやりとひろいもの。
    無線?ラジコン。アプリ、支払い、課金。10分間使える。ラジコンそのものだけど、そうじゃない。
    フィットネス、健康のデータ、データの蓄積。専門化による分析。万歩計とは意味が違ってくる。
    自分の自動車、誰かの自動車。レンタル、シェアリング。あるいは、レンタル会社のもの?所有と利用の権利を扱う。物理的な鍵。
    課金やサービス、認証、ネットワーク、事業経営のなかで。既存のハード
    いまはスマホ、ネットワークサービス、その先に。BLEはその世界でもIPの世界でも。
  技術背景は無線(が必須)
    物理的な世界とネットやアプリの世界。橋渡し。その中の1つ。
    BLEは、Bluetooth4.0から統合された超低消費電力な技術。繋いで使うのとは、だいぶイメージの違う無線。
    BTだけどいままでのBTとはちょっと違うこの技術、違いを見ていこう。
  どんな技術要素として必要性がある?
    他の無線、WiFi、携帯、クラシックBT。用途、ハード向け、通信向け、アクセスポイントあれこれ。
    カバーできない部分に向けた新技術、それがBLE。超低消費電力そしてウエアラブル向け。
    Bluetooth、結構使っていますよね。どんな場面?
    無線通信は通信相手がいて初めて成り立つ。ハードウェア向けの通信仕様。通信相手ありき。
    心拍計とか出てきている。進化してきているけど、その進化の方向ではカバーできない。
    抑えておくべきは、繋がり続けていることが年単位。1ビットあたりの電力の魔法ではない。
    利用場面似あわせて最適化することで、そうなっている。だからクラシックBTとは違って、ぽつぽつデータを送る用途。
    電池の選択、通信パラメータ、ファームウェアの工夫などで、桁違いにいろいろ違ってくるけど。
    多種多様、低消費電力、低コスト。
    意外とつながらない繋がる。
  規格の流れ
    Wibreeなど、いろいろあって2010年に規格として統合された。認証は大事。相互接続。
    中核技術、通信とデータ表現、そして運用。
    いままでのBTとは電波をやり取りする方式からして違う。なのでロゴを分けた。
    むちゃくちゃわかりにくいけど。SMART READYとSMART。
  色んな物の登場、普及
    これまでのBTと違う、多種多様なハードウェアを許す。用途が決められていてはだめ。でもいいままでは?用途を決めていた。
    セキュリティ、プライバシー、守りつつ、利用場面。
    スマートホン、iPhone。アプリ側も開放した。MFiなしに。一気に。スマホ連携ハード。アプリ。
    ハードウェアの作りやすさ。電波法、モジュール。サービス開始まで。試行錯誤。
  使われ方、アプセサリ
    例えば、フィットネス分野、アプリを通じてサービス、アプセサリ。
    アプリとアクセサリの造語。歩数、記録してスマホに入力する一手間が不要。
    写真がそうであるように、データは自動的に。そして画面。ソーシャル、口コミ。
    事業としてFitbitなど。上場。300円のハードウェア。
    つながり方の面白さ。ヘッドホン、つなぐ、音楽が流れる、切る。
    最初に設定しておけば、あとはなんとなく。
  使われ方、プラットホーム的な
    HomeKit、iBeacon。
    マイクロロケーション。ビーコンはブロードキャスト、常に検出。起動すべきアプリが自動起動。
    家電。ハードはMFi。Siriで操作できる。ハードウェア的にはAppleと秘密保持。アプリは作れる。
    その他、キーボードサポート、ヘルスケアアプリがいろいろ集約。
    楽器の仕様。ANCSの仕様。ロイヤリティフリーで公開。とてもオープンな。
  その先
    インターネット系、IoT系、構成、エッジ、ルータ、クラウド、
    BLEの未来。モバイルの次、スマートホンだけではなく、インターネットへ。同時に使える。
    音声とか、操作系?
    家電。メッシュネットワーク。パケットを中継する、ルーティング、ネットワークの能力。
    BLEの規格の範囲ではなくて、IPの技術。IPv6、6LowPAN、CoAP、MQTT。
    提供するのは、そのベースの部分。電波が届く範囲で、電波をやり取りする部分。

も少し詳しく、BLEの使い方とその概要。
  背景
    これまでのBTとずいぶんと使われ方が違うもの。さっきの冒頭の場面。
    概要理解でいいのだけど、なんのための技術か、使うための技術。その視点で。作るとなるともう少し詳しい技術なもの。細かいところで。
  BLEを成り立たせているもの
    全体像を見てきた。要素として、なんとなく繋がる、発見とかブロードキャスト、電池やコストの実施面、アプリ。
    物理的なもの、そもそも必要を満たすか。売れてなんぼなところ、使ってくれる人の母数。意外とつながらない繋がる。
    レイヤーをなしている。部分を見てもしょうがないが、全体から見て部分がはまっていないとしょうがない。
    スマホのアプリと繋がる部分に集中してみてみましょう。サービスは次の賞で。
    - 無線通信、無線で通信する部分、それを支える規格や認証制度。
    - サービスを支える、エッジデバイス。アプリ。スマホ。
    - 素早い、小規模な可能性の先に。
    - プラットホーム的な。楽器、ANCS、HomeKit...
  規格の流れ
    SMART SMART READY。
    4.0が出てから、4.1そして4.2。大きな変更というよりかは、暫定的な進歩。
    L2CAPチャンネル、セキュリティモデルなど。必要に応じて進歩している感じ。
    規格の要素を入れて、後でそれがどう生きるのかを。
  無線通信のこと
    用語:トポロジー、認証と認可。セキュリティとプライバシー。
    無線通信、相手がいる話。通信規格はベース。
    つたわること、つながること、セキュリティ(認証、認可)。これらは独立。その中で使えるもの、今まで出来なかった範囲。
    特徴は超低消費電力と、その上で情報を表現したりやり取りするGATTとプロファイルの仕組み。
    求められるのは、セキュリティモデルとか。
    レイヤーの話。
      ちょっと難しいけど。役割に分割することで、その下の層が何かを気にしなくてもいい。
      実際には、超低消費電力にしようとすると、その上の層も、それなりになっていないといけない。なので総合なんだけど。規格は綺麗さ。
      なので、クラシックBTでも、GATTは使えたりする。
    電波の通信の話。
      超低消費電力の秘密は、無駄に電波を出さないこと。極限まで絞る。だから時間同期する。
      2.4GHz帯は国際的なISM。案ライセンス。他の方式や電子レンジ、色んな物が使っている。届く距離。なので相互に干渉する。
      結構大事。920MHzとかある。国ごとのばらばらさ。あと同じ電力でももっと距離。だから事前にキャリアセンス。
      BLEは、送って受信できなければ諦める、割り切り。キャリアセンスもしないから。
      電波の届き方は、繋がる範囲、エリア検出だと物理的なもの。
    発見と接続とトポロジーと役割分担
      星形。最初はどこにいるかわからない、発見しないといけない。意外とつながらない繋がる。
      役割を分ける。役割の名前。ブロードキャストとスキャナ、マスターとスレーブ。
      無線の役割と、その上のデータをやり取りする部分と。セントラルとペリフェラル。
      なので、アプリから発見とか、消費電力があるので、常には動かない。適切なタイミングで。
    トポロジー
      役割が2つあるから、トポロジはスター型。でもペリフェラルはお互いに無関係。数も無制限。
      トポロジーがもつ意味。リビングのエアコン。同時に利用、いろんなデバイス?
      4.0では同時には1つ。4.1で複数同時がOK。自転車のセンサー、エアコン的な。メッシュ的な。
      利用場面、同時利用とかを決めちゃう。4.1からはかなり自由に。
    パケットのやり取りと消費電力
      レイテンシとスループット。
      マスターが常に出す、スレーブがそれに答える。コネクションインターバルごとに。つまりやり取りするデータは個々の部分。
      インターバルを短く、その後長くとか調整。データはあるだけやり取りできるけど、メモリの量。ケースバイケースすぎる。
      電池を気にする場合と、気にしない場合。使った分だけ使えればいい柔軟さ。ファーム次第。スマホ側ではなくて。
    セキュリティ
      通信それ自体。暗号化、認証、認可。パケット単位。規格だからいろいろできる。
      パケットのやり取り、なのでパケットのアドレス番号。プライバシー、追跡。ランダム化。
      ペアリングとボンディング。暗号の鍵を交換。共通鍵そして4.1で公開鍵暗号方式。
      所有、利用、確認。鍵の入力、OKボタンを押すだけ、PINコード、NFCみたいな。利用場面様々なので、オプションが多いが。
      アプリだと、スマホの管理画面にでてくるのは、ボンディングがあるものだけ。
    GATTとプロファイル
      多種多様、混在。スマホアプリ、カスタムプロファイル。振る舞いと機能。分離。データベースという考え方。
      サービスという単位+キャラクタリスティクス。ハードウェアの機能そのもの。
      プロファイル。サービスを使ってどういう振る舞いをさせるか。
      例えば、置き忘れタグとか。ハードを共通仕様にするのはBT SIGに提案して。
      カスタムプロファイル、カスタムなサービスを追加してとか、認証の範囲でできる。ここが大きい。
    認証制度
      相互接続のため、互換性。電波を出すので、公共の資源。製品とした時にはまた別に、電磁放射、コンセントに繋ぐならとか。
      BT SIGの認証と各国の電波法。あと電波を出すものだと、例えば日本だとVCCIとか自主規制。
      費用とコスト。部品だけ買って自分で設計、認証。モジュール会社のものは認証の価格が上乗せ。
      モジュールというもの。無線回路+認証。物理的な特性、電波の周波数の安定度や質。なので専門の認証のところ。
      相互接続、レイヤごとに。モジュールの認証を引き継ぐ。プロファイルで1つの製品。ただしカスタムではなくて。
      プロファイルの認証。自己申告制度。カスタムは自分でやればOK。費用は。
      なので、特殊なものでないかぎりはモジュールを使う。5ドル位。相当な数が出るものでも、モジュールを使っている。スマホ。
  プラットホーム、iPhone視点からみた
    通信相手としての存在。クラシックBTとBLEの違いMFiがあるかどうか。アプリが解放。アプセサリ。
    iPhone自体も、iOS6からスタート、iOS7、iOS8、iOS9それぞれで導入。
    iOSがやってくれないと手が出せない役割を果たしているような。
    CoreBluetooth。サービスの単位で。どのアプリからでもアクセス可能。
    アプリ、ハード、サービス。
    HomeKit、iBeacon、楽器、ANCS。それぞれの意味。例えばANCSは、iOSが持っている通知。Androidではインテントなどで自由だけど。
    楽器だと、コネクションインターバルが特別扱い。リアルタイム性。
  その先の、IP系の
    これから。設置型? 半導体各社、売れればOK。いろいろキット? 運用は? IPv6、WiFiルータ。IPv4ブリッジ? 携帯はIPv6かもだけど。
    直通とかそういうのは問題ではなくて。管理的なもの。Zigbeeとか独自システム。つーつーのトンネル? 物理が違うから必ずルータが入る。
    ご家庭なら? インターネットに繋がる、それとも閉じる? 認証とかまわり。HomeKit、ハード、管理。通信、貯める?

作り手側からのあれこれ
  背景
    最初の場面、勝手に作れるものではないし、ハードが絡む。アプリだけでもない。
    立場が重要、サービス発想、ハードウェア発想、アプリ発想。いろいろ。資本、技能者、強み、持っているものと持っていないものと。
    サービスのために必要、ハードウェアで参入、スマホやアプリだけでは成り立たない。いろいろ
    スマホ、母数が大きい。個人だけじゃない、業務利用も。需要、いろいろ。
    小規模からスタート可能。ハードウェアの壁。逆に大手は手が出しにくい、規模に合わせて生長すればよい。
    そもそもつながらなくても動くかとか。
    - ボトムアップ的な,ハードウェアからの
    - 事業的な、会社的な
    - 実務的な、サービス的な
  考えつくパターン
    所有者、利用者を考える。どんな体験か。そこにどんなハードウェアがあるのか。それらの購買や課金タイプを組み合わせて。
    いままでと違う点を考える。ものと一体になっていた、所有権がネットにより分離できたら。パケット制御の理論でリースを制御。
    要素、ハード、アプリ、サービス。
  発想の組み換えと最初の見るべきポイント
    ネットワークの図を見ると、階層。ネットワークには物理的なもの時間なもの、リアル世界とは違うもの。
    所有権や利用権利の切り離し、混合、併用可能。レイヤが上がれば、履歴から信頼度、実際のビジネス例。個人融資。
    時間がテーマでは。素早く動けば動くほど、売上と利益が上がる。消耗品であればサイクル設計。
  発想、事業的な、データの流れからの発想
    蓄積する、取得する。個人情報があることで、合理的なサービスであれば、喜んで。堅固な守ることが、ブランドに。国民の概念。
    データから引き出せる価値。身に付ける習慣のAND。生体データの分布。その価値。
    物理量と実際に運用可能なセンサー。費用、消費電力、ニーズ的な。だいたい大手資本の後追い。センサー単体で事業になる。
    入力と作用。
  過程
    ボトムアップ的な、プロトタイピングとその方法
      動くもので試す。細かいが、肝心なところ。電池交換必要とか、防水いるなとか。なので体験、完成品を作るわけではなくて。
      センサータグとかプロトタイピング用のキットあれこれ。半導体会社からも出てきている。少量を作って実験ルーム的な。
    ボトムアップ的な、体験を作る
      ダンボールや紙、あるいは演劇的に。考え方、概念を決めること、価値は何かとか。
      動くものを作るまでの時間、人を雇うか外注するか、納得感、売れるかどうか。
  デプロイ、事業的な、製造、売るって、捨てられるまでを考える
    スタート時点、売掛金と買掛金。そのタイミング、流通とかサポート、それぞれ用意すべきタイミング、費用。
    課金タイミング。購入、月額、サービス契約。
    デザイン。個人であれば。フィットネス。新モデル、新機能。5000円。
    規模の生長。口コミ効果
    サイクル。捨てられて、まだ買ってもらうのか。
  過程、実務での、実務的な、カスタムなハードウェアの作り方
    半導体会社。開発環境。実験なのか製造なのか。認証周り。工場が対応しているか。
    専門家に丸投げしない。iFixitで学ぶ。部品のサイト、フィジカル・コンピューティング。いろんなコンテンスト。知的財産。
    実務的な、チームを作る、動かす
      何を作るかを決める。短いタイミングで回す。負荷の集中など、サポート。
      ハードとソフト、接続部分。会社をまたぐと。設計は製造前提と変更前提でまるで違う。内部に抱える必要もないかも。
      通信プロトコル、解析、SDKまで。

無線通信規格の詳細
  背景
    考えるための知識。表現。
  各層の概要と全体からの役割
    階層構造、物理層、リンク層、L2CAP、ATT、GATT,SM、GAP。
    層ごと、分離。でも全体統合で、超低消費電力。連携。無視するのではなくて。
    SMは使い勝手に影響する。レイテンシとスループット。初回接続時は早く、そしておさえるとか。パラメータ。
  物理層層の技術
    電波で通信。2.4GHz。変調。信号の伝わり方、距離は送信電力と受信側感度、反射、干渉。
    物理層の1Mbpsというのはここの話。
    周波数を分割、ホップして。アダプティブ。使えない部分は使わない。周りにある機材。時間と周波数で。
  リンク層の技術
    隣り合うところと繋がる。基本。パケットの長さ。MACアドレス。パブリック、ランダム。
    ブロードキャスト。リンクしたら、タイミングを合わせる。結構短い。発振回路で0/1判定。Syncから。
  HCIとL2CAP
    リンク、隣り合う。マイクロ秒。秒単位。ハードとソフトの境界。HCI。
    L2CAP、論理的に。いくつか組み合わせ、クオリティ。ボタン操作と音声とか。BLEでの意味?
    微妙に無駄。でも、L2CAPチャンネル。GATTではなくて、IP系の技術のベースとして。リンク。
  SM
    セキュリティ。モデルとレベル。前提として、ペリフェラル。IOがいろいろ。認証モデル。
    ペアリングとボンディング。鍵の交換、保存。通信でどうやっているかといえば。
  ATTとGATT
    もともと1つの部分。2つに分けた。サービスとキャラクタリスティクス。データベース。
    その詳細。CCCD。ボンディングで保存。
  プロファイル
    振る舞い。機能部分。これは規格とは別に。公開されているプロファイル群。いろいろ。
  これから
    高速通信、パケット長が伸びるIP系でも。同じ消費電力で2倍送れる感じ。
    音声系。メッシュ系、高速。

iOSアプリケーション開発
  概要
    冒頭の場面、アプリはサービスと人、物をつなげる、モバイル。人はネットから見ると透明だし。サービス契約のひも付け、鍵。
    内部構成。iOSメインとBLEのモジュール。アプリとデーモン。
    iOS側、HCIとか音楽とか一般的なもの、カスタムプロファイル。消費電力との兼ね合い。アプリの状態。
    iOSとOS X。名前空間が同じ。
  CoreBluetoothのセントラル
    APIがどんなものに対応しているのか。バックグラウンド、振る舞い。
    発見と接続。
    サービスとキャラクタリスティクス。バイト数のあれこれ。
    接続の復帰方法、ペリフェラルの識別。
    ノウハウ的な。キャッシュ。インターバルはいじれない。ボンディング、サービスチェンジ。パケット見たほうが?
  CoreBluetoothのペリフェラル
    APIがどんなものに対応しているのか。
    サービスの構築、公開。実際に出ている電波はなにか。
    接続、サービス、キャラクタリスティクス、通信。
  BLEを使うその他
    iBeacon。常時検出。位置。近接。
    HomeKit。デバッグはネット共有すると便利。
    音楽、CoreMIDI。
  デバッグ方法
    実機のみ。かつてはシミュレータでもいけたけど。いまは、iOSのデバッグログを取得する。
    パケットを生で見る。対象がハードウェア。振る舞い。電源On/Off。こうなる集。
    机を並べて動作。SDKを渡すなど。責任の分界点。ライブラリを使う。
  はまりどころ
    つながらない、アクセス出来ない。機能しない。

カスタムハードウェア
  概要
    冒頭の場面を作るうえで。ハードウェア。
    カスタムな開発。用途。周辺機器で電池がシビア。集約してネットに中継する。
    プロトタイピングならiOSデバイスとか。Androidを利用するとかある。
  半導体そしてモジュール
    タイプとして、HCI(GATTスタック外部)、GATT使えるインタフェース、USB/SPI/シリアル。
    選択肢、既存のがある、イチから作る。電力気にする、気にしない。シリアルじゃなくて。
    半導体の会社それぞれ。組み込み。LinuxならHCI。開発言語、ライブラリの違い。
    Cortex-Mx + 無線でスタック / RTOSで隠蔽 / HCIでライブラリ。
    ユーザアプリが中に入るか。消費電力厳しい、販売価格、汎用性。開発者。リスト化。環境。
    センタータグ、全体システムとして。スマホ、ルータ。ペアリング、ボンディング。数。管理。
  特に組み込みで、特徴それぞれ
    ユーザフォーラム、作例。設定ライブラリ。認証とユーザアプリの兼ね合い。
    SiLab., Broadcom、Cypress、TI、Nordic。mbed。センサータグ、ファーム。ウエアラブルコード。
    加速度センサーとか、周辺。価格。精度、必要。歩数解析。DSP内部の。消費電力。ワンチップ部分。
    音声、L2CAP Channnel。メッシュ、独自なプロプライエタリ。ANT+。Zigbee。ラインナップ。
  実際の開発
    仕様のやり取り、サービスに合うのか。文化の違う人達。節目節目。がっつりやる段階か、小出しに出せるものか。
      基板作って実装、時間かかる、小規模でディスクリート。モジュールを使って、乾電池、小型化はその先で。
    見積もり、プロトでギチギチにやる必要はない。でも可能性はちゃんと手元で計算しておく。夢物語ではなく。
    オープンなので、Nordicを例に。BLEの規格を作っているところでもあるし。
    環境、費用。IAR, MDK, gcc。Segger。
    開発ボード。SDK。サンプル一覧。Packs。選択。組み込んでいく。メモリ制約。
  通信プロトコルに基づく、作り方あれこれ
    シリアル通信と何が違うのか。ストーリ。既存を。
    ノーティフィケーションとインディケーション。標準のプロファイル。
    ペアリングとボンディングの捉え方。プロトでとりあえず、後に。体験として。つながらないのはどんな場合か。
    ATT MTU。インターバル。ボンディング。暗号化。サービスの定義。
    ファームウェアの更新。それぞれ独自に。
    BLEの範囲を超えて
      独自通信方式、IP系、音声とかコーデック系とか。提案範囲。メッシュ的な。生来の展開的な。

実際の通信例
  概要
    実際に通信。電波を出す。パケットを扱う。
  USBのドングルを接続する
    OSに取られない設定。SwiftからUSBで繋ぐ部分。
  パケットでやり取りする
    HCIの基本部分。
    パケットスニフ、実際のパケット例。
  アドバタイジング、スキャン
  ATT/GATTでやり取りする
    パケット構造。
    サービス検索とキャッシュ。相手の振る舞いを見てみる。
    ハンドラ、CCCD。
    スループットとレイテンシの違いを見てみる。
  ペアリングとボンディング
    ペアリングとボンディング。
    再接続してみる。
    鍵を忘れてみる。相手が鍵を忘れた場合を見てみる。

付録: アプリ開発指針
付録: UUIDとは
