# アップルメーリングリスト
質問のまとめと回答。
目的：よくある質問への回答集。

* メーリングリスト、アーカイブ https://lists.apple.com/archives/Bluetooth-dev
* 登録 https://lists.apple.com/mailman/listinfo/bluetooth-dev

時期。BTLEが使われだした頃。iPhone4S発売以降(2011年10月)

PacketLogger?
Xcodeの追加ツールdであったな。
Hardware IO Tools for XCode Late July 2012, Xcode 4.4 をダウンロード。
ツールが出るけど、LEのデバイスがないのよね。

http://lists.apple.com/archives/bluetooth-dev/2011/Oct/msg00002.html
22バイト以上のlong read/writeについての質問。
20バイトまでしか書けないが、機能としてサポートは入るのか？と聞いている。

http://lists.apple.com/archives/bluetooth-dev/2011/Nov/msg00000.html
iPhone4Sの出力はどんだけか？ 通信距離を考えるために知りたいという質問。

http://lists.apple.com/archives/bluetooth-dev/2011/Dec/msg00007.html
バックグラウンド動作ができるのか？の質問に対しての返答。

There are two modes of backgrounding for Apps that use CoreBluetooth: Event and Session.

Event Backgrounding
Event backgrounding is probably what most Apps will use when interacting with Bluetooth Low Energy devices.  This mode does not allow for direct communications to the accessory when the App is in the background, but does provide for a notification from the accessory when it wants to communicate with the app.  iOS will stay connected to the BTLE accessory when your App is in the background and will continue to monitor for notifications.  When the connected BTLE accessory has a notification available, iOS will notify the user that the accessory would like to talk to your App, allowing the user to load your App and interact with the accessory.  As many devices need to conserve power, only providing information at deterministic times will greatly enhance the battery life of the accessory and the iPhone 4S.

- No info.plist entries are required for this mode.

Session Backgrounding
There are times where an App must interact with an accessory even if it is running in the background.  Consider a running app that needs to monitor heart rate real-time.  There is a clear START and STOP to this model.  The user STARTS their run in the App. While the run is active, the App reads heart rate information until the run is completed or STOPED.  Session backgrounding also allows for scanning and connection to BTLE accessories while the App is in the background.  A scanForPeripheralsWithServices or connectPeripheral call will continue, even when the App is in the background.  CoreBluetooth will continue to monitor for specific peripherals or peripherals that match the services your App is looking for and call your Apps delegate when found or connected.  Be mindful, that every time a BTLE peripheral or iPhone 4S uses its radio, it is depleting the respective devices available power.  App developers using session based backgrounding must be mindful of power usage.

- Session backgrounding requires a backgrounding mode entry to UIBackgroundModes, bluetooth-central, in your Apps info.plist.

http://lists.apple.com/archives/bluetooth-dev/2011/Dec/msg00009.html
Bluetoothの電源On/Offをアプリからできるか、への回答。
アプリ起動時に、BTをOnにする警告表示は出るということ。

http://lists.apple.com/archives/bluetooth-dev/2011/Dec/msg00013.html
L2CAPパラメータ変更に、0x01を返すのに実際にはリジェクトしている、ちゃんと実装されていないのでは？という質問。

これに対して、BTヘッドセットとWiFiの接続を保持するために制約があると回答している。アクセサリ指針を読めと。

http://lists.apple.com/archives/bluetooth-dev/2011/Dec/msg00019.html
アプリがバックグラウンドにあるときペリフェラルにつながらない、フォアグラウンドになれば直ちに繋がるのに、に対する返答。
When backgrounding, you can still scan and connect to a LE peripheral.  You can scan for peripherals using scanForPeripheralsWithSerives by stating what service you are looking for in a Peripheral.  You cannot do a general scan without stating at least one service in the passed dictionary.  If you have a CFUUIDRef from a previous connection, you can call retrievePeripherals with the CFUUIDRef.  Your delegate will receive a call to didRetrievePeripherals with a CBPeripheral.  With the CBPeripheral you can then connect using connectPeripheral.
バックグラウンドにあっても、ペリフェラルはスキャンできる。しかし、探しているサービスを少なくとも1つは指定して scanForPeripheralsWithServicesを呼ぶ。
以前の接続で CFUUIDRef をもっていれば、retrievePeripherals をCFUUIDRefで取れる。

アプリがバックグラウンドの時データを受信したら振動を出すことできる？っていう。

http://lists.apple.com/archives/bluetooth-dev/2012/Jan/msg00001.html
切断時に通知が来るか？の質問への返答。
didDisconnectPeripheral:error:で通知はわかっているのだが、接続時にオプションを渡せ、というのが気になる。これは渡さなくても、デフォ設定じゃなかったか？ TBD
At a disconnect, you should get a call to the centralManager:didDisconnectPeripheral:error: on your CBCentralManagerDelegete delegate. Please note that you have to set the CBConnectPeripheralOptionNotifyOnDisconnectionKey in the options dictionary when calling connectPeripheral:options: on the CBCentralManager instance.

http://lists.apple.com/archives/bluetooth-dev/2012/Jan/msg00004.html
電源が一度Offして再度Onした時に、BLEデバイスに接続できるか？という質問。何度か繰り返し質問を投げているが返答はきていない。
アプリが起動していないのだから、無理だと思うが。やるならば、アプリの起動制限をかけるあれで、電源ON時点でそのアプリが起動するなら、いけるか。

http://lists.apple.com/archives/bluetooth-dev/2012/Jan/msg00030.html
接続パラメータ設定についての質問。返答は、例によって、アクセサリ指針を読めだった。

http://lists.apple.com/archives/bluetooth-dev/2012/Jan/msg00035.html
UUIDからBLEのアドレスが取れるか、の質問への回答。ちょっと複雑だと前置きしてから、Publicアドレスと15分毎に変更されるDynamicアドレスがある。ペアリングすればDynamicからPublicアドレスを逆引きできると。
Bluetooth 4.0 Specification, Volume 3, Part C, Section 10.8
このややこしい仕組みをUUIDで隠している。デバイスを識別したいなら、アドバタイズメントパケットのDeviceNameを使うことを進める、と。

http://lists.apple.com/archives/bluetooth-dev/2012/Feb/msg00004.html
iOSシミュレータでのBLE動作の質問、への回答。内臓のBLEアダプタは利用しないから、外付けBLEアダプタを用意しろ、ということ。

http://lists.apple.com/archives/bluetooth-dev/2012/Feb/msg00009.html
ドングルをさした後NVRAMの設定で、OSがBTドングルを掴まないように設定しろ、再起動が必要、と解説。シミュレータがドングルをつかむって、そういう意味なんのね。
OSは10.7の最新版を使え、10.6はでNVRAMの設定コマンドをサポートしていない、と。

http://lists.apple.com/archives/bluetooth-dev/2012/Feb/msg00019.html
MFIを取得すると、アプリケーションに何か特典(メールやSNS受信検出ができるようになるとか)があるのか。という質問。回答は、普通のアプリと同じことしかできない、優先項目はない。

http://lists.apple.com/archives/bluetooth-dev/2012/Feb/msg00020.html
バックグラウンド動作をしているのにTimerが動作しないー＞BLE関連イベントのみ動作する、タイマーは動かないよ。
通知は出せるの ー＞出せるよ、そうやって警告表示してね。

http://lists.apple.com/archives/bluetooth-dev/2012/Feb/msg00022.html
バックグラウンドでタイマーが使えないなら、RSSIの連続取得はどう実装ればいいの ー＞ iOSでは対応できない。ペリフェラル側でかいけつ、通知するとか。


http://lists.apple.com/archives/bluetooth-dev/2012/Feb/msg00031.html
BLEのアクティブスキャンは、フォアグラウンドにあるときだけ、じっこうされるよと。
	128-bitのサービスUUID取得とかは、FGのときだけなのね。
アプリがBGにあるときは、アドバタイズメントのPDUのみ受信すると。アクティブスキャンが動かないから、そりゃそうか。

http://lists.apple.com/archives/bluetooth-dev/2012/Feb/msg00033.html
CoreBluetoothは接続のパラメータ変更は提供していないと。iOSが持っているものだから

http://lists.apple.com/archives/bluetooth-dev/2012/Feb/msg00044.html
サービスの発見では、UUIDのリストが必要。フォアグラウンドはnilでも動くが、バックグラウンドでは指定しないと、取れないと。

http://lists.apple.com/archives/bluetooth-dev/2012/Feb/msg00051.html
ペリフェラルの接続時間の短縮について。コネクションインターバルを短くすることで短縮できると。その後、電力を節約するために、接続間隔を長くすればいいと。

RSSIがnilというやつ。あれはスライドで説明したやつね。

http://lists.apple.com/archives/bluetooth-dev/2012/Mar/msg00012.html
ペリフェラルの接続パラメータが実際に有効になるまでの時間が5秒程度かかる、という指摘。サービスとキャラクタリスティクスを検索するのに、変更前のパラメータでおこなっているために、時間がかかっていると。
電力節約のためにやっているのに、ちょっと遅くないかという話。


アプリがバックグラウンドにあるときは、外部デバイスの消費電力を削減するために、接続パラメータを変更しておこう、という話。

http://lists.apple.com/archives/bluetooth-dev/2012/Mar/msg00019.html
接続パラメータ変更のタイミング、サービスとキャラクタリスティクスのキャッシングは、将来のリリースにと。(2012年2月)

http://lists.apple.com/archives/bluetooth-dev/2012/Mar/msg00024.html
iOSのバグ。キャラクタリスティクスのUUIDが16ビットのみ。5.0ではバグ、5.1で修正。
＜オリジナルなサービスを使っている場合は、結構致命傷だから、5.0は使うなフラグを立てておけばOK？＞

デバイスの識別のために、BTLEのMACアドレスを取りたい質問は、繰り返し出てくる。
UUIDを使え、なんだけど。識別、これは1つテーマ。

http://lists.apple.com/archives/bluetooth-dev/2012/Mar/msg00035.html
複数デバイスの接続どうするの？って質問。CMを2つもつのとか勘違い。CMで接続は並列にと回答。

http://lists.apple.com/archives/bluetooth-dev/2012/Mar/msg00044.html
すでにUUIDを知っているデバイスの取得方法。

- (void)retrievePeripherals:(NSArray *)peripheralUUIDs;
which will trigger call to the delegate:
- (void)centralManager:(CBCentralManager *)central didRetrievePeripherals:(NSArray *)peripherals;
and then connect to it using:
- (void)connectPeripheral:(CBPeripheral *)peripheral options:(NSDictionary *)options;

http://lists.apple.com/archives/bluetooth-dev/2012/Apr/msg00005.html
デバイスが発見されたよが2回来ることがある

http://lists.apple.com/archives/bluetooth-dev/2012/Apr/msg00006.html
CoreBluetoothの開発者フォーラム

https://devforums.apple.com/community/ios/core/cbt
https://devforums.apple.com/community/mac/coreos/cbt

http://lists.apple.com/archives/bluetooth-dev/2012/Apr/msg00016.html
iOS5.0と5.1どっちか分かんないけど、切断時にデバイス名が””になるという質問。
アドバタイズメントパケットのLocalName、接続したらGAPのデバイス名で置換、みたい。ちゃんと設定しろ、と。

http://lists.apple.com/archives/bluetooth-dev/2012/Apr/msg00038.html
デバイスの特定。UUIDがiOSデバイスごとに異なるのに対して、
個人の特定になるから、と。シリアル番号を読めということ。

http://lists.apple.com/archives/bluetooth-dev/2012/May/msg00019.html
5.1使え、なのね。
 There were 'some' issues in 5.0.1 which were fixed in 5.1.


http://lists.apple.com/archives/bluetooth-dev/2012/Jun/msg00005.html
アドバタイズメントから接続までの流れ、アドバタイズメントから時間がたってから接続リクエストを送ると、iOSはずーっと接続をトライする。(それこそ何日でも)
そして、接続が出来れば接続する(なので、ユーザが接続のボタンを押していなくても、接続する)

http://lists.apple.com/archives/bluetooth-dev/2012/Jun/msg00026.html
なんかセントラルとペリフェラルの同時になれるとか。ほんとかよ。

再起動時の接続。保持されない、という回答。

http://lists.apple.com/archives/bluetooth-dev/2012/Jun/msg00037.html
Centralとperipheral、同時になれるのね。

http://lists.apple.com/archives/bluetooth-dev/2012/Jun/msg00047.html
MacでのBLEの接続数上限。ファーム制約で10まで？そうなのかしら

http://lists.apple.com/archives/bluetooth-dev/2012/Jul/msg00029.html
CSRのチップのUSBドングルだと動いたよ、っていう報告。

http://lists.apple.com/archives/bluetooth-dev/2012/Jul/msg00049.html
デバイス通知が2回呼ばれるという報告。多分バグだろう。1回めはサービス情報が入ってない、2回めは入っているという違い。多分その違いで2回呼ばれるiOS側のバグ。

http://lists.apple.com/archives/bluetooth-dev/2012/Aug/msg00061.html
iOSは、Direct接続は、プライバシーの関係でサポートしていないと。

http://lists.apple.com/archives/bluetooth-dev/2012/Aug/msg00135.html
デバイス発見の時間の話。サービスの指定をしていないと、55倍遅くなるとか、バックグラウンドだと遅くなるとか。
これって、実験するしかないよな。

http://lists.apple.com/archives/bluetooth-dev/2012/Sep/msg00023.html
GATTで書き込み失敗するよってネタ。デバイス側のパーミション設定をミスっていたって。属性がキャッシュされてたんだろうな。

http://lists.apple.com/archives/bluetooth-dev/2012/Sep/msg00060.html
scanFor:がブロキングか？という質問。またタイムアウトの質問。
ライブラリの仕組みを知っていれば非同期だとわかるし、タイムアウトもわかるだろうけど、これは引っかかる疑問なんだろう。
解説必要だな。

http://lists.apple.com/archives/bluetooth-dev/2012/Sep/msg00112.html
iOSデバイス間のBLEの通信で、サービスを指定したらアドバタイズメントが取れないという報告。セントラル側のパケットかしらん？
1804って、だめなんじゃ？とかそんな感じで返答されている。

http://lists.apple.com/archives/bluetooth-dev/2012/Sep/msg00098.html
iOS5/6でUUIDのロードのタイミングの違い。iOS6は接続しないと取れないのよね。

辞書がNULLになるとか。バグらしい。

http://lists.apple.com/archives/bluetooth-dev/2012/Oct/msg00008.html
iOSシミュレータでBTLE。Broadcomの石は動かないらしい。

http://lists.apple.com/archives/bluetooth-dev/2012/Oct/msg00018.html
UUIDが逆になるっていう振る舞い。Xcode4.5.1で修正されたと。

http://lists.apple.com/archives/bluetooth-dev/2013/Jan/msg00032.html
バックグラウンドで動かしたら、60分くらいは動くけど、バグでアプリごと落ちる、とある。


